<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f172a">
    <title>NicheSafe - Verifica Nicchie Galleria</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NicheSafe">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #334155;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(34, 197, 94, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
            position: relative;
            z-index: 1;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            animation: slideDown 0.6s ease-out;
        }
        
        .logo {
            font-family: 'Syne', sans-serif;
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }
        
        .tagline {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        /* Status bar */
        .status-bar {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
            animation: fadeIn 0.6s ease-out 0.2s both;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border-radius: 2rem;
            font-size: 0.875rem;
            border: 1px solid var(--border);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .status-online .status-dot {
            background: var(--accent);
        }
        
        .status-offline .status-dot {
            background: var(--warning);
        }
        
        /* Card */
        .card {
            background: var(--bg-card);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            animation: slideUp 0.6s ease-out 0.3s both;
        }
        
        .section-title {
            font-family: 'Syne', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .section-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        /* Checklist items */

 /* Track alignment */
 .check-item.track-dispari { transform: translateX(-10px); }
 .check-item.track-pari { transform: translateX(10px); }
 .check-item.track-dispari:hover { transform: translateX(-6px); }
 .check-item.track-pari:hover { transform: translateX(14px); }
 @media (max-width: 640px) {
  .check-item.track-dispari, .check-item.track-pari { transform: none; }
  .check-item.track-dispari:hover, .check-item.track-pari:hover { transform: translateX(2px); }
 }

 /* VVF section */
 .vvf-badge {
  display:inline-flex;
  align-items:center;
  gap:0.4rem;
  padding:0.2rem 0.55rem;
  border-radius:999px;
  font-size:0.75rem;
  font-weight:700;
  background: rgba(245,158,11,0.12);
  border: 1px solid rgba(245,158,11,0.35);
  color: var(--warning);
 }

        .checklist {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .check-item {
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .check-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .check-item.completed::before {
            transform: scaleY(1);
        }
        
        .check-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }
        
        .check-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .checkbox-wrapper {
            position: relative;
            width: 28px;
            height: 28px;
            flex-shrink: 0;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            width: 100%;
            height: 100%;
            cursor: pointer;
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
        }
        
        .checkbox-custom {
            width: 100%;
            height: 100%;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            position: absolute;
            top: 0;
            left: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .checkbox-wrapper input[type="checkbox"]:checked + .checkbox-custom {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-color: var(--accent);
        }
        
        .checkbox-custom::after {
            content: '‚úì';
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
        }
        
        .checkbox-wrapper input[type="checkbox"]:checked + .checkbox-custom::after {
            opacity: 1;
            transform: scale(1);
        }
        
        .check-content {
            flex: 1;
        }
        
        .check-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .check-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .check-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .meta-icon {
            width: 20px;
            height: 20px;
            opacity: 0.7;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            font-weight: 700;
            padding: 1rem 2rem;
            font-size: 1rem;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Photo preview */
        .photo-preview {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .photo-thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 0.5rem;
            object-fit: cover;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .photo-thumbnail:hover {
            transform: scale(1.1);
            border-color: var(--primary);
        }
        
        /* Progress bar */
        .progress-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .progress-label {
            font-weight: 700;
        }
        
        .progress-percentage {
            color: var(--accent);
            font-weight: 700;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--bg-dark);
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 1rem;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        /* Submit section */
        .submit-section {
            margin-top: 2rem;
            text-align: center;
        }
        
        .email-input {
            width: 100%;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 2px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .email-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            transform: translateY(200%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 350px;
        }
        
        .toast.show {
            transform: translateY(0);
        }
        
        .toast.success {
            border-color: var(--accent);
        }
        
        .toast.error {
            border-color: var(--danger);
        }
        
        /* Animations */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        /* Filter buttons */
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }
        
        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        /* Responsive */
        @media (max-width: 640px) {
            .logo {
                font-size: 2rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .check-item {
                padding: 1rem;
            }
            
            .toast {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
                max-width: none;
            }
            
            .filter-buttons {
                flex-wrap: wrap;
            }
            
            .filter-btn {
                flex: 1;
                min-width: 100px;
            }
        }
        
        /* Hidden input */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Start Screen -->
        <div id="startScreen" class="card" style="display: block;">
            <header class="header">
                <h1 class="logo">üìç NicheSafe</h1>
                <p class="tagline">Verifica Nicchie di Sicurezza Galleria Ferroviaria</p>
            </header>
            
            <h2 class="section-title" style="margin-top: 2rem;">
                <span class="section-icon">üöÄ</span>
                Inizia Verifica
            </h2>
            
            <div style="margin-bottom: 2rem;">
                <label style="display: block; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">
                    Da quale nicchia vuoi iniziare?
                </label>
                <select id="startNiche" class="email-input" style="cursor: pointer;">
                    <option value="">-- Seleziona nicchia di partenza --</option>
                </select>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <label style="display: block; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">
                    In quale direzione stai andando?
                </label>
                <select id="direction" class="email-input" style="cursor: pointer;">
                    <option value="">-- Seleziona direzione --</option>
                    <option value="san_benedetto">‚¨ÜÔ∏è Verso San Benedetto Val di Sambro (55+742)</option>
                    <option value="vernio">‚¨áÔ∏è Verso Vernio (37+200)</option>
                </select>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <label style="display: block; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">
                    Quali binari vuoi visualizzare?
                </label>
                <select id="trackFilter" class="email-input" style="cursor: pointer;">
                    <option value="entrambi">üîÑ Entrambi (Pari e Dispari)</option>
                    <option value="pari">‚û°Ô∏è Solo Binari Pari</option>
                    <option value="dispari">‚¨ÖÔ∏è Solo Binari Dispari</option>
                </select>
            </div>
            
            <div style="text-align: center;">
                <button class="btn btn-primary" id="startBtn" disabled>
                    <span>‚ñ∂Ô∏è</span>
                    <span>Inizia Verifica</span>
                </button>
            </div>
        </div>
        
        <!-- Main Screen -->
        <div id="mainScreen" style="display: none;">
        <header class="header">
            <h1 class="logo">üìç NicheSafe</h1>
            <p class="tagline">Verifica Nicchie di Sicurezza Galleria Ferroviaria</p>
        </header>
        
        <div class="status-bar">
            <div class="status-badge" id="onlineStatus">
                <span class="status-dot"></span>
                <span id="statusText">Controllo connessione...</span>
            </div>
            <div class="status-badge">
                <span>üìã</span>
                <span id="directionInfo">Direzione non impostata</span>
            </div>
        </div>
        
        <div class="card">
            <h2 class="section-title">
                <span class="section-icon">üöá</span>
                Nicchie da Verificare
            </h2>
            
            <div class="filter-buttons">
                <button class="filter-btn active" id="filterEntrambi" data-filter="entrambi">
                    üîÑ Entrambi
                </button>
                <button class="filter-btn" id="filterPari" data-filter="pari">
                    ‚û°Ô∏è Pari
                </button>
                <button class="filter-btn" id="filterDispari" data-filter="dispari">
                    ‚¨ÖÔ∏è Dispari
                </button>
            </div>
            
            <div class="checklist" id="checklist">
                <!-- Items will be added here -->
            </div>

 <div id="paginationControls" style="margin-top: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
  <button class="btn btn-secondary" id="loadMoreBtn" type="button" style="min-width: 220px; justify-content: center;">
    ‚ûï Mostra altre 10
  </button>
  <div id="shownCount" style="color: var(--text-secondary); font-size: 0.9rem;">
    Mostrate 0/0
  </div>
 </div>

            
            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-label">Progresso</span>
                    <span class="progress-percentage" id="progressText">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="submit-section">
  <div style="margin-bottom: 0.75rem; color: var(--text-secondary); font-size: 0.95rem;">
    üì© Destinatario report: <b id="fixedRecipient">a.manduchi@rfi.it</b>
  </div>
  <input type="email" class="email-input hidden" id="emailInput" value="a.manduchi@rfi.it">
  <button class="btn btn-primary" id="submitBtn">
                    <span>üìß</span>
                    <span>Invia Report via Email</span>
                </button>
</div>
        </div>
        </div> <!-- end mainScreen -->
    </div> <!-- end container -->
    
    <div class="toast" id="toast"></div>
    
    <!-- Hidden file input for camera -->
    <input type="file" accept="image/*" capture="environment" class="hidden" id="cameraInput">

    <script>
        // Configuration - Railway Niches Data
        const NICHES_RAW_DATA = `55+742 dispari
55+675 dispari
55+650 pari
55+650 dispari
55+625 dispari
55+600 pari
55+575 dispari
55+550 pari
55+550 dispari
55+525 dispari
55+500 pari
55+492 dispari
55+475 dispari
55+450 pari
55+425 dispari
55+400 pari
55+375 dispari
55+350 pari
55+325 dispari
55+300 pari
55+275 dispari
55+250 pari
55+225 dispari
55+200 pari
55+175 dispari
55+150 pari
55+125 dispari
55+100 pari
55+075 dispari
55+050 pari
55+024 dispari
55+000 pari
54+974 dispari
54+949 pari
54+924 dispari
54+899 pari
54+874 dispari
54+849 pari
54+824 dispari
54+799 pari
54+774 dispari
54+749 pari
54+724 dispari
54+699 pari
54+674 pari
54+674 dispari
54+649 pari
54+624 dispari
54+599 pari
54+574 dispari
54+549 pari
54+524 dispari
54+499 pari
54+474 dispari
54+449 pari
54+424 dispari
54+399 pari
54+374 dispari
54+349 pari
54+324 dispari
54+299 pari
54+274 dispari
54+249 pari
54+224 dispari
54+199 pari
54+174 dispari
54+149 pari
54+124 dispari
54+099 pari
54+074 dispari
54+049 pari
54+024 dispari
53+999 pari
53+973 dispari
53+947 pari
53+923 dispari
53+897 pari
53+873 dispari
53+847 pari
53+823 dispari
53+797 pari
53+773 dispari
53+747 pari
53+723 dispari
53+697 pari
53+673 dispari
53+647 pari
53+623 pari
53+623 dispari
53+597 pari
53+573 dispari
53+547 pari
53+523 dispari
53+497 pari
53+473 dispari
53+447 pari
53+423 dispari
53+397 pari
53+373 dispari
53+347 pari
53+323 dispari
53+297 pari
53+273 dispari
53+247 pari
53+223 dispari
53+197 pari
53+173 dispari
53+147 pari
53+123 dispari
53+097 pari
53+073 dispari
53+047 pari
53+023 dispari
52+997 pari
52+973 dispari
52+947 pari
52+921 dispari
52+896 pari
52+871 dispari
52+846 pari
52+821 dispari
52+796 pari
52+771 dispari
52+746 pari
52+721 dispari
52+696 pari
52+671 dispari
52+646 pari
52+634 dispari
52+621 dispari
52+596 pari
52+571 dispari
52+546 pari
52+521 dispari
52+496 pari
52+471 dispari
52+446 pari
52+421 dispari
52+396 pari
52+371 dispari
52+346 pari
52+321 dispari
52+296 pari
52+271 dispari
52+246 pari
52+221 dispari
52+196 pari
52+171 dispari
52+146 pari
52+121 dispari
52+096 pari
52+071 dispari
52+046 pari
52+021 dispari
51+994 pari
51+969 dispari
51+944 pari
51+919 dispari
51+894 pari
51+869 dispari
51+844 pari
51+819 dispari
51+794 pari
51+769 dispari
51+744 pari
51+719 dispari
51+694 pari
51+669 dispari
51+644 pari
51+619 dispari
51+617 pari
51+594 pari
51+569 dispari
51+544 pari
51+519 dispari
51+494 pari
51+469 dispari
51+444 pari
51+419 dispari
51+394 pari
51+369 dispari
51+344 pari
51+319 dispari
51+274 pari
51+269 dispari
51+244 pari
51+219 dispari
51+194 pari
51+169 dispari
51+144 pari
51+119 dispari
51+094 pari
51+069 dispari
51+044 pari
51+019 dispari
50+994 pari
50+970 dispari
50+945 pari
50+921 dispari
50+871 dispari
50+845 pari
50+821 dispari
50+795 pari
50+771 dispari
50+721 dispari
50+696 pari
50+671 dispari
50+647 pari
50+622 dispari
50+597 pari
50+572 dispari
50+547 pari
50+522 dispari
50+477 pari
50+472 dispari
50+447 pari
50+422 dispari
50+397 pari
50+372 dispari
50+347 pari
50+322 dispari
50+278 pari
50+273 dispari
50+248 pari
50+223 dispari
50+198 pari
50+173 dispari
50+148 pari
50+123 dispari
50+098 pari
50+073 dispari
50+048 pari
50+023 dispari
49+998 pari
49+973 dispari
49+949 pari
49+924 dispari
49+899 pari
49+874 dispari
49+849 pari
49+824 dispari
49+799 pari
49+774 dispari
49+749 pari
49+724 dispari
49+699 pari
49+674 dispari
49+649 pari
49+624 dispari
49+574 dispari
49+549 pari
49+524 dispari
49+499 pari
49+474 dispari
49+449 pari
49+424 dispari
49+399 pari
49+374 dispari
49+349 pari
49+324 dispari
49+299 pari
49+274 dispari
49+249 pari
49+224 dispari
49+199 pari
49+174 dispari
49+149 pari
49+124 dispari
49+099 pari
49+074 dispari
49+054 pari
49+024 dispari
48+999 pari
48+974 dispari
48+949 pari
48+924 dispari
48+899 pari
48+874 dispari
48+849 pari
48+824 dispari
48+799 pari
48+774 dispari
48+749 pari
48+724 dispari
48+699 pari
48+674 dispari
48+649 pari
48+624 dispari
48+599 pari
48+574 dispari
48+549 pari
48+524 dispari
48+499 pari
48+474 dispari
48+449 pari
48+424 pari
48+424 dispari
48+399 pari
48+374 dispari
48+349 pari
48+324 dispari
48+299 pari
48+274 dispari
48+249 pari
48+224 dispari
48+199 pari
48+174 dispari
48+149 pari
48+124 dispari
48+099 pari
48+074 dispari
48+049 pari
48+024 dispari
47+999 pari
47+974 dispari
47+949 pari
47+924 dispari
47+899 pari
47+874 dispari
47+849 pari
47+824 dispari
47+799 pari
47+774 dispari
47+724 pari
47+724 dispari
47+699 pari
47+674 dispari
47+649 pari
47+624 dispari
47+599 pari
47+574 dispari
47+549 pari
47+524 pari
47+524 dispari
47+499 pari
47+474 dispari
47+348 dispari
47+323 pari
47+298 dispari
47+273 pari
47+248 dispari
47+223 pari
47+198 dispari
47+173 pari
47+153 dispari
47+123 pari
47+100 dispari
47+075 pari
47+050 dispari
47+025 pari
47+001 dispari
46+975 pari
46+951 dispari
46+921 pari
46+848 dispari
46+855 pari
46+800 pari
46+781 dispari
46+747 pari
46+731 dispari
46+697 pari
46+681 dispari
46+647 pari
46+631 dispari
46+597 pari
46+581 dispari
46+547 pari
46+531 dispari
46+497 pari
46+481 dispari
46+447 pari
46+431 dispari
46+397 pari
46+381 dispari
46+366 pari
46+232 pari
46+208 pari
46+184 dispari
46+158 pari
46+134 dispari
46+108 pari
46+064 dispari
46+058 pari
46+034 dispari
46+008 pari
45+985 dispari
45+958 pari
45+935 dispari
45+908 pari
45+886 dispari
45+858 pari
45+836 dispari
45+808 pari
45+786 dispari
45+758 pari
45+733 dispari
45+708 pari
45+683 dispari
45+658 pari
45+633 dispari
45+608 pari
45+583 dispari
45+558 pari
45+533 dispari
45+508 pari
45+483 dispari
45+483 pari
45+458 pari
45+433 dispari
45+408 pari
45+383 dispari
45+358 pari
45+333 dispari
45+308 pari
45+283 dispari
45+258 pari
45+233 dispari
45+208 pari
45+183 dispari
45+158 pari
45+133 dispari
45+108 pari
45+083 dispari
45+058 pari
45+033 dispari
45+008 pari
44+983 dispari
44+958 pari
44+933 dispari
44+908 pari
44+883 dispari
44+858 pari
44+833 dispari
44+808 pari
44+783 dispari
44+758 pari
44+733 dispari
44+708 pari
44+683 dispari
44+658 pari
44+633 dispari
44+608 pari
44+583 dispari
44+558 pari
44+533 dispari
44+508 pari
44+486 dispari
44+458 pari
44+436 dispari
44+408 pari
44+388 dispari
44+363 pari
44+338 dispari
44+319 pari
44+294 pari
44+288 dispari
44+269 pari
44+238 dispari
44+219 pari
44+188 dispari
44+169 pari
44+138 dispari
44+119 pari
44+088 dispari
44+069 pari
44+038 dispari
44+019 pari
43+988 dispari
43+969 pari
43+938 dispari
43+919 pari
43+888 dispari
43+869 pari
43+838 dispari
43+813 pari
43+788 dispari
43+763 pari
43+738 dispari
43+713 pari
43+688 dispari
43+663 pari
43+638 dispari
43+613 pari
43+588 dispari
43+563 pari
43+538 dispari
43+513 pari
43+488 dispari
43+463 pari
43+438 dispari
43+413 pari
43+388 dispari
43+363 pari
43+333 dispari
43+313 pari
43+288 dispari
43+263 pari
43+238 dispari
43+213 pari
43+188 dispari
43+163 pari
43+138 dispari
43+113 pari
43+088 dispari
43+088 pari
43+038 dispari
43+013 pari
42+988 dispari
42+963 pari
42+938 dispari
42+913 pari
42+888 dispari
42+863 pari
42+838 dispari
42+813 pari
42+788 dispari
42+763 pari
42+738 dispari
42+713 pari
42+686 dispari
42+663 pari
42+638 dispari
42+613 pari
42+588 dispari
42+563 pari
42+538 dispari
42+513 pari
42+488 dispari
42+463 pari
42+438 dispari
42+413 pari
42+388 dispari
42+363 pari
42+338 dispari
42+313 pari
42+288 dispari
42+263 pari
42+238 dispari
42+231 pari
42+188 dispari
42+163 pari
42+138 dispari
42+113 pari
42+088 dispari
42+063 pari
42+038 dispari
42+013 pari
41+987 dispari
41+963 pari
41+937 dispari
41+913 pari
41+890 pari
41+886 dispari
41+863 pari
41+836 dispari
41+813 pari
41+786 dispari
41+757 pari
41+738 dispari
41+713 pari
41+688 dispari
41+663 pari
41+638 dispari
41+613 pari
41+585 dispari
41+563 pari
41+535 dispari
41+513 pari
41+484 dispari
41+463 pari
41+434 dispari
41+413 pari
41+381 dispari
41+363 pari
41+333 dispari
41+313 pari
41+283 dispari
41+259 pari
41+232 dispari
41+213 pari
41+182 dispari
41+163 pari
41+113 pari
41+082 dispari
41+063 pari
41+032 dispari
41+013 pari
40+988 dispari
40+983 pari
40+963 pari
40+932 dispari
40+913 pari
40+882 dispari
40+863 pari
40+832 dispari
40+813 pari
40+782 dispari
40+763 pari
40+732 dispari
40+713 pari
40+668 dispari
40+663 pari
40+638 dispari
40+613 pari
40+588 dispari
40+563 pari
40+538 dispari
40+513 pari
40+488 dispari
40+463 pari
40+438 dispari
40+413 pari
40+388 dispari
40+363 pari
40+338 dispari
40+313 pari
40+288 dispari
40+263 pari
40+238 dispari
40+213 pari
40+188 dispari
40+163 pari
40+138 dispari
40+113 pari
40+088 dispari
40+063 pari
40+038 dispari
40+013 pari
39+988 dispari
39+963 pari
39+938 dispari
39+913 pari
39+888 pari
39+888 dispari
39+863 pari
39+838 dispari
39+813 pari
39+788 dispari
39+763 pari
39+738 dispari
39+713 pari
39+688 dispari
39+663 pari
39+638 dispari
39+613 pari
39+588 dispari
39+563 pari
39+538 dispari
39+513 pari
39+488 dispari
39+463 pari
39+438 dispari
39+413 pari
39+388 dispari
39+363 pari
39+338 dispari
39+313 pari
39+288 dispari
39+263 pari
39+238 dispari
39+213 pari
39+188 dispari
39+163 pari
39+113 pari
39+088 dispari
39+063 pari
39+038 dispari
39+013 pari
38+988 dispari
38+963 pari
38+938 dispari
38+903 pari
38+888 dispari
38+863 pari
38+838 dispari
38+813 pari
38+788 pari
38+788 dispari
38+763 pari
38+738 dispari
38+713 pari
38+688 dispari
38+663 pari
38+638 dispari
38+613 pari
38+588 dispari
38+563 pari
38+538 dispari
38+513 pari
38+488 dispari
38+463 pari
38+438 dispari
38+413 pari
38+388 dispari
38+363 pari
38+338 dispari
38+313 pari
38+288 dispari
38+263 pari
38+238 dispari
38+213 pari
38+188 dispari
38+163 pari
38+138 dispari
38+113 pari
38+088 dispari
38+063 pari
38+038 dispari
38+013 pari
37+988 dispari
37+963 pari
37+938 dispari
37+913 pari
37+888 dispari
37+863 pari
37+838 dispari
37+813 pari
37+788 dispari
37+763 pari
37+738 dispari
37+713 pari
37+688 dispari
37+663 pari
37+638 dispari
37+613 pari
37+588 dispari
37+563 pari
37+538 dispari
37+512 pari
37+486 dispari
37+463 pari
37+435 dispari
37+413 pari
37+383 dispari
37+363 pari
37+333 dispari
37+313 pari
37+293 pari
37+284 dispari
37+259 pari`;

        // Parse niches data
 // Elenco nicchie con verifica aggiuntiva VV.F. (manichette + segnaletica)
 const VVF_SPECIAL_SET = new Set([
  '55+575 dispari',
  '55+425 dispari',
  '55+275 dispari',
  '55+175 dispari',
  '55+024 dispari',
  '54+874 dispari',
  '54+774 dispari',
  '54+674 dispari',
  '54+574 dispari',
  '54+424 dispari',
  '54+324 dispari',
  '54+174 dispari',
  '54+024 dispari',
  '53+773 dispari',
  '53+623 dispari',
  '53+473 dispari',
  '53+373 dispari',
  '53+223 dispari',
  '53+073 dispari',
  '47+724 pari',
  '47+649 pari',
  '47+524 pari',
  '47+273 pari',
  '47+173 pari',
  '47+025 pari',
  '46+697 pari',
  '46+597 pari',
  '46+447 pari',
  '46+208 pari',
  '46+058 pari',
  '45+908 pari',
  '45+758 pari',
  '45+658 pari',
  '45+508 pari',
  '45+408 pari',
  '45+308 pari',
  '45+158 pari',
  '45+058 pari'
]);

        const CHECKLIST_ITEMS = NICHES_RAW_DATA.split('\n')
            .map((line, index) => {
                const parts = line.trim().split(' ');
                if (parts.length === 2) {
                    return {
                        id: index + 1,
                        km: parts[0],
                        binario: parts[1],
                        title: `Nicchia km ${parts[0]} - Binario ${parts[1]}`,
                        description: `Verifica Segnaletica e Illuminazione`,
      isVvfSpecial: VVF_SPECIAL_SET.has(`${parts[0]} ${parts[1]}`)
                    };
                }
                return null;
            })
            .filter(item => item !== null);

        // Constants
        const TRACK_FILTER = {
            BOTH: 'entrambi',
            PARI: 'pari',
            DISPARI: 'dispari'
        };
        
        // Helper function to parse km values
        function parseKmValue(km) {
            return parseFloat(km.replace('+', '.'));
        }

        // State
        let checklistData = [];
        let isOnline = navigator.onLine;
        let selectedDirection = null;
        let startNicheId = null;
        let filteredNiches = [];
        let trackFilter = TRACK_FILTER.BOTH; // Track filter: 'pari', 'dispari', 'entrambi'
 let pageSize = 10;
 let currentPageStart = 0;
 let orderedItemIds = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            populateStartNicheSelect();
            setupStartScreen();
            updateOnlineStatus();
            
            // Event listeners
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            document.getElementById('submitBtn').addEventListener('click', submitReport);
            document.getElementById('cameraInput').addEventListener('change', handlePhotoCapture);
 document.getElementById('loadMoreBtn')?.addEventListener('click', showNextPage);
        });
        
        // Populate start niche dropdown
        function populateStartNicheSelect() {
            const select = document.getElementById('startNiche');
            
            // Sort items by km in ascending order
            const sortedItems = [...CHECKLIST_ITEMS].sort((a, b) => {
                return parseKmValue(a.km) - parseKmValue(b.km);
            });
            
            sortedItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.km} - Binario ${item.binario}`;
                select.appendChild(option);
            });
        }
        
        // Setup start screen
        function setupStartScreen() {
            const startNicheSelect = document.getElementById('startNiche');
            const directionSelect = document.getElementById('direction');
            const trackFilterSelect = document.getElementById('trackFilter');
            const startBtn = document.getElementById('startBtn');
            
            const checkStartButton = () => {
                startBtn.disabled = !(startNicheSelect.value && directionSelect.value);
            };
            
            startNicheSelect.addEventListener('change', checkStartButton);
            directionSelect.addEventListener('change', checkStartButton);
            
            startBtn.addEventListener('click', () => {
                startNicheId = parseInt(startNicheSelect.value);
                selectedDirection = directionSelect.value;
                trackFilter = trackFilterSelect.value;
                
                // Filter niches based on direction and track
                filterNichesByDirection();
                
                // Initialize filtered checklist
                initializeChecklist();
                loadFromLocalStorage();
                updateProgress();
                
                // Update direction info
                const dirText = selectedDirection === 'san_benedetto' 
                    ? '‚¨ÜÔ∏è Verso San Benedetto' 
                    : '‚¨áÔ∏è Verso Vernio';
                document.getElementById('directionInfo').textContent = dirText;
                
                // Show main screen
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('mainScreen').style.display = 'block';
                
                // Setup filter buttons
                setupFilterButtons();
                
                showToast('Verifica iniziata!', 'success');
            });
        }
        
        // Setup filter buttons in main screen
        function setupFilterButtons() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const newFilter = btn.dataset.filter;
                    
                    // Update active state
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Apply new filter
                    trackFilter = newFilter;
                    applyTrackFilter();
                });
            });
        }
        
        // Apply track filter to already loaded items
        function applyTrackFilter() {
            orderedItemIds.forEach(id => {
                const el = document.getElementById(`item-${id}`);
                if (!el) return;
                
                const item = filteredNiches.find(n => n.id === id);
                if (!item) return;
                
                if (trackFilter === TRACK_FILTER.PARI) {
                    el.style.display = item.binario === TRACK_FILTER.PARI ? 'block' : 'none';
                } else if (trackFilter === TRACK_FILTER.DISPARI) {
                    el.style.display = item.binario === TRACK_FILTER.DISPARI ? 'block' : 'none';
                } else {
                    el.style.display = 'block';
                }
            });
            
            updatePaginationUI();
        }
        
        // Filter niches by direction and track
        function filterNichesByDirection() {
            const startNiche = CHECKLIST_ITEMS.find(n => n.id === startNicheId);
            const startKmValue = parseKmValue(startNiche.km);
            
            let baseFiltered;
            if (selectedDirection === 'san_benedetto') {
                // Going up towards 55+742
                baseFiltered = CHECKLIST_ITEMS.filter(n => {
                    return parseKmValue(n.km) >= startKmValue;
                }).sort((a, b) => {
                    return parseKmValue(a.km) - parseKmValue(b.km); // Ascending
                });
            } else {
                // Going down towards 37+200
                baseFiltered = CHECKLIST_ITEMS.filter(n => {
                    return parseKmValue(n.km) <= startKmValue;
                }).sort((a, b) => {
                    return parseKmValue(b.km) - parseKmValue(a.km); // Descending
                });
            }
            
            // Apply track filter using constants
            if (trackFilter === TRACK_FILTER.PARI) {
                filteredNiches = baseFiltered.filter(n => n.binario === TRACK_FILTER.PARI);
            } else if (trackFilter === TRACK_FILTER.DISPARI) {
                filteredNiches = baseFiltered.filter(n => n.binario === TRACK_FILTER.DISPARI);
            } else {
                filteredNiches = baseFiltered;
            }
        }

        // Initialize checklist
        function initializeChecklist() {
            const container = document.getElementById('checklist');
            container.innerHTML = ''; // Clear existing
            checklistData = []; // Reset
            
            filteredNiches.forEach(item => {
                const itemData = {
                    id: item.id,
                    km: item.km,
                    binario: item.binario,
                    title: item.title,
                    description: item.description,
                    completed: false,
                    checks: {
                        segnaletica: null,
                        illuminazione: null
                    },
                    timestamp: null,
                    photos: [], // Backward compatibility
                    photosByType: {
                        segnaletica: [],
                        illuminazione: [],
                        general: []
                    },
                    needsPhoto: {
                        segnaletica: false,
                        illuminazione: false
                    },
                    notes: ''
                };
                
                checklistData.push(itemData);
                
                const itemEl = createChecklistItem(item, itemData);
                container.appendChild(itemEl);
            });
        
            // Pagination order and first page
            orderedItemIds = filteredNiches.map(n => n.id);
            showPage(0);
}

        // Create checklist item element
        function createChecklistItem(item, data) {
            const div = document.createElement('div');
            div.className = `check-item track-${item.binario}`;
            div.id = `item-${item.id}`;
            
            div.innerHTML = `
                <div class="check-header">
                    <div class="check-content">
                        <div class="check-title">${item.title}</div>
                        
                        <!-- Segnaletica Section -->
                        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-dark); border-radius: 0.75rem; border: 1px solid var(--border);">
                            <div style="font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span>üö®</span>
                                <span>Segnaletica Uscite di Emergenza</span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Verifica presenza e visibilit√† della segnaletica di emergenza che indica le uscite di sicurezza
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
                                    <input type="radio" name="segnaletica-${item.id}" value="funzionante" class="safety-radio" data-id="${item.id}" data-type="segnaletica"
                                           style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">‚úÖ Funzionante</span>
                                </label>
                                
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
                                    <input type="radio" name="segnaletica-${item.id}" value="manutenzione" class="safety-radio" data-id="${item.id}" data-type="segnaletica"
                                           style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">‚ö†Ô∏è Necessita Manutenzione</span>
                                </label>
                            </div>
                            
                            <div id="photo-btn-seg-${item.id}" style="margin-top: 1rem; display: none;">
                                <button class="btn btn-secondary" onclick="capturePhoto(${item.id}, 'segnaletica')" style="width: 100%; justify-content: center;">
                                    üì∑ Scatta Foto Segnaletica
                                </button>
                            </div>
                        </div>
                        
                        <!-- Illuminazione Section -->
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-dark); border-radius: 0.75rem; border: 1px solid var(--border);">
                            <div style="font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span>üí°</span>
                                <span>Illuminazione di Emergenza</span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Verifica illuminazione sopra il corrimano (distanza 12,5m tra corpi illuminanti)
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
                                    <input type="radio" name="illuminazione-${item.id}" value="funzionante" class="safety-radio" data-id="${item.id}" data-type="illuminazione"
                                           style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">‚úÖ Funzionante</span>
                                </label>
                                
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
                                    <input type="radio" name="illuminazione-${item.id}" value="manutenzione" class="safety-radio" data-id="${item.id}" data-type="illuminazione"
                                           style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">‚ö†Ô∏è Necessita Manutenzione</span>
                                </label>
                            </div>
                            
                            <div id="photo-btn-ill-${item.id}" style="margin-top: 1rem; display: none;">
                                <button class="btn btn-secondary" onclick="capturePhoto(${item.id}, 'illuminazione')" style="width: 100%; justify-content: center;">
                                    üì∑ Scatta Foto Illuminazione
                                </button>
                            </div>
                        </div>
                        
                        ${item.isVvfSpecial ? `
 <!-- VVF Section (solo nicchie selezionate) -->
 <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-dark); border-radius: 0.75rem; border: 1px solid var(--border);">
  <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.75rem;">
   <div style="font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
    <span>üî•</span>
    <span>Antincendio VV.F. (Manichette + Segnaletica)</span>
   </div>
   <span class="vvf-badge">Check extra</span>
  </div>
  <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
   Verifica la presenza delle <b>manichette per i Vigili del Fuoco</b> e della <b>segnaletica di riferimento</b> (presente, visibile e conforme).
  </div>
  <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
   <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
    <input type="radio" name="vvf-${item.id}" value="presente" class="safety-radio" data-id="${item.id}" data-type="vvf" style="width: 20px; height: 20px; cursor: pointer;">
    <span style="font-weight: 500;">‚úÖ Presente e segnaletica OK</span>
   </label>
   <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
    <input type="radio" name="vvf-${item.id}" value="non_conforme" class="safety-radio" data-id="${item.id}" data-type="vvf" style="width: 20px; height: 20px; cursor: pointer;">
    <span style="font-weight: 500;">‚ö†Ô∏è Assente / non conforme</span>
   </label>
  </div>
  <div id="photo-btn-vvf-${item.id}" style="margin-top: 1rem; display: none;">
   <button class="btn btn-secondary" onclick="capturePhoto(${item.id}, 'vvf')" style="width: 100%; justify-content: center;">üì∑ Scatta Foto VV.F.</button>
  </div>
 </div>
` : ``}

<div class="photo-preview" id="photos-${item.id}" style="margin-top: 1rem;"></div>
                        
                        <div class="check-meta" id="meta-${item.id}"></div>
                    </div>
                </div>
            `;
            
            // Add radio listeners
            const radios = div.querySelectorAll('.safety-radio');
            radios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    handleSafetyCheck(item.id, e.target.dataset.type, e.target.value);
                    
                    // Visual feedback for selected label
                    const label = e.target.closest('.radio-label');
                    const allLabels = label.parentElement.querySelectorAll('.radio-label');
                    allLabels.forEach(l => l.style.borderColor = 'transparent');
                    if (e.target.checked) {
                        label.style.borderColor = 'var(--primary)';
                    }
                });
            });
            
            return div;
        }

        // Handle safety radio change
        function handleSafetyCheck(id, type, value) {
            const itemData = checklistData.find(item => item.id === id);
            
            if (!itemData.checks) {
                itemData.checks = {
                    segnaletica: null,
                    illuminazione: null
                };
            }
            
            itemData.checks[type] = value;
            
            // Show/hide photo button based on selection
            const photoBtnId = type === 'segnaletica' ? `photo-btn-seg-${id}` : (type === 'illuminazione' ? `photo-btn-ill-${id}` : `photo-btn-vvf-${id}`);
 const photoBtn = document.getElementById(photoBtnId);
            if (photoBtn) {
                if (value === 'manutenzione' || value === 'non_conforme') {
                    photoBtn.style.display = 'block';
                } else {
                    photoBtn.style.display = 'none';
                }
            }
            
            // Update completed status - both must be answered
            const requiresVVF = filteredNiches.find(n => n.id === id)?.isVvfSpecial;
 itemData.completed = itemData.checks.segnaletica !== null && itemData.checks.illuminazione !== null && (!requiresVVF || itemData.checks.vvf !== null);
            
            if (itemData.completed && !itemData.timestamp) {
                itemData.timestamp = new Date().toISOString();
            } else if (!itemData.completed) {
                itemData.timestamp = null;
            }
            
            // Check if maintenance selected but no photo yet
            if (value === 'manutenzione' || value === 'non_conforme') {
                const photos = itemData.photosByType?.[type] || [];
                if (photos.length === 0) {
                    itemData.needsPhoto = itemData.needsPhoto || {};
                    itemData.needsPhoto[type] = true;
                }
            } else {
                if (itemData.needsPhoto) {
                    itemData.needsPhoto[type] = false;
                }
            }
            
            const itemEl = document.getElementById(`item-${id}`);
            if (itemData.completed) {
                itemEl.classList.add('completed');
            } else {
                itemEl.classList.remove('completed');
            }
            
            updateProgress();
            updateMeta(id);
            saveToLocalStorage();
        }

        // Capture photo
        function capturePhoto(id, photoType) {
            const input = document.getElementById('cameraInput');
            input.dataset.itemId = id;
            input.dataset.photoType = photoType || 'general';
            input.click();
        }

        // Handle photo capture
        function handlePhotoCapture(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const itemId = parseInt(e.target.dataset.itemId);
            const photoType = e.target.dataset.photoType || 'general';
            const reader = new FileReader();
            
            reader.onload = (event) => {
                const itemData = checklistData.find(item => item.id === itemId);
                
                if (!itemData.photosByType) {
                    itemData.photosByType = {
                        segnaletica: [],
                        illuminazione: [],
                        general: []
                    };
                }
                
                // Keep backward compatibility
                if (!itemData.photos) itemData.photos = [];
                
                const photoData = {
                    data: event.target.result,
                    type: photoType,
                    timestamp: new Date().toISOString()
                };
                
                itemData.photosByType[photoType].push(photoData);
                itemData.photos.push(event.target.result); // Backward compatibility
                
                displayPhotos(itemId);
                saveToLocalStorage();
                showToast(`Foto ${photoType} acquisita!`, 'success');
            };
            
            reader.readAsDataURL(file);
            e.target.value = ''; // Reset input
        }

        // Display photos
        function displayPhotos(id) {
            const itemData = checklistData.find(item => item.id === id);
            const container = document.getElementById(`photos-${id}`);
            
            if (!itemData.photosByType) {
                // Fallback for old format
                container.innerHTML = itemData.photos.map((photo, index) => 
                    `<img src="${photo}" class="photo-thumbnail" alt="Foto ${index + 1}" onclick="viewPhoto('${photo}')">`
                ).join('');
                return;
            }
            
            let html = '';
            
            // Segnaletica photos
            if (itemData.photosByType.segnaletica?.length > 0) {
                html += '<div style="margin-bottom: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">üö´ Segnaletica Mancante:</div>';
                itemData.photosByType.segnaletica.forEach((photo, index) => {
                    html += `<img src="${photo.data}" class="photo-thumbnail" alt="Segnaletica ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
                });
            }
            
            // Illuminazione photos
            if (itemData.photosByType.illuminazione?.length > 0) {
                html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">üí° Illuminazione Mancante:</div>';
                itemData.photosByType.illuminazione.forEach((photo, index) => {
                    html += `<img src="${photo.data}" class="photo-thumbnail" alt="Illuminazione ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
                });
            }
            
            // VVF photos
 if (itemData.photosByType.vvf?.length > 0) {
  html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">üî• VV.F. / Manichette:</div>';
  itemData.photosByType.vvf.forEach((photo, index) => {
    html += `<img src="${photo.data}" class="photo-thumbnail" alt="VVF ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
  });
 }

 // General photos
            if (itemData.photosByType.general?.length > 0) {
                html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">üì∑ Altre Foto:</div>';
                itemData.photosByType.general.forEach((photo, index) => {
                    html += `<img src="${photo.data}" class="photo-thumbnail" alt="Generale ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
                });
            }
            
            container.innerHTML = html;
        }

        // View photo in new tab
        function viewPhoto(photo) {
            const win = window.open();
            win.document.write(`<img src="${photo}" style="max-width: 100%; height: auto;">`);
        }

        // Update meta information
        function updateMeta(id) {
            const itemData = checklistData.find(item => item.id === id);
            const container = document.getElementById(`meta-${id}`);
            
            let metaHtml = '';
            
            if (itemData.timestamp) {
                const date = new Date(itemData.timestamp);
                metaHtml += `
                    <div class="meta-item">
                        <span class="meta-icon">üïê</span>
                        <span>${date.toLocaleString('it-IT')}</span>
                    </div>
                `;
            }
            
            if (itemData.checks) {
                if (itemData.checks.segnaletica) {
                    const icon = itemData.checks.segnaletica === 'funzionante' ? '‚úÖ' : '‚ö†Ô∏è';
                    metaHtml += `
                        <div class="meta-item">
                            <span class="meta-icon">${icon}</span>
                            <span>Segnaletica: ${itemData.checks.segnaletica === 'funzionante' ? 'OK' : 'Manutenzione'}</span>
                        </div>
                    `;
                }
                
                if (itemData.checks.vvf && (filteredNiches.find(n => n.id === id)?.isVvfSpecial)) {
  const icon = itemData.checks.vvf === 'presente' ? '‚úÖ' : '‚ö†Ô∏è';
  metaHtml += `
  <div class="meta-item">
    <span class="meta-icon">${icon}</span>
    <span>VV.F.: ${itemData.checks.vvf === 'presente' ? 'OK' : 'Non conforme'}</span>
  </div>
  `;
 }
 if (itemData.checks.illuminazione) {
                    const icon = itemData.checks.illuminazione === 'funzionante' ? '‚úÖ' : '‚ö†Ô∏è';
                    metaHtml += `
                        <div class="meta-item">
                            <span class="meta-icon">${icon}</span>
                            <span>Illuminazione: ${itemData.checks.illuminazione === 'funzionante' ? 'OK' : 'Manutenzione'}</span>
                        </div>
                    `;
                }
            }
            
            const photos = itemData.photosByType || {};
            const totalPhotos = (photos.segnaletica?.length || 0) + (photos.illuminazione?.length || 0) + (photos.vvf?.length || 0);
            if (totalPhotos > 0) {
                metaHtml += `
                    <div class="meta-item">
                        <span class="meta-icon">üì∑</span>
                        <span>${totalPhotos} foto</span>
                    </div>
                `;
            }
            
            container.innerHTML = metaHtml;
        }

        
// Pagination helpers: mostra solo 10 nicchie per volta
function showPage(startIndex) {
  currentPageStart = startIndex;
  orderedItemIds.forEach((id, idx) => {
    const el = document.getElementById(`item-${id}`);
    if (!el) return;
    el.style.display = (idx >= currentPageStart && idx < currentPageStart + pageSize) ? 'block' : 'none';
  });
  updatePaginationUI();
}

function showNextPage() {
  const total = orderedItemIds.length;
  if (currentPageStart + pageSize >= total) {
    showToast("Nessun'altra nicchia da mostrare", 'success');
    return;
  }
  showPage(currentPageStart + pageSize);
  document.getElementById('checklist')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function updatePaginationUI() {
  const total = orderedItemIds.length;
  const start = currentPageStart;
  const end = Math.min(currentPageStart + pageSize, total);
  const shown = document.getElementById('shownCount');
  const btn = document.getElementById('loadMoreBtn');
  if (shown) shown.textContent = total ? `Mostrate ${start + 1}-${end} di ${total}` : 'Mostrate 0/0';
  if (btn) {
    if (end >= total) {
      btn.style.display = 'none';
    } else {
      btn.style.display = 'inline-flex';
      const nextEnd = Math.min(end + pageSize, total);
      btn.textContent = `‚ûï Mostra altre 10 (${end + 1}-${nextEnd})`;
    }
  }
}

// Update progress
        function updateProgress() {
            const completed = checklistData.filter(item => item.completed).length;
            const total = checklistData.length;
            const percentage = Math.round((completed / total) * 100);
            
            document.getElementById('progressText').textContent = `${percentage}%`;
            document.getElementById('progressFill').style.width = `${percentage}%`;
            
            // Enable submit button if all completed
            const submitBtn = document.getElementById('submitBtn');
            const emailInput = document.getElementById('emailInput');
            submitBtn.disabled = !(emailInput.value && emailInput.value.includes('@'));
        }

        // Email validation
        document.getElementById('emailInput').addEventListener('input', updateProgress);

        // Update online status
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const statusEl = document.getElementById('onlineStatus');
            const statusText = document.getElementById('statusText');
            
            if (isOnline) {
                statusEl.className = 'status-badge status-online';
                statusText.textContent = 'Online';
            } else {
                statusEl.className = 'status-badge status-offline';
                statusText.textContent = 'Offline';
            }
        }

        // Submit report
        async function submitReport() {
            if (!isOnline) {
                showToast('Impossibile inviare: sei offline. Il report verr√† salvato.', 'error');
                return;
            }
            
            const email = 'a.manduchi@rfi.it';
            if (!email || !email.includes('@')) {
                showToast('Inserisci un indirizzo email valido', 'error');
                return;
            }
            
            const report = generateReport();
            
            // In a real implementation, you would send this to a backend API
            // For this demo, we'll use mailto: as a fallback
            const subject = encodeURIComponent(`Report Checklist - ${new Date().toLocaleDateString('it-IT')}`);
            const body = encodeURIComponent(report);
            
            // Show success message
            showToast('Report generato! Apertura client email...', 'success');
            
            // Open mailto
            setTimeout(() => {
                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
            }, 1000);
            
            // Clear data after successful submission
            setTimeout(() => {
                if (confirm('Report inviato! Vuoi cancellare i dati locali?')) {
                    localStorage.removeItem('checklistData');
                    location.reload();
                }
            }, 2000);
        }

        // Generate report
        function generateReport() {
            let report = 'REPORT VERIFICA NICCHIE DI SICUREZZA GALLERIA\n';
            report += `Data Ispezione: ${new Date().toLocaleString('it-IT')}\n`;
            
            const directionText = selectedDirection === 'san_benedetto' 
                ? 'San Benedetto Val di Sambro (55+742)' 
                : 'Vernio (37+200)';
            report += `Direzione: Verso ${directionText}\n`;
            
            const totalNiches = checklistData.length;
            const completedNiches = checklistData.filter(i => i.completed).length;
            const needsMaintenance = checklistData.filter(i => {
                return i.checks?.segnaletica === 'manutenzione' || i.checks?.illuminazione === 'manutenzione' || i.checks?.vvf === 'non_conforme';
            }).length;
            
            report += `Nicchie Verificate: ${completedNiches}/${totalNiches}\n`;
            report += `Nicchie Necessitano Manutenzione: ${needsMaintenance}\n`;
            report += `Percentuale Completamento: ${Math.round((completedNiches/totalNiches)*100)}%\n\n`;
            
            report += '='.repeat(60) + '\n\n';
            
            // Summary of maintenance needed
            const nichesNeedingMaintenance = checklistData.filter(i => {
                return i.checks?.segnaletica === 'manutenzione' || i.checks?.illuminazione === 'manutenzione' || i.checks?.vvf === 'non_conforme';
            });
            
            if (nichesNeedingMaintenance.length > 0) {
                report += 'RIEPILOGO NICCHIE CHE NECESSITANO MANUTENZIONE\n\n';
                
                nichesNeedingMaintenance.forEach((item) => {
                    const niche = filteredNiches.find(n => n.id === item.id);
                    report += `üìç ${niche.km} - Binario ${niche.binario}\n`;
                    
                    if (item.checks.segnaletica === 'manutenzione') {
                        const photoCount = item.photosByType?.segnaletica?.length || 0;
                        report += `   ‚ö†Ô∏è SEGNALETICA USCITE EMERGENZA - Necessita Manutenzione`;
                        if (photoCount > 0) report += ` (${photoCount} foto)`;
                        report += '\n';
                    }
                    
                    if (item.checks.vvf === 'non_conforme') {
 const photoCount = item.photosByType?.vvf?.length || 0;
 report += ` ‚ö†Ô∏è ANTINCENDIO VV.F. (MANICHETTE + SEGNALETICA) - Assente / non conforme`;
 if (photoCount > 0) report += ` (${photoCount} foto)`;
 report += '\n';
 }
 if (item.checks.illuminazione === 'manutenzione') {
                        const photoCount = item.photosByType?.illuminazione?.length || 0;
                        report += `   ‚ö†Ô∏è ILLUMINAZIONE EMERGENZA - Necessita Manutenzione`;
                        if (photoCount > 0) report += ` (${photoCount} foto)`;
                        report += '\n';
                    }
                    
                    if (item.timestamp) {
                        report += `   Verificato: ${new Date(item.timestamp).toLocaleString('it-IT')}\n`;
                    }
                    report += '\n';
                });
                
                report += '='.repeat(60) + '\n\n';
            }
            
            // Detailed list
            report += 'DETTAGLIO COMPLETO NICCHIE\n\n';
            
            checklistData.forEach((item, index) => {
                const niche = filteredNiches.find(n => n.id === item.id);
                report += `${index + 1}. Km ${niche.km} - Binario ${niche.binario}\n`;
                report += `   Stato: ${item.completed ? '‚úÖ VERIFICATA' : '‚è≥ DA VERIFICARE'}\n`;
                
                if (item.checks) {
                    if (item.checks.segnaletica) {
                        const status = item.checks.segnaletica === 'funzionante' ? '‚úÖ Funzionante' : '‚ö†Ô∏è Necessita Manutenzione';
                        report += `   Segnaletica Uscite Emergenza: ${status}\n`;
                    }
                    if (item.checks.vvf && (filteredNiches.find(n => n.id === item.id)?.isVvfSpecial)) {
 const status = item.checks.vvf === 'presente' ? '‚úÖ Presente e segnaletica OK' : '‚ö†Ô∏è Assente / non conforme';
 report += ` Antincendio VV.F. (manichette + segnaletica): ${status}\n`;
 }
 if (item.checks.illuminazione) {
                        const status = item.checks.illuminazione === 'funzionante' ? '‚úÖ Funzionante' : '‚ö†Ô∏è Necessita Manutenzione';
                        report += `   Illuminazione Emergenza (12,5m): ${status}\n`;
                    }
                }
                
                if (item.timestamp) {
                    report += `   Data Verifica: ${new Date(item.timestamp).toLocaleString('it-IT')}\n`;
                }
                
                const photos = item.photosByType || {};
                const totalPhotos = (photos.segnaletica?.length || 0) + (photos.illuminazione?.length || 0) + (photos.vvf?.length || 0);
                if (totalPhotos > 0) {
                    report += `   Foto Allegate: ${totalPhotos}\n`;
                    if (photos.segnaletica?.length > 0) report += `     - Segnaletica: ${photos.segnaletica.length}\n`;
                    if (photos.illuminazione?.length > 0) report += `     - Illuminazione: ${photos.illuminazione.length}\n`;
                    if (photos.general?.length > 0) report += `     - Generali: ${photos.general.length}\n`;
                }
                
                report += '\n';
            });
            
            report += '\n='.repeat(60) + '\n';
            report += 'Note Tecniche:\n';
            report += '- Segnaletica: Indica le uscite di emergenza in galleria\n';
            report += '- Illuminazione: Corpi illuminanti sopra corrimano a distanza 12,5m\n';
            report += '\nFine Report\n';
            report += `Generato da NicheSafe - ${new Date().toLocaleString('it-IT')}\n`;
            
            return report;
        }

        // LocalStorage functions
        function saveToLocalStorage() {
            localStorage.setItem('checklistData', JSON.stringify(checklistData));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('checklistData');
            if (saved) {
                const savedData = JSON.parse(saved);
                
                savedData.forEach(savedItem => {
                    const item = checklistData.find(i => i.id === savedItem.id);
                    if (item) {
                        Object.assign(item, savedItem);
                        
                        // Ensure checks object exists
                        if (!item.checks) {
                            item.checks = {
                                segnaletica: null,
                                illuminazione: null
                            };
                        }
                        
                        // Ensure photosByType exists
                        if (!item.photosByType) {
                            item.photosByType = {
                                segnaletica: [],
                                illuminazione: [],
                                general: []
                            };
                        }
                        
                        // Ensure needsPhoto exists
                        if (!item.needsPhoto) {
                            item.needsPhoto = {
                                segnaletica: false,
                                illuminazione: false
                            };
                        }
                        
                        // Update UI radio buttons
                        if (item.checks.segnaletica) {
                            const radio = document.querySelector(`input[name="segnaletica-${item.id}"][value="${item.checks.segnaletica}"]`);
                            if (radio) {
                                radio.checked = true;
                                const label = radio.closest('.radio-label');
                                if (label) label.style.borderColor = 'var(--primary)';
                                
                                // Show photo button if needed
                                if (item.checks.segnaletica === 'manutenzione') {
                                    const photoBtn = document.getElementById(`photo-btn-seg-${item.id}`);
                                    if (photoBtn) photoBtn.style.display = 'block';
                                }
                            }
                        }
                        
                        if (item.checks.vvf && (filteredNiches.find(n => n.id === item.id)?.isVvfSpecial)) {
 const status = item.checks.vvf === 'presente' ? '‚úÖ Presente e segnaletica OK' : '‚ö†Ô∏è Assente / non conforme';
 report += ` Antincendio VV.F. (manichette + segnaletica): ${status}\n`;
 }
 if (item.checks.illuminazione) {
                            const radio = document.querySelector(`input[name="illuminazione-${item.id}"][value="${item.checks.illuminazione}"]`);
                            if (radio) {
                                radio.checked = true;
                                const label = radio.closest('.radio-label');
                                if (label) label.style.borderColor = 'var(--primary)';
                                
                                // Show photo button if needed
                                if (item.checks.vvf === 'non_conforme') {
 const photoCount = item.photosByType?.vvf?.length || 0;
 report += ` ‚ö†Ô∏è ANTINCENDIO VV.F. (MANICHETTE + SEGNALETICA) - Assente / non conforme`;
 if (photoCount > 0) report += ` (${photoCount} foto)`;
 report += '\n';
 }
 if (item.checks.illuminazione === 'manutenzione') {
                                    const photoBtn = document.getElementById(`photo-btn-ill-${item.id}`);
                                    if (photoBtn) photoBtn.style.display = 'block';
                                }
                            }
                        }
                        
                        const itemEl = document.getElementById(`item-${item.id}`);
                        if (item.completed) {
                            itemEl.classList.add('completed');
                        }
                        
                        updateMeta(item.id);
                        displayPhotos(item.id);
                    }
                });
                
                updateProgress();
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.error('Service Worker registration failed:', err));
        }
    </script>
</body>
</html>
