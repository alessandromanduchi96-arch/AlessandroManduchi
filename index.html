<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <title>RFI Tunnel Inspector - Sistema di Verifica Nicchie</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="RFI Tunnel Inspector">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --primary-light: #3b82f6;
            --bg-main: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --accent: #10b981;
            --accent-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --border: #e2e8f0;
            --border-focus: #3b82f6;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 2.5rem;
            padding: 2rem 1rem;
            background: var(--bg-main);
            border-radius: 12px;
            box-shadow: 0 1px 3px var(--shadow);
        }
        
        .logo {
            font-family: 'Inter', sans-serif;
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }
        
        .tagline {
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        /* Status bar */
        .status-bar {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-main);
            border-radius: 8px;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px var(--shadow);
            font-weight: 500;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-online .status-dot {
            background: var(--accent);
        }
        
        .status-offline .status-dot {
            background: var(--warning);
        }
        
        /* Card */
        .card {
            background: var(--bg-main);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 1px 3px var(--shadow);
            border: 1px solid var(--border);
        }
        
        .section-title {
            font-family: 'Inter', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-primary);
        }
        
        .section-icon {
            width: 28px;
            height: 28px;
            background: var(--primary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        /* Checklist items */

 /* Track alignment */
 .check-item.track-d { transform: none; }
 .check-item.track-p { transform: none; }
 .check-item.track-d:hover { transform: translateY(-2px); }
 .check-item.track-p:hover { transform: translateY(-2px); }

 /* VVF section */
 .vvf-badge {
  display:inline-flex;
  align-items:center;
  gap:0.4rem;
  padding:0.3rem 0.6rem;
  border-radius:6px;
  font-size:0.75rem;
  font-weight:600;
  background: var(--warning-light);
  border: 1px solid var(--warning);
  color: #92400e;
 }

        .checklist {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .check-item {
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 1px 2px var(--shadow);
        }
        
        .check-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: var(--accent);
            transform: scaleY(0);
            transition: transform 0.2s ease;
        }
        
        .check-item.completed::before {
            transform: scaleY(1);
        }
        
        .check-item:hover {
            border-color: var(--primary-light);
            box-shadow: 0 4px 6px var(--shadow);
        }
        
        .check-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .checkbox-wrapper {
            position: relative;
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            width: 100%;
            height: 100%;
            cursor: pointer;
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
        }
        
        .checkbox-custom {
            width: 100%;
            height: 100%;
            border: 2px solid var(--border);
            border-radius: 4px;
            position: absolute;
            top: 0;
            left: 0;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }
        
        .checkbox-wrapper input[type="checkbox"]:checked + .checkbox-custom {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .checkbox-custom::after {
            content: '✓';
            color: white;
            font-size: 1rem;
            font-weight: bold;
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s ease;
        }
        
        .checkbox-wrapper input[type="checkbox"]:checked + .checkbox-custom::after {
            opacity: 1;
            transform: scale(1);
        }
        
        .check-content {
            flex: 1;
        }
        
        .check-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .check-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        
        .check-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .meta-icon {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--primary-light);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            font-weight: 600;
            padding: 0.875rem 1.75rem;
            font-size: 0.9375rem;
            box-shadow: 0 1px 2px var(--shadow);
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 6px var(--shadow);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary:disabled:hover {
            background: var(--primary);
            box-shadow: 0 1px 2px var(--shadow);
        }
        
        /* Photo preview */
        .photo-preview {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .photo-thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 6px;
            object-fit: cover;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .photo-thumbnail:hover {
            transform: scale(1.05);
            border-color: var(--primary);
            box-shadow: 0 4px 6px var(--shadow);
        }
        
        /* Pulse animation for photo button highlight */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(30, 64, 175, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(30, 64, 175, 0);
            }
        }
        
        /* Progress bar */
        .progress-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .progress-label {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .progress-percentage {
            color: var(--accent);
            font-weight: 600;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 999px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 999px;
            transition: width 0.4s ease;
        }
        
        /* Submit section */
        .submit-section {
            margin-top: 2rem;
            text-align: center;
        }
        
        .email-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-main);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .email-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-main);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px var(--shadow);
            transform: translateY(200%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 350px;
        }
        
        .toast.show {
            transform: translateY(0);
        }
        
        .toast.success {
            border-left: 4px solid var(--accent);
        }
        
        .toast.error {
            border-left: 4px solid var(--danger);
        }
        
        /* Animations */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        /* Responsive */
        @media (max-width: 640px) {
            .logo {
                font-size: 2rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .check-item {
                padding: 1rem;
            }
            
            .toast {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
                max-width: none;
            }
        }
        
        /* Hidden input */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Start Screen -->
        <div id="startScreen" class="card" style="display: block;">
            <header class="header">
                <h1 class="logo">RFI Tunnel Inspector</h1>
                <p class="tagline">Sistema di Verifica Nicchie di Sicurezza</p>
            </header>
            
            <h2 class="section-title" style="margin-top: 2rem;">
                <span class="section-icon">></span>
                Inizia Verifica
            </h2>
            
            <div style="margin-bottom: 2rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary); font-size: 0.9375rem;">
                    Da quale nicchia vuoi iniziare?
                    <small style="display: block; color: #6b7280; font-weight: 400; margin-top: 0.25rem; font-size: 0.8125rem;">
                        Inserisci le prime due cifre (es. 55, 54, 53...)
                    </small>
                </label>
                <input 
                    id="startNiche" 
                    list="nicheList"
                    class="email-input" 
                    placeholder="es. 55+742 - D"
                    autocomplete="off"
                    style="cursor: text;"
                >
                <datalist id="nicheList">
                </datalist>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary); font-size: 0.9375rem;">
                    In quale direzione stai andando?
                </label>
                <select id="direction" class="email-input" style="cursor: pointer;">
                    <option value="">-- Seleziona direzione --</option>
                    <option value="san_benedetto">↑ Verso San Benedetto Val di Sambro (55+742)</option>
                    <option value="vernio">↓ Verso Vernio (37+200)</option>
                </select>
            </div>
            
            <div style="text-align: center;">
                <button class="btn btn-primary" id="startBtn" disabled>
                    <span>Inizia Verifica</span>
                </button>
            </div>
        </div>
        
        <!-- Main Screen -->
        <div id="mainScreen" style="display: none;">
        <header class="header">
            <h1 class="logo">RFI Tunnel Inspector</h1>
            <p class="tagline">Sistema di Verifica Nicchie di Sicurezza</p>
        </header>
        
        <div class="status-bar">
            <div class="status-badge" id="onlineStatus">
                <span class="status-dot"></span>
                <span id="statusText">Controllo connessione...</span>
            </div>
            <div class="status-badge">
                <span id="directionInfo">Direzione non impostata</span>
            </div>
        </div>
        
        <div class="card">
            <h2 class="section-title">
                <span class="section-icon">V</span>
                Elenco Nicchie da Verificare
            </h2>
            
            <div class="checklist" id="checklist">
                <!-- Items will be added here -->
            </div>

 <div id="paginationControls" style="margin-top: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
  <button class="btn btn-secondary" id="loadMoreBtn" type="button" style="min-width: 220px; justify-content: center;">
    + Mostra altre 10
  </button>
  <div id="shownCount" style="color: var(--text-secondary); font-size: 0.875rem; font-weight: 500;">
    Mostrate 0/0
  </div>
 </div>

            
            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-label">Progresso</span>
                    <span class="progress-percentage" id="progressText">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Download Section -->
            <div class="submit-section" style="margin-bottom: 1.5rem;">
                <div style="margin-bottom: 0.75rem; color: var(--text-primary); font-size: 1rem; font-weight: 600;">
                    Scarica Report
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                    <button class="btn" style="background: #059669; color: white;" id="downloadTxtBtn">
                        <span>↓ Scarica TXT</span>
                    </button>
                    <button class="btn" style="background: #0891b2; color: white;" id="downloadJsonBtn">
                        <span>↓ Scarica JSON</span>
                    </button>
                </div>
            </div>

            <div class="submit-section">
  <div style="margin-bottom: 0.75rem; color: var(--text-secondary); font-size: 0.9375rem; font-weight: 500;">
    Destinatario report: <b style="color: var(--text-primary);" id="fixedRecipient">a.manduchi@rfi.it</b>
  </div>
  <input type="email" class="email-input hidden" id="emailInput" value="a.manduchi@rfi.it">
  <button class="btn btn-primary" id="submitBtn">
                    <span>Invia Report via Email</span>
                </button>
</div>
        </div>
        </div> <!-- end mainScreen -->
    </div> <!-- end container -->
    
    <div class="toast" id="toast"></div>
    
    <!-- Hidden file input for camera -->
    <input type="file" accept="image/*" capture="environment" class="hidden" id="cameraInput">

    <script>
        // Configuration - Load niches data from files
        let NICHES_RAW_DATA = '';
        let VVF_SPECIAL_SET = new Set();
        let TEM_NICHES_SET = new Set();
        let IDRANTI_NICHES_SET = new Set();
        let dataLoaded = false;

        // Load all data files
        async function loadDataFiles() {
            try {
                // Load NicchieTotali.txt
                const nicchieTotaliResp = await fetch('data/NicchieTotali.txt');
                const nicchieTotaliText = await nicchieTotaliResp.text();
                
                // Parse the file - format is "P\tD" header, then rows like "55+650\t55+742"
                const lines = nicchieTotaliText.trim().split('\n');
                const nichesList = [];
                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].trim().split('\t');
                    if (parts[0]) nichesList.push(`${parts[0]} P`);
                    if (parts[1]) nichesList.push(`${parts[1]} D`);
                }
                NICHES_RAW_DATA = nichesList.join('\n');
                
                // Load NicchieQuadriVVF.txt
                const vvfResp = await fetch('data/NicchieQuadriVVF.txt');
                const vvfText = await vvfResp.text();
                const vvfLines = vvfText.trim().split('\n');
                for (let i = 1; i < vvfLines.length; i++) {
                    const line = vvfLines[i].trim();
                    if (line) VVF_SPECIAL_SET.add(line);
                }
                
                // Load NicchieTEM.txt
                const temResp = await fetch('data/NicchieTEM.txt');
                const temText = await temResp.text();
                const temLines = temText.trim().split('\n');
                for (let i = 1; i < temLines.length; i++) {
                    const parts = temLines[i].trim().split('\t');
                    if (parts[0]) TEM_NICHES_SET.add(`${parts[0]} D`);
                    if (parts[1]) TEM_NICHES_SET.add(`${parts[1]} P`);
                }
                
                // Load NicchieIdranti.txt
                const idrantiResp = await fetch('data/NicchieIdranti.txt');
                const idrantiText = await idrantiResp.text();
                const idrantiLines = idrantiText.trim().split('\n');
                for (let i = 1; i < idrantiLines.length; i++) {
                    const parts = idrantiLines[i].trim().split('\t');
                    if (parts[0]) IDRANTI_NICHES_SET.add(`${parts[0]} D`);
                    if (parts[1]) IDRANTI_NICHES_SET.add(`${parts[1]} P`);
                }
                
                dataLoaded = true;
                return true;
            } catch (error) {
                console.error('Error loading data files:', error);
                // Fallback to hardcoded data
                NICHES_RAW_DATA = `55+742 D
55+675 D
55+650 P
55+650 D
55+625 D
55+600 P
55+575 D
55+550 P
55+550 D
55+525 D
55+500 P
55+492 D
55+475 D
55+450 P
55+425 D
55+400 P
55+375 D
55+350 P
55+325 D
55+300 P
55+275 D
55+250 P
55+225 D
55+200 P
55+175 D
55+150 P
55+125 D
55+100 P
55+075 D
55+050 P
55+024 D
55+000 P
54+974 D
54+949 P
54+924 D
54+899 P
54+874 D
54+849 P
54+824 D
54+799 P
54+774 D
54+749 P
54+724 D
54+699 P
54+674 P
54+674 D
54+649 P
54+624 D
54+599 P
54+574 D
54+549 P
54+524 D
54+499 P
54+474 D
54+449 P
54+424 D
54+399 P
54+374 D
54+349 P
54+324 D
54+299 P
54+274 D
54+249 P
54+224 D`;
                VVF_SPECIAL_SET = new Set(['55+575 D', '55+425 D', '55+275 D', '55+175 D', '55+024 D', '54+874 D']);
                TEM_NICHES_SET = new Set(['55+475 D', '55+024 D']);
                IDRANTI_NICHES_SET = new Set(['55+575 D', '55+425 D']);
                dataLoaded = true;
                return false;
            }
        }

        // Parse niches data and create CHECKLIST_ITEMS
        let CHECKLIST_ITEMS = [];
        
        function parseNichesData() {
            CHECKLIST_ITEMS = NICHES_RAW_DATA.split('\n')
                .map((line, index) => {
                    const parts = line.trim().split(' ');
                    if (parts.length === 2) {
                        const nicheKey = `${parts[0]} ${parts[1]}`;
                        return {
                            id: index + 1,
                            km: parts[0],
                            binario: parts[1],
                            title: `Nicchia km ${parts[0]} - ${parts[1]}`,
                            description: `Verifica Segnaletica e Illuminazione`,
                            isVvfSpecial: VVF_SPECIAL_SET.has(nicheKey),
                            hasTEM: TEM_NICHES_SET.has(nicheKey),
                            hasIdranti: IDRANTI_NICHES_SET.has(nicheKey)
                        };
                    }
                    return null;
                })
                .filter(item => item !== null);
        }
        // State
        let checklistData = [];
        let isOnline = navigator.onLine;
        let selectedDirection = null;
        let startNicheId = null;
        let filteredNiches = [];
 let pageSize = 10;
 let currentPageStart = 0;
 let orderedItemIds = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadDataFiles();
            parseNichesData();
            populateStartNicheSelect();
            setupStartScreen();
            updateOnlineStatus();
            
            // Event listeners
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            document.getElementById('submitBtn').addEventListener('click', submitReport);
            document.getElementById('downloadTxtBtn').addEventListener('click', downloadTextFile);
            document.getElementById('downloadJsonBtn').addEventListener('click', downloadJsonFile);
            document.getElementById('cameraInput').addEventListener('change', handlePhotoCapture);
 document.getElementById('loadMoreBtn')?.addEventListener('click', showNextPage);
        });
        
        // Populate start niche datalist with chunked loading for better performance
        function populateStartNicheSelect() {
            const datalist = document.getElementById('nicheList');
            const CHUNK_SIZE = 100; // Process 100 items at a time
            let currentIndex = 0;
            
            function addChunk() {
                const fragment = document.createDocumentFragment();
                const endIndex = Math.min(currentIndex + CHUNK_SIZE, CHECKLIST_ITEMS.length);
                
                // Create options in batch - format: "55+742 - D"
                for (let i = currentIndex; i < endIndex; i++) {
                    const item = CHECKLIST_ITEMS[i];
                    const option = document.createElement('option');
                    option.value = `${item.km} - ${item.binario}`;
                    option.dataset.id = item.id;
                    fragment.appendChild(option);
                }
                
                // Single DOM append for all options in this chunk
                datalist.appendChild(fragment);
                currentIndex = endIndex;
                
                // Schedule next chunk if there are more items
                if (currentIndex < CHECKLIST_ITEMS.length) {
                    // Use requestIdleCallback if available, otherwise setTimeout
                    if ('requestIdleCallback' in window) {
                        requestIdleCallback(() => addChunk(), { timeout: 100 });
                    } else {
                        setTimeout(addChunk, 0);
                    }
                }
            }
            
            // Start loading first chunk
            addChunk();
        }
        
        // Setup start screen
        function setupStartScreen() {
            const startNicheInput = document.getElementById('startNiche');
            const directionSelect = document.getElementById('direction');
            const startBtn = document.getElementById('startBtn');
            
            const checkStartButton = () => {
                // Validate that input matches a valid niche format
                const inputValue = startNicheInput.value.trim();
                const isValidNiche = inputValue && CHECKLIST_ITEMS.some(item => 
                    `${item.km} - ${item.binario}` === inputValue
                );
                startBtn.disabled = !(isValidNiche && directionSelect.value);
            };
            
            startNicheInput.addEventListener('input', checkStartButton);
            directionSelect.addEventListener('change', checkStartButton);
            
            startBtn.addEventListener('click', () => {
                // Parse the input value to find the corresponding niche ID
                const inputValue = startNicheInput.value.trim();
                const selectedItem = CHECKLIST_ITEMS.find(item => 
                    `${item.km} - ${item.binario}` === inputValue
                );
                
                if (!selectedItem) {
                    alert('Seleziona una nicchia valida dalla lista');
                    return;
                }
                
                startNicheId = selectedItem.id;
                selectedDirection = directionSelect.value;
                
                // Filter niches based on direction
                filterNichesByDirection();
                
                // Initialize filtered checklist
                initializeChecklist();
                loadFromLocalStorage();
                updateProgress();
                
                // Update direction info
                const dirText = selectedDirection === 'san_benedetto' 
                    ? '↑ Verso San Benedetto' 
                    : '↓ Verso Vernio';
                document.getElementById('directionInfo').textContent = dirText;
                
                // Show main screen
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('mainScreen').style.display = 'block';
                
                showToast('Verifica iniziata!', 'success');
            });
        }
        
        // Filter niches by direction
        function filterNichesByDirection() {
            const startNiche = CHECKLIST_ITEMS.find(n => n.id === startNicheId);
            const startKmValue = parseFloat(startNiche.km.replace('+', '.'));
            
            if (selectedDirection === 'san_benedetto') {
                // Going up towards 55+742
                filteredNiches = CHECKLIST_ITEMS.filter(n => {
                    const kmValue = parseFloat(n.km.replace('+', '.'));
                    return kmValue >= startKmValue;
                }).sort((a, b) => {
                    const aVal = parseFloat(a.km.replace('+', '.'));
                    const bVal = parseFloat(b.km.replace('+', '.'));
                    return aVal - bVal; // Ascending
                });
            } else {
                // Going down towards 37+200
                filteredNiches = CHECKLIST_ITEMS.filter(n => {
                    const kmValue = parseFloat(n.km.replace('+', '.'));
                    return kmValue <= startKmValue;
                }).sort((a, b) => {
                    const aVal = parseFloat(a.km.replace('+', '.'));
                    const bVal = parseFloat(b.km.replace('+', '.'));
                    return bVal - aVal; // Descending
                });
            }
        }

        // Initialize checklist
        function initializeChecklist() {
            const container = document.getElementById('checklist');
            container.innerHTML = ''; // Clear existing
            checklistData = []; // Reset
            
            filteredNiches.forEach(item => {
                const itemData = {
                    id: item.id,
                    km: item.km,
                    binario: item.binario,
                    title: item.title,
                    description: item.description,
                    completed: false,
                    checks: {
                        segnaletica: null,
                        illuminazione: null,
                        vvf: item.isVvfSpecial ? null : undefined,
                        tem: item.hasTEM ? null : undefined,
                        idranti: item.hasIdranti ? null : undefined,
                        camminamento: null,
                        corrimano: null
                    },
                    illuminazioneCount: null,
                    timestamp: null,
                    photos: [], // Backward compatibility
                    photosByType: {
                        segnaletica: [],
                        illuminazione: [],
                        vvf: [],
                        tem: [],
                        idranti: [],
                        general: []
                    },
                    needsPhoto: {
                        segnaletica: false,
                        illuminazione: false,
                        vvf: false,
                        tem: false,
                        idranti: false
                    },
                    notes: '',
                    idrantiNotes: ''
                };
                
                checklistData.push(itemData);
                
                const itemEl = createChecklistItem(item, itemData);
                container.appendChild(itemEl);
            });
        
            // Pagination order and first page
            orderedItemIds = filteredNiches.map(n => n.id);
            showPage(0);
}

        // Create checklist item element
        function createChecklistItem(item, data) {
            const div = document.createElement('div');
            div.className = 'check-item';
            div.id = `item-${item.id}`;
            
            div.innerHTML = `
                <div class="check-header">
                    <div class="check-content">
                        <div class="check-title">${item.title}</div>
                        
                        <!-- Segnaletica Section -->
                        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary);">
                                <span style="font-weight: 700; color: var(--primary);">•</span>
                                <span>Segnaletica Uscite di Emergenza</span>
                            </div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Verifica presenza e visibilità della segnaletica di emergenza
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-main); border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s;" class="radio-label">
                                    <input type="radio" name="segnaletica-${item.id}" value="conforme" class="safety-radio" data-id="${item.id}" data-type="segnaletica"
                                           style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-weight: 500;">✓ Conforme</span>
                                </label>
                                
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-main); border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s;" class="radio-label">
                                    <input type="radio" name="segnaletica-${item.id}" value="non_conforme" class="safety-radio" data-id="${item.id}" data-type="segnaletica"
                                           style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-weight: 500;">⚠ Non Conforme</span>
                                </label>
                            </div>
                            
                            <div id="photo-btn-seg-${item.id}" style="margin-top: 1rem; display: none;">
                                <button class="btn btn-secondary" onclick="capturePhoto(${item.id}, 'segnaletica')" style="width: 100%; justify-content: center;">
                                    Allega Foto
                                </button>
                            </div>
                        </div>
                        
                        <!-- Illuminazione Section -->
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary);">
                                <span style="font-weight: 700; color: var(--primary);">•</span>
                                <span>Illuminazione di Emergenza</span>
                            </div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Verifica illuminazione sopra il corrimano (distanza 12,5m tra corpi illuminanti)
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-main); border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s;" class="radio-label">
                                    <input type="radio" name="illuminazione-${item.id}" value="conforme" class="safety-radio" data-id="${item.id}" data-type="illuminazione"
                                           style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-weight: 500;">✓ Conforme</span>
                                </label>
                                
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-main); border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s;" class="radio-label">
                                    <input type="radio" name="illuminazione-${item.id}" value="non_conforme" class="safety-radio" data-id="${item.id}" data-type="illuminazione"
                                           style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-weight: 500;">⚠ Non Conforme</span>
                                </label>
                            </div>
                            
                            <div id="illum-count-${item.id}" style="margin-top: 1rem; display: none;">
                                <label style="display: block; font-size: 0.875rem; margin-bottom: 0.5rem; font-weight: 500;">Quanti corpi illuminanti non funzionanti?</label>
                                <input type="number" id="illum-count-input-${item.id}" min="0" class="form-input" data-id="${item.id}" 
                                       style="width: 100%; padding: 0.75rem; background: var(--bg-main); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 0.9375rem;">
                            </div>
                            
                            <div id="photo-btn-ill-${item.id}" style="margin-top: 1rem; display: none;">
                                <button class="btn btn-secondary" onclick="capturePhoto(${item.id}, 'illuminazione')" style="width: 100%; justify-content: center;">
                                    Allega Foto
                                </button>
                            </div>
                            
                            <!-- Camminamento Check -->
                            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 0.9375rem; color: var(--text-primary);">Camminamento</div>
                                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                    <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-main); border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s;" class="radio-label">
                                        <input type="radio" name="camminamento-${item.id}" value="conforme" class="safety-radio" data-id="${item.id}" data-type="camminamento"
                                               style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-weight: 500;">✓ Conforme</span>
                                    </label>
                                    <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-main); border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s;" class="radio-label">
                                        <input type="radio" name="camminamento-${item.id}" value="non_conforme" class="safety-radio" data-id="${item.id}" data-type="camminamento"
                                               style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-weight: 500;">⚠ Non Conforme</span>
                                    </label>
                                </div>
                                <div id="photo-btn-camminamento-${item.id}" style="margin-top: 1rem; display: none;">
                                    <button class="btn btn-secondary" onclick="capturePhoto(${item.id}, 'camminamento')" style="width: 100%; justify-content: center;">
                                        Allega Foto
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Corrimano Check -->
                            <div style="margin-top: 1rem;">
                                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 0.9375rem; color: var(--text-primary);">Corrimano</div>
                                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                    <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-main); border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s;" class="radio-label">
                                        <input type="radio" name="corrimano-${item.id}" value="conforme" class="safety-radio" data-id="${item.id}" data-type="corrimano"
                                               style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-weight: 500;">✓ Conforme</span>
                                    </label>
                                    <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-main); border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s;" class="radio-label">
                                        <input type="radio" name="corrimano-${item.id}" value="non_conforme" class="safety-radio" data-id="${item.id}" data-type="corrimano"
                                               style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-weight: 500;">⚠ Non Conforme</span>
                                    </label>
                                </div>
                                <div id="photo-btn-corrimano-${item.id}" style="margin-top: 1rem; display: none;">
                                    <button class="btn btn-secondary" onclick="capturePhoto(${item.id}, 'corrimano')" style="width: 100%; justify-content: center;">
                                        Allega Foto
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        ${item.isVvfSpecial ? `
 <!-- VVF Section (solo nicchie selezionate) -->
 <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
  <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.75rem; margin-bottom: 0.5rem;">
   <div style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary);">
    <span style="font-weight: 700; color: var(--primary);">•</span>
    <span>Antincendio VV.F.</span>
   </div>
   <span class="vvf-badge">VVF</span>
  </div>
  <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
   Verifica presenza manichette e segnaletica antincendio
  </div>
  <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
   <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-main); border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s;" class="radio-label">
    <input type="radio" name="vvf-${item.id}" value="presente" class="safety-radio" data-id="${item.id}" data-type="vvf" style="width: 18px; height: 18px; cursor: pointer;">
    <span style="font-weight: 500;">✓ Conforme</span>
   </label>
   <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-main); border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s;" class="radio-label">
    <input type="radio" name="vvf-${item.id}" value="non_conforme" class="safety-radio" data-id="${item.id}" data-type="vvf" style="width: 18px; height: 18px; cursor: pointer;">
    <span style="font-weight: 500;">⚠ Non Conforme</span>
   </label>
  </div>
  <div id="photo-btn-vvf-${item.id}" style="margin-top: 1rem; display: none;">
   <button class="btn btn-secondary" onclick="capturePhoto(${item.id}, 'vvf')" style="width: 100%; justify-content: center;">Allega Foto</button>
  </div>
 </div>
` : ``}

${item.hasTEM ? `
<!-- TEM Telephony Section -->
<div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
  <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.75rem; margin-bottom: 0.5rem;">
    <div style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary);">
      <span style="font-weight: 700; color: var(--primary);">•</span>
      <span>Telefonia TEM</span>
    </div>
    <span class="vvf-badge">TEM</span>
  </div>
  <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
    Verifica presenza e funzionalità sistema telefonia
  </div>
  <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
    <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-main); border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s;" class="radio-label">
      <input type="radio" name="tem-${item.id}" value="conforme" class="safety-radio" data-id="${item.id}" data-type="tem" style="width: 18px; height: 18px; cursor: pointer;">
      <span style="font-weight: 500;">✓ Conforme</span>
    </label>
    <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-main); border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s;" class="radio-label">
      <input type="radio" name="tem-${item.id}" value="non_conforme" class="safety-radio" data-id="${item.id}" data-type="tem" style="width: 18px; height: 18px; cursor: pointer;">
      <span style="font-weight: 500;">⚠ Non Conforme</span>
    </label>
  </div>
  <div id="photo-btn-tem-${item.id}" style="margin-top: 1rem; display: none;">
    <button class="btn btn-secondary" onclick="capturePhoto(${item.id}, 'tem')" style="width: 100%; justify-content: center;">Allega Foto</button>
  </div>
</div>
` : ``}

${item.hasIdranti ? `
<!-- Idranti Section -->
<div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
  <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.75rem; margin-bottom: 0.5rem;">
    <div style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary);">
      <span style="font-weight: 700; color: var(--primary);">•</span>
      <span>Idranti</span>
    </div>
    <span class="vvf-badge">Idranti</span>
  </div>
  <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
    Verifica presenza e conformità idranti
  </div>
  <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
    <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-main); border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s;" class="radio-label">
      <input type="radio" name="idranti-${item.id}" value="conforme" class="safety-radio" data-id="${item.id}" data-type="idranti" style="width: 18px; height: 18px; cursor: pointer;">
      <span style="font-weight: 500;">✓ Conforme</span>
    </label>
    <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-main); border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s;" class="radio-label">
      <input type="radio" name="idranti-${item.id}" value="non_conforme" class="safety-radio" data-id="${item.id}" data-type="idranti" style="width: 18px; height: 18px; cursor: pointer;">
      <span style="font-weight: 500;">⚠ Non Conforme</span>
    </label>
  </div>
  <div id="idranti-notes-${item.id}" style="margin-top: 1rem; display: none;">
    <label style="display: block; font-size: 0.875rem; margin-bottom: 0.5rem; font-weight: 500;">Note</label>
    <textarea id="idranti-notes-input-${item.id}" class="form-input" data-id="${item.id}" rows="3"
              style="width: 100%; padding: 0.75rem; background: var(--bg-main); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); resize: vertical; font-size: 0.9375rem;"></textarea>
  </div>
  <div id="photo-btn-idranti-${item.id}" style="margin-top: 1rem; display: none;">
    <button class="btn btn-secondary" onclick="capturePhoto(${item.id}, 'idranti')" style="width: 100%; justify-content: center;">Allega Foto</button>
  </div>
</div>
` : ``}

<div class="photo-preview" id="photos-${item.id}" style="margin-top: 1rem;"></div>
                        
                        <div class="check-meta" id="meta-${item.id}"></div>
                    </div>
                </div>
            `;
            
            // Add radio listeners
            const radios = div.querySelectorAll('.safety-radio');
            radios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    handleSafetyCheck(item.id, e.target.dataset.type, e.target.value);
                    
                    // Visual feedback for selected label
                    const label = e.target.closest('.radio-label');
                    const allLabels = label.parentElement.querySelectorAll('.radio-label');
                    allLabels.forEach(l => l.style.borderColor = 'transparent');
                    if (e.target.checked) {
                        label.style.borderColor = 'var(--primary)';
                    }
                });
            });
            
            // Add illuminazione count input listener
            const illumCountInput = div.querySelector(`#illum-count-input-${item.id}`);
            if (illumCountInput) {
                illumCountInput.addEventListener('input', (e) => {
                    const itemData = checklistData.find(i => i.id === item.id);
                    itemData.illuminazioneCount = e.target.value ? parseInt(e.target.value) : null;
                    saveToLocalStorage();
                });
            }
            
            // Add idranti notes input listener
            const idrantiNotesInput = div.querySelector(`#idranti-notes-input-${item.id}`);
            if (idrantiNotesInput) {
                idrantiNotesInput.addEventListener('input', (e) => {
                    const itemData = checklistData.find(i => i.id === item.id);
                    itemData.idrantiNotes = e.target.value;
                    saveToLocalStorage();
                });
            }
            
            return div;
        }

        // Handle safety radio change
        function handleSafetyCheck(id, type, value) {
            const itemData = checklistData.find(item => item.id === id);
            const niche = filteredNiches.find(n => n.id === id);
            
            if (!itemData.checks) {
                itemData.checks = {
                    segnaletica: null,
                    illuminazione: null,
                    vvf: niche?.isVvfSpecial ? null : undefined,
                    tem: niche?.hasTEM ? null : undefined,
                    idranti: niche?.hasIdranti ? null : undefined,
                    camminamento: null,
                    corrimano: null
                };
            }
            
            itemData.checks[type] = value;
            
            // Show/hide photo button and special fields based on selection
            if (type === 'illuminazione') {
                const countDiv = document.getElementById(`illum-count-${id}`);
                const photoBtn = document.getElementById(`photo-btn-ill-${id}`);
                if (value === 'non_conforme') {
                    if (countDiv) countDiv.style.display = 'block';
                    if (photoBtn) photoBtn.style.display = 'block';
                } else {
                    if (countDiv) countDiv.style.display = 'none';
                    if (photoBtn) photoBtn.style.display = 'none';
                }
            } else if (type === 'idranti') {
                const notesDiv = document.getElementById(`idranti-notes-${id}`);
                const photoBtn = document.getElementById(`photo-btn-idranti-${id}`);
                if (value === 'non_conforme') {
                    if (notesDiv) notesDiv.style.display = 'block';
                    if (photoBtn) photoBtn.style.display = 'block';
                } else {
                    if (notesDiv) notesDiv.style.display = 'none';
                    if (photoBtn) photoBtn.style.display = 'none';
                }
            } else {
                // For other types (segnaletica, vvf, tem, camminamento, corrimano)
                const photoBtnId = `photo-btn-${type}-${id}`;
                const photoBtn = document.getElementById(photoBtnId);
                if (photoBtn) {
                    if (value === 'non_conforme') {
                        photoBtn.style.display = 'block';
                    } else {
                        photoBtn.style.display = 'none';
                    }
                }
            }
            
            // Prompt for photo when "non conforme" is selected
            if (value === 'non_conforme') {
                // Show toast requesting photo
                const typeLabels = {
                    segnaletica: 'Segnaletica',
                    illuminazione: 'Illuminazione',
                    camminamento: 'Camminamento',
                    corrimano: 'Corrimano',
                    vvf: 'VVF',
                    tem: 'TEM',
                    idranti: 'Idranti'
                };
                const label = typeLabels[type] || type;
                showToast(`⚠️ ${label} non conforme - Si prega di allegare una foto`, 'warning');
                
                // Auto-scroll to photo button after a short delay
                setTimeout(() => {
                    const photoBtnId = type === 'illuminazione' ? `photo-btn-ill-${id}` : 
                                      type === 'idranti' ? `photo-btn-idranti-${id}` :
                                      `photo-btn-${type}-${id}`;
                    const photoBtn = document.getElementById(photoBtnId);
                    if (photoBtn && photoBtn.style.display !== 'none') {
                        photoBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        // Briefly highlight the button
                        photoBtn.style.animation = 'pulse 1s ease-in-out 2';
                    }
                }, 300);
            }
            
            // Update completed status - all applicable checks must be answered
            const requiresVVF = niche?.isVvfSpecial;
            const requiresTEM = niche?.hasTEM;
            const requiresIdranti = niche?.hasIdranti;
            
            itemData.completed = itemData.checks.segnaletica !== null && 
                                 itemData.checks.illuminazione !== null &&
                                 itemData.checks.camminamento !== null &&
                                 itemData.checks.corrimano !== null &&
                                 (!requiresVVF || itemData.checks.vvf !== null) &&
                                 (!requiresTEM || itemData.checks.tem !== null) &&
                                 (!requiresIdranti || itemData.checks.idranti !== null);
            
            if (itemData.completed && !itemData.timestamp) {
                itemData.timestamp = new Date().toISOString();
            } else if (!itemData.completed) {
                itemData.timestamp = null;
            }
            
            // Check if maintenance selected but no photo yet
            if (value === 'non_conforme') {
                const photos = itemData.photosByType?.[type] || [];
                if (photos.length === 0) {
                    itemData.needsPhoto = itemData.needsPhoto || {};
                    itemData.needsPhoto[type] = true;
                }
            } else {
                if (itemData.needsPhoto) {
                    itemData.needsPhoto[type] = false;
                }
            }
            
            const itemEl = document.getElementById(`item-${id}`);
            if (itemData.completed) {
                itemEl.classList.add('completed');
            } else {
                itemEl.classList.remove('completed');
            }
            
            updateProgress();
            updateMeta(id);
            saveToLocalStorage();
        }

        // Capture photo
        function capturePhoto(id, photoType) {
            const input = document.getElementById('cameraInput');
            input.dataset.itemId = id;
            input.dataset.photoType = photoType || 'general';
            input.click();
        }

        // Handle photo capture
        function handlePhotoCapture(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const itemId = parseInt(e.target.dataset.itemId);
            const photoType = e.target.dataset.photoType || 'general';
            const reader = new FileReader();
            
            reader.onload = (event) => {
                const itemData = checklistData.find(item => item.id === itemId);
                
                if (!itemData.photosByType) {
                    itemData.photosByType = {
                        segnaletica: [],
                        illuminazione: [],
                        camminamento: [],
                        corrimano: [],
                        vvf: [],
                        tem: [],
                        idranti: [],
                        general: []
                    };
                }
                
                // Keep backward compatibility
                if (!itemData.photos) itemData.photos = [];
                
                const photoData = {
                    data: event.target.result,
                    type: photoType,
                    timestamp: new Date().toISOString()
                };
                
                itemData.photosByType[photoType].push(photoData);
                itemData.photos.push(event.target.result); // Backward compatibility
                
                displayPhotos(itemId);
                saveToLocalStorage();
                showToast(`✓ Foto ${photoType} acquisita!`, 'success');
            };
            
            reader.readAsDataURL(file);
            e.target.value = ''; // Reset input
        }

        // Display photos
        function displayPhotos(id) {
            const itemData = checklistData.find(item => item.id === id);
            const container = document.getElementById(`photos-${id}`);
            
            if (!itemData.photosByType) {
                // Fallback for old format
                container.innerHTML = itemData.photos.map((photo, index) => 
                    `<img src="${photo}" class="photo-thumbnail" alt="Foto ${index + 1}" onclick="viewPhoto('${photo}')">`
                ).join('');
                return;
            }
            
            let html = '';
            
            // Segnaletica photos
            if (itemData.photosByType.segnaletica?.length > 0) {
                html += '<div style="margin-bottom: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">🚫 Segnaletica Mancante:</div>';
                itemData.photosByType.segnaletica.forEach((photo, index) => {
                    html += `<img src="${photo.data}" class="photo-thumbnail" alt="Segnaletica ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
                });
            }
            
            // Illuminazione photos
            if (itemData.photosByType.illuminazione?.length > 0) {
                html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">💡 Illuminazione Mancante:</div>';
                itemData.photosByType.illuminazione.forEach((photo, index) => {
                    html += `<img src="${photo.data}" class="photo-thumbnail" alt="Illuminazione ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
                });
            }
            
            // Camminamento photos
            if (itemData.photosByType.camminamento?.length > 0) {
                html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">🚶 Camminamento:</div>';
                itemData.photosByType.camminamento.forEach((photo, index) => {
                    html += `<img src="${photo.data}" class="photo-thumbnail" alt="Camminamento ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
                });
            }
            
            // Corrimano photos
            if (itemData.photosByType.corrimano?.length > 0) {
                html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">🤚 Corrimano:</div>';
                itemData.photosByType.corrimano.forEach((photo, index) => {
                    html += `<img src="${photo.data}" class="photo-thumbnail" alt="Corrimano ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
                });
            }
            
            // VVF photos
 if (itemData.photosByType.vvf?.length > 0) {
  html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">🔥 VV.F. / Manichette:</div>';
  itemData.photosByType.vvf.forEach((photo, index) => {
    html += `<img src="${photo.data}" class="photo-thumbnail" alt="VVF ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
  });
 }

 // TEM photos
 if (itemData.photosByType.tem?.length > 0) {
  html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">☎️ Telefonia TEM:</div>';
  itemData.photosByType.tem.forEach((photo, index) => {
    html += `<img src="${photo.data}" class="photo-thumbnail" alt="TEM ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
  });
 }

 // Idranti photos
 if (itemData.photosByType.idranti?.length > 0) {
  html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">🚰 Idranti:</div>';
  itemData.photosByType.idranti.forEach((photo, index) => {
    html += `<img src="${photo.data}" class="photo-thumbnail" alt="Idranti ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
  });
 }

 // General photos
            if (itemData.photosByType.general?.length > 0) {
                html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">📷 Altre Foto:</div>';
                itemData.photosByType.general.forEach((photo, index) => {
                    html += `<img src="${photo.data}" class="photo-thumbnail" alt="Generale ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
                });
            }
            
            container.innerHTML = html;
        }

        // View photo in new tab
        function viewPhoto(photo) {
            const win = window.open();
            win.document.write(`<img src="${photo}" style="max-width: 100%; height: auto;">`);
        }

        // Update meta information
        function updateMeta(id) {
            const itemData = checklistData.find(item => item.id === id);
            const container = document.getElementById(`meta-${id}`);
            
            let metaHtml = '';
            
            if (itemData.timestamp) {
                const date = new Date(itemData.timestamp);
                metaHtml += `
                    <div class="meta-item">
                        <span class="meta-icon">🕐</span>
                        <span>${date.toLocaleString('it-IT')}</span>
                    </div>
                `;
            }
            
            if (itemData.checks) {
                if (itemData.checks.segnaletica) {
                    const icon = itemData.checks.segnaletica === 'conforme' ? '✅' : '⚠️';
                    metaHtml += `
                        <div class="meta-item">
                            <span class="meta-icon">${icon}</span>
                            <span>Segnaletica: ${itemData.checks.segnaletica === 'conforme' ? 'OK' : 'Non conforme'}</span>
                        </div>
                    `;
                }
                
                if (itemData.checks.illuminazione) {
                    const icon = itemData.checks.illuminazione === 'conforme' ? '✅' : '⚠️';
                    let text = `Illuminazione: ${itemData.checks.illuminazione === 'conforme' ? 'OK' : 'Non conforme'}`;
                    if (itemData.illuminazioneCount) {
                        text += ` (${itemData.illuminazioneCount} non funz.)`;
                    }
                    metaHtml += `
                        <div class="meta-item">
                            <span class="meta-icon">${icon}</span>
                            <span>${text}</span>
                        </div>
                    `;
                }
                
                if (itemData.checks.camminamento) {
                    const icon = itemData.checks.camminamento === 'conforme' ? '✅' : '⚠️';
                    metaHtml += `
                        <div class="meta-item">
                            <span class="meta-icon">${icon}</span>
                            <span>Camminamento: ${itemData.checks.camminamento === 'conforme' ? 'OK' : 'Non conforme'}</span>
                        </div>
                    `;
                }
                
                if (itemData.checks.corrimano) {
                    const icon = itemData.checks.corrimano === 'conforme' ? '✅' : '⚠️';
                    metaHtml += `
                        <div class="meta-item">
                            <span class="meta-icon">${icon}</span>
                            <span>Corrimano: ${itemData.checks.corrimano === 'conforme' ? 'OK' : 'Non conforme'}</span>
                        </div>
                    `;
                }
                
                if (itemData.checks.vvf !== undefined && itemData.checks.vvf !== null && (filteredNiches.find(n => n.id === id)?.isVvfSpecial)) {
                  const icon = itemData.checks.vvf === 'presente' ? '✅' : '⚠️';
                  metaHtml += `
                  <div class="meta-item">
                    <span class="meta-icon">${icon}</span>
                    <span>VV.F.: ${itemData.checks.vvf === 'presente' ? 'OK' : 'Non conforme'}</span>
                  </div>
                  `;
                }
                
                if (itemData.checks.tem !== undefined && itemData.checks.tem !== null && (filteredNiches.find(n => n.id === id)?.hasTEM)) {
                  const icon = itemData.checks.tem === 'conforme' ? '✅' : '⚠️';
                  metaHtml += `
                  <div class="meta-item">
                    <span class="meta-icon">${icon}</span>
                    <span>TEM: ${itemData.checks.tem === 'conforme' ? 'OK' : 'Non conforme'}</span>
                  </div>
                  `;
                }
                
                if (itemData.checks.idranti !== undefined && itemData.checks.idranti !== null && (filteredNiches.find(n => n.id === id)?.hasIdranti)) {
                  const icon = itemData.checks.idranti === 'conforme' ? '✅' : '⚠️';
                  metaHtml += `
                  <div class="meta-item">
                    <span class="meta-icon">${icon}</span>
                    <span>Idranti: ${itemData.checks.idranti === 'conforme' ? 'OK' : 'Non conforme'}</span>
                  </div>
                  `;
                }
            }
            
            const photos = itemData.photosByType || {};
            const totalPhotos = (photos.segnaletica?.length || 0) + (photos.illuminazione?.length || 0) + (photos.vvf?.length || 0) + (photos.tem?.length || 0) + (photos.idranti?.length || 0);
            if (totalPhotos > 0) {
                metaHtml += `
                    <div class="meta-item">
                        <span class="meta-icon">📷</span>
                        <span>${totalPhotos} foto</span>
                    </div>
                `;
            }
            
            container.innerHTML = metaHtml;
        }

        
// Pagination helpers: mostra solo 10 nicchie per volta
function showPage(startIndex) {
  currentPageStart = startIndex;
  orderedItemIds.forEach((id, idx) => {
    const el = document.getElementById(`item-${id}`);
    if (!el) return;
    el.style.display = (idx >= currentPageStart && idx < currentPageStart + pageSize) ? 'block' : 'none';
  });
  updatePaginationUI();
}

function showNextPage() {
  const total = orderedItemIds.length;
  if (currentPageStart + pageSize >= total) {
    showToast("Nessun'altra nicchia da mostrare", 'success');
    return;
  }
  showPage(currentPageStart + pageSize);
  document.getElementById('checklist')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function updatePaginationUI() {
  const total = orderedItemIds.length;
  const start = currentPageStart;
  const end = Math.min(currentPageStart + pageSize, total);
  const shown = document.getElementById('shownCount');
  const btn = document.getElementById('loadMoreBtn');
  if (shown) shown.textContent = total ? `Mostrate ${start + 1}-${end} di ${total}` : 'Mostrate 0/0';
  if (btn) {
    if (end >= total) {
      btn.style.display = 'none';
    } else {
      btn.style.display = 'inline-flex';
      const nextEnd = Math.min(end + pageSize, total);
      btn.textContent = `+ Mostra altre 10 (${end + 1}-${nextEnd})`;
    }
  }
}

// Update progress
        function updateProgress() {
            const completed = checklistData.filter(item => item.completed).length;
            const total = checklistData.length;
            const percentage = Math.round((completed / total) * 100);
            
            document.getElementById('progressText').textContent = `${percentage}%`;
            document.getElementById('progressFill').style.width = `${percentage}%`;
            
            // Enable submit button if all completed
            const submitBtn = document.getElementById('submitBtn');
            const emailInput = document.getElementById('emailInput');
            submitBtn.disabled = !(emailInput.value && emailInput.value.includes('@'));
        }

        // Email validation
        document.getElementById('emailInput').addEventListener('input', updateProgress);

        // Update online status
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const statusEl = document.getElementById('onlineStatus');
            const statusText = document.getElementById('statusText');
            
            if (isOnline) {
                statusEl.className = 'status-badge status-online';
                statusText.textContent = 'Online';
            } else {
                statusEl.className = 'status-badge status-offline';
                statusText.textContent = 'Offline';
            }
        }

        // Submit report
        async function submitReport() {
            if (!isOnline) {
                showToast('Impossibile inviare: sei offline. Il report verrà salvato.', 'error');
                return;
            }
            
            const email = 'a.manduchi@rfi.it';
            if (!email || !email.includes('@')) {
                showToast('Inserisci un indirizzo email valido', 'error');
                return;
            }
            
            const report = generateReport();
            
            // In a real implementation, you would send this to a backend API
            // For this demo, we'll use mailto: as a fallback
            const subject = encodeURIComponent(`Report Checklist - ${new Date().toLocaleDateString('it-IT')}`);
            const body = encodeURIComponent(report);
            
            // Show success message
            showToast('Report generato! Apertura client email...', 'success');
            
            // Open mailto
            setTimeout(() => {
                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
            }, 1000);
            
            // Clear data after successful submission
            setTimeout(() => {
                if (confirm('Report inviato! Vuoi cancellare i dati locali?')) {
                    localStorage.removeItem('checklistData');
                    location.reload();
                }
            }, 2000);
        }

        // Generate report
        function generateReport() {
            let report = 'REPORT VERIFICA NICCHIE DI SICUREZZA GALLERIA\n';
            report += `Data Ispezione: ${new Date().toLocaleString('it-IT')}\n`;
            
            const directionText = selectedDirection === 'san_benedetto' 
                ? 'San Benedetto Val di Sambro (55+742)' 
                : 'Vernio (37+200)';
            report += `Direzione: Verso ${directionText}\n`;
            
            const totalNiches = checklistData.length;
            const completedNiches = checklistData.filter(i => i.completed).length;
            const needsMaintenance = checklistData.filter(i => {
                return i.checks?.segnaletica === 'non_conforme' || 
                       i.checks?.illuminazione === 'non_conforme' || 
                       i.checks?.camminamento === 'non_conforme' ||
                       i.checks?.corrimano === 'non_conforme' ||
                       i.checks?.vvf === 'non_conforme' ||
                       i.checks?.tem === 'non_conforme' ||
                       i.checks?.idranti === 'non_conforme';
            }).length;
            
            report += `Nicchie Verificate: ${completedNiches}/${totalNiches}\n`;
            report += `Nicchie Necessitano Manutenzione: ${needsMaintenance}\n`;
            report += `Percentuale Completamento: ${Math.round((completedNiches/totalNiches)*100)}%\n\n`;
            
            report += '='.repeat(60) + '\n\n';
            
            // Summary of maintenance needed
            const nichesNeedingMaintenance = checklistData.filter(i => {
                return i.checks?.segnaletica === 'non_conforme' || 
                       i.checks?.illuminazione === 'non_conforme' || 
                       i.checks?.camminamento === 'non_conforme' ||
                       i.checks?.corrimano === 'non_conforme' ||
                       i.checks?.vvf === 'non_conforme' ||
                       i.checks?.tem === 'non_conforme' ||
                       i.checks?.idranti === 'non_conforme';
            });
            
            if (nichesNeedingMaintenance.length > 0) {
                report += 'RIEPILOGO NICCHIE CHE NECESSITANO MANUTENZIONE\n\n';
                
                nichesNeedingMaintenance.forEach((item) => {
                    const niche = filteredNiches.find(n => n.id === item.id);
                    report += `📍 ${niche.km} - ${niche.binario}\n`;
                    
                    if (item.checks.segnaletica === 'non_conforme') {
                        const photoCount = item.photosByType?.segnaletica?.length || 0;
                        report += `   ⚠️ SEGNALETICA USCITE EMERGENZA - Non Conforme`;
                        if (photoCount > 0) report += ` (${photoCount} foto)`;
                        report += '\n';
                    }
                    
                    if (item.checks.illuminazione === 'non_conforme') {
                        const photoCount = item.photosByType?.illuminazione?.length || 0;
                        report += `   ⚠️ ILLUMINAZIONE EMERGENZA - Non Conforme`;
                        if (item.illuminazioneCount) {
                            report += ` (${item.illuminazioneCount} corpi non funzionanti)`;
                        }
                        if (photoCount > 0) report += ` - ${photoCount} foto`;
                        report += '\n';
                    }
                    
                    if (item.checks.camminamento === 'non_conforme') {
                        report += `   ⚠️ CAMMINAMENTO - Non Conforme\n`;
                    }
                    
                    if (item.checks.corrimano === 'non_conforme') {
                        report += `   ⚠️ CORRIMANO - Non Conforme\n`;
                    }
                    
                    if (item.checks.vvf === 'non_conforme') {
                        const photoCount = item.photosByType?.vvf?.length || 0;
                        report += `   ⚠️ ANTINCENDIO VV.F. (MANICHETTE + SEGNALETICA) - Assente / non conforme`;
                        if (photoCount > 0) report += ` (${photoCount} foto)`;
                        report += '\n';
                    }
                    
                    if (item.checks.tem === 'non_conforme') {
                        const photoCount = item.photosByType?.tem?.length || 0;
                        report += `   ⚠️ TELEFONIA TEM - Non Conforme`;
                        if (photoCount > 0) report += ` (${photoCount} foto)`;
                        report += '\n';
                    }
                    
                    if (item.checks.idranti === 'non_conforme') {
                        const photoCount = item.photosByType?.idranti?.length || 0;
                        report += `   ⚠️ IDRANTI - Non Conforme`;
                        if (photoCount > 0) report += ` (${photoCount} foto)`;
                        if (item.idrantiNotes) report += `\n      Note: ${item.idrantiNotes}`;
                        report += '\n';
                    }
                    
                    if (item.timestamp) {
                        report += `   Verificato: ${new Date(item.timestamp).toLocaleString('it-IT')}\n`;
                    }
                    report += '\n';
                });
                
                report += '='.repeat(60) + '\n\n';
            }
            
            // Detailed list
            report += 'DETTAGLIO COMPLETO NICCHIE\n\n';
            
            checklistData.forEach((item, index) => {
                const niche = filteredNiches.find(n => n.id === item.id);
                report += `${index + 1}. Km ${niche.km} - ${niche.binario}\n`;
                report += `   Stato: ${item.completed ? '✅ VERIFICATA' : '⏳ DA VERIFICARE'}\n`;
                
                if (item.checks) {
                    if (item.checks.segnaletica) {
                        const status = item.checks.segnaletica === 'conforme' ? '✅ Conforme' : '⚠️ Non Conforme';
                        report += `   Segnaletica Uscite Emergenza: ${status}\n`;
                    }
                    if (item.checks.illuminazione) {
                        const status = item.checks.illuminazione === 'conforme' ? '✅ Conforme' : '⚠️ Non Conforme';
                        report += `   Illuminazione Emergenza: ${status}`;
                        if (item.illuminazioneCount) {
                            report += ` (${item.illuminazioneCount} corpi non funzionanti)`;
                        }
                        report += '\n';
                    }
                    if (item.checks.camminamento) {
                        const status = item.checks.camminamento === 'conforme' ? '✅ Conforme' : '⚠️ Non Conforme';
                        report += `   Camminamento: ${status}\n`;
                    }
                    if (item.checks.corrimano) {
                        const status = item.checks.corrimano === 'conforme' ? '✅ Conforme' : '⚠️ Non Conforme';
                        report += `   Corrimano: ${status}\n`;
                    }
                    if (item.checks.vvf !== undefined && item.checks.vvf !== null && (filteredNiches.find(n => n.id === item.id)?.isVvfSpecial)) {
                        const status = item.checks.vvf === 'presente' ? '✅ Presente e segnaletica OK' : '⚠️ Assente / non conforme';
                        report += `   Antincendio VV.F. (manichette + segnaletica): ${status}\n`;
                    }
                    if (item.checks.tem !== undefined && item.checks.tem !== null && (filteredNiches.find(n => n.id === item.id)?.hasTEM)) {
                        const status = item.checks.tem === 'conforme' ? '✅ Conforme' : '⚠️ Non Conforme';
                        report += `   Telefonia TEM: ${status}\n`;
                    }
                    if (item.checks.idranti !== undefined && item.checks.idranti !== null && (filteredNiches.find(n => n.id === item.id)?.hasIdranti)) {
                        const status = item.checks.idranti === 'conforme' ? '✅ Conforme' : '⚠️ Non Conforme';
                        report += `   Idranti: ${status}`;
                        if (item.idrantiNotes) report += ` - Note: ${item.idrantiNotes}`;
                        report += '\n';
                    }
                }
                
                if (item.timestamp) {
                    report += `   Data Verifica: ${new Date(item.timestamp).toLocaleString('it-IT')}\n`;
                }
                
                const photos = item.photosByType || {};
                const totalPhotos = (photos.segnaletica?.length || 0) + (photos.illuminazione?.length || 0) + (photos.vvf?.length || 0) + (photos.tem?.length || 0) + (photos.idranti?.length || 0);
                if (totalPhotos > 0) {
                    report += `   Foto Allegate: ${totalPhotos}\n`;
                    if (photos.segnaletica?.length > 0) report += `     - Segnaletica: ${photos.segnaletica.length}\n`;
                    if (photos.illuminazione?.length > 0) report += `     - Illuminazione: ${photos.illuminazione.length}\n`;
                    if (photos.vvf?.length > 0) report += `     - VVF: ${photos.vvf.length}\n`;
                    if (photos.tem?.length > 0) report += `     - TEM: ${photos.tem.length}\n`;
                    if (photos.idranti?.length > 0) report += `     - Idranti: ${photos.idranti.length}\n`;
                    if (photos.general?.length > 0) report += `     - Generali: ${photos.general.length}\n`;
                }
                
                report += '\n';
            });
            
            report += '\n='.repeat(60) + '\n';
            report += 'Note Tecniche:\n';
            report += '- Segnaletica: Indica le uscite di emergenza in galleria\n';
            report += '- Illuminazione: Corpi illuminanti sopra corrimano a distanza 12,5m\n';
            report += '\nFine Report\n';
            report += `Generato da NicheSafe - ${new Date().toLocaleString('it-IT')}\n`;
            
            return report;
        }

        // Download functions
        function downloadTextFile() {
            const report = generateReport();
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `report-verifica-nicchie-${timestamp}.txt`;
            
            // Create blob and download
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('✓ Report TXT scaricato con successo!', 'success');
        }

        function downloadJsonFile() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `dati-checklist-${timestamp}.json`;
            
            // Prepare complete data export
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    appVersion: '1.0',
                    startNiche: selectedStartNiche || 'N/A',
                    direction: selectedDirection || 'N/A',
                    directionText: selectedDirection === 'san_benedetto' 
                        ? 'Verso San Benedetto Val di Sambro (55+742)' 
                        : selectedDirection === 'vernio' 
                        ? 'Verso Vernio (37+200)' 
                        : 'N/A'
                },
                statistics: {
                    totalNiches: checklistData.length,
                    completedNiches: checklistData.filter(i => i.completed).length,
                    needsMaintenance: checklistData.filter(i => {
                        return i.checks?.segnaletica === 'non_conforme' || 
                               i.checks?.illuminazione === 'non_conforme' || 
                               i.checks?.camminamento === 'non_conforme' ||
                               i.checks?.corrimano === 'non_conforme' ||
                               i.checks?.vvf === 'non_conforme' ||
                               i.checks?.tem === 'non_conforme' ||
                               i.checks?.idranti === 'non_conforme';
                    }).length
                },
                data: checklistData
            };
            
            // Create blob and download
            const json = JSON.stringify(exportData, null, 2);
            const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('✓ Dati JSON scaricati con successo!', 'success');
        }

        // LocalStorage functions
        function saveToLocalStorage() {
            localStorage.setItem('checklistData', JSON.stringify(checklistData));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('checklistData');
            if (saved) {
                const savedData = JSON.parse(saved);
                
                savedData.forEach(savedItem => {
                    const item = checklistData.find(i => i.id === savedItem.id);
                    if (item) {
                        Object.assign(item, savedItem);
                        const niche = filteredNiches.find(n => n.id === item.id);
                        
                        // Ensure checks object exists with all types
                        if (!item.checks) {
                            item.checks = {
                                segnaletica: null,
                                illuminazione: null,
                                vvf: niche?.isVvfSpecial ? null : undefined,
                                tem: niche?.hasTEM ? null : undefined,
                                idranti: niche?.hasIdranti ? null : undefined,
                                camminamento: null,
                                corrimano: null
                            };
                        }
                        
                        // Ensure photosByType exists
                        if (!item.photosByType) {
                            item.photosByType = {
                                segnaletica: [],
                                illuminazione: [],
                                vvf: [],
                                tem: [],
                                idranti: [],
                                general: []
                            };
                        }
                        
                        // Ensure needsPhoto exists
                        if (!item.needsPhoto) {
                            item.needsPhoto = {
                                segnaletica: false,
                                illuminazione: false,
                                vvf: false,
                                tem: false,
                                idranti: false
                            };
                        }
                        
                        // Update UI - Segnaletica
                        if (item.checks.segnaletica) {
                            const radio = document.querySelector(`input[name="segnaletica-${item.id}"][value="${item.checks.segnaletica}"]`);
                            if (radio) {
                                radio.checked = true;
                                const label = radio.closest('.radio-label');
                                if (label) label.style.borderColor = 'var(--primary)';
                                
                                if (item.checks.segnaletica === 'non_conforme') {
                                    const photoBtn = document.getElementById(`photo-btn-seg-${item.id}`);
                                    if (photoBtn) photoBtn.style.display = 'block';
                                }
                            }
                        }
                        
                        // Update UI - Illuminazione
                        if (item.checks.illuminazione) {
                            const radio = document.querySelector(`input[name="illuminazione-${item.id}"][value="${item.checks.illuminazione}"]`);
                            if (radio) {
                                radio.checked = true;
                                const label = radio.closest('.radio-label');
                                if (label) label.style.borderColor = 'var(--primary)';
                                
                                if (item.checks.illuminazione === 'non_conforme') {
                                    const countDiv = document.getElementById(`illum-count-${item.id}`);
                                    if (countDiv) countDiv.style.display = 'block';
                                    const countInput = document.getElementById(`illum-count-input-${item.id}`);
                                    if (countInput && item.illuminazioneCount) countInput.value = item.illuminazioneCount;
                                    const photoBtn = document.getElementById(`photo-btn-ill-${item.id}`);
                                    if (photoBtn) photoBtn.style.display = 'block';
                                }
                            }
                        }
                        
                        // Update UI - Camminamento
                        if (item.checks.camminamento) {
                            const radio = document.querySelector(`input[name="camminamento-${item.id}"][value="${item.checks.camminamento}"]`);
                            if (radio) {
                                radio.checked = true;
                                const label = radio.closest('.radio-label');
                                if (label) label.style.borderColor = 'var(--primary)';
                            }
                        }
                        
                        // Update UI - Corrimano
                        if (item.checks.corrimano) {
                            const radio = document.querySelector(`input[name="corrimano-${item.id}"][value="${item.checks.corrimano}"]`);
                            if (radio) {
                                radio.checked = true;
                                const label = radio.closest('.radio-label');
                                if (label) label.style.borderColor = 'var(--primary)';
                            }
                        }
                        
                        // Update UI - VVF
                        if (item.checks.vvf && niche?.isVvfSpecial) {
                            const radio = document.querySelector(`input[name="vvf-${item.id}"][value="${item.checks.vvf}"]`);
                            if (radio) {
                                radio.checked = true;
                                const label = radio.closest('.radio-label');
                                if (label) label.style.borderColor = 'var(--primary)';
                                
                                if (item.checks.vvf === 'non_conforme') {
                                    const photoBtn = document.getElementById(`photo-btn-vvf-${item.id}`);
                                    if (photoBtn) photoBtn.style.display = 'block';
                                }
                            }
                        }
                        
                        // Update UI - TEM
                        if (item.checks.tem && niche?.hasTEM) {
                            const radio = document.querySelector(`input[name="tem-${item.id}"][value="${item.checks.tem}"]`);
                            if (radio) {
                                radio.checked = true;
                                const label = radio.closest('.radio-label');
                                if (label) label.style.borderColor = 'var(--primary)';
                                
                                if (item.checks.tem === 'non_conforme') {
                                    const photoBtn = document.getElementById(`photo-btn-tem-${item.id}`);
                                    if (photoBtn) photoBtn.style.display = 'block';
                                }
                            }
                        }
                        
                        // Update UI - Idranti
                        if (item.checks.idranti && niche?.hasIdranti) {
                            const radio = document.querySelector(`input[name="idranti-${item.id}"][value="${item.checks.idranti}"]`);
                            if (radio) {
                                radio.checked = true;
                                const label = radio.closest('.radio-label');
                                if (label) label.style.borderColor = 'var(--primary)';
                                
                                if (item.checks.idranti === 'non_conforme') {
                                    const notesDiv = document.getElementById(`idranti-notes-${item.id}`);
                                    if (notesDiv) notesDiv.style.display = 'block';
                                    const notesInput = document.getElementById(`idranti-notes-input-${item.id}`);
                                    if (notesInput && item.idrantiNotes) notesInput.value = item.idrantiNotes;
                                    const photoBtn = document.getElementById(`photo-btn-idranti-${item.id}`);
                                    if (photoBtn) photoBtn.style.display = 'block';
                                }
                            }
                        }
                        
                        const itemEl = document.getElementById(`item-${item.id}`);
                        if (item.completed) {
                            itemEl.classList.add('completed');
                        }
                        
                        updateMeta(item.id);
                        displayPhotos(item.id);
                    }
                });
                
                updateProgress();
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.error('Service Worker registration failed:', err));
        }
    </script>
</body>
</html>
