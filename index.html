<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f172a">
    <title>NicheSafe - Verifica Nicchie Galleria</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NicheSafe">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #334155;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(34, 197, 94, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
            position: relative;
            z-index: 1;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            animation: slideDown 0.6s ease-out;
        }
        
        .logo {
            font-family: 'Syne', sans-serif;
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }
        
        .tagline {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        /* Status bar */
        .status-bar {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
            animation: fadeIn 0.6s ease-out 0.2s both;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border-radius: 2rem;
            font-size: 0.875rem;
            border: 1px solid var(--border);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .status-online .status-dot {
            background: var(--accent);
        }
        
        .status-offline .status-dot {
            background: var(--warning);
        }
        
        /* Card */
        .card {
            background: var(--bg-card);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            animation: slideUp 0.6s ease-out 0.3s both;
        }
        
        .section-title {
            font-family: 'Syne', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .section-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        /* Checklist items */

 /* Track alignment */
 .check-item.track-d { transform: translateX(-10px); }
 .check-item.track-p { transform: translateX(10px); }
 .check-item.track-d:hover { transform: translateX(-6px); }
 .check-item.track-p:hover { transform: translateX(14px); }
 @media (max-width: 640px) {
  .check-item.track-d, .check-item.track-p { transform: none; }
  .check-item.track-d:hover, .check-item.track-p:hover { transform: translateX(2px); }
 }

 /* VVF section */
 .vvf-badge {
  display:inline-flex;
  align-items:center;
  gap:0.4rem;
  padding:0.2rem 0.55rem;
  border-radius:999px;
  font-size:0.75rem;
  font-weight:700;
  background: rgba(245,158,11,0.12);
  border: 1px solid rgba(245,158,11,0.35);
  color: var(--warning);
 }

        .checklist {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .check-item {
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .check-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .check-item.completed::before {
            transform: scaleY(1);
        }
        
        .check-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }
        
        .check-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .checkbox-wrapper {
            position: relative;
            width: 28px;
            height: 28px;
            flex-shrink: 0;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            width: 100%;
            height: 100%;
            cursor: pointer;
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
        }
        
        .checkbox-custom {
            width: 100%;
            height: 100%;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            position: absolute;
            top: 0;
            left: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .checkbox-wrapper input[type="checkbox"]:checked + .checkbox-custom {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-color: var(--accent);
        }
        
        .checkbox-custom::after {
            content: '‚úì';
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
        }
        
        .checkbox-wrapper input[type="checkbox"]:checked + .checkbox-custom::after {
            opacity: 1;
            transform: scale(1);
        }
        
        .check-content {
            flex: 1;
        }
        
        .check-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .check-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .check-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .meta-icon {
            width: 20px;
            height: 20px;
            opacity: 0.7;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            font-weight: 700;
            padding: 1rem 2rem;
            font-size: 1rem;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Photo preview */
        .photo-preview {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .photo-thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 0.5rem;
            object-fit: cover;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .photo-thumbnail:hover {
            transform: scale(1.1);
            border-color: var(--primary);
        }
        
        /* Progress bar */
        .progress-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .progress-label {
            font-weight: 700;
        }
        
        .progress-percentage {
            color: var(--accent);
            font-weight: 700;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--bg-dark);
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 1rem;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        /* Submit section */
        .submit-section {
            margin-top: 2rem;
            text-align: center;
        }
        
        .email-input {
            width: 100%;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 2px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .email-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            transform: translateY(200%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 350px;
        }
        
        .toast.show {
            transform: translateY(0);
        }
        
        .toast.success {
            border-color: var(--accent);
        }
        
        .toast.error {
            border-color: var(--danger);
        }
        
        /* Animations */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        /* Responsive */
        @media (max-width: 640px) {
            .logo {
                font-size: 2rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .check-item {
                padding: 1rem;
            }
            
            .toast {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
                max-width: none;
            }
        }
        
        /* Hidden input */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Start Screen -->
        <div id="startScreen" class="card" style="display: block;">
            <header class="header">
                <h1 class="logo">üìç NicheSafe</h1>
                <p class="tagline">Verifica Nicchie di Sicurezza Galleria Ferroviaria</p>
            </header>
            
            <h2 class="section-title" style="margin-top: 2rem;">
                <span class="section-icon">üöÄ</span>
                Inizia Verifica
            </h2>
            
            <div style="margin-bottom: 2rem;">
                <label style="display: block; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">
                    Da quale nicchia vuoi iniziare?
                </label>
                <select id="startNiche" class="email-input" style="cursor: pointer;">
                    <option value="">-- Seleziona nicchia di partenza --</option>
                </select>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <label style="display: block; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">
                    In quale direzione stai andando?
                </label>
                <select id="direction" class="email-input" style="cursor: pointer;">
                    <option value="">-- Seleziona direzione --</option>
                    <option value="san_benedetto">‚¨ÜÔ∏è Verso San Benedetto Val di Sambro (55+742)</option>
                    <option value="vernio">‚¨áÔ∏è Verso Vernio (37+200)</option>
                </select>
            </div>
            
            <div style="text-align: center;">
                <button class="btn btn-primary" id="startBtn" disabled>
                    <span>‚ñ∂Ô∏è</span>
                    <span>Inizia Verifica</span>
                </button>
            </div>
        </div>
        
        <!-- Main Screen -->
        <div id="mainScreen" style="display: none;">
        <header class="header">
            <h1 class="logo">NicheSafe</h1>
            <p class="tagline">Verifica Apprestamenti Tecnologici Galleria Ferroviaria</p>
        </header>
        
        <div class="status-bar">
            <div class="status-badge" id="onlineStatus">
                <span class="status-dot"></span>
                <span id="statusText">Controllo connessione...</span>
            </div>
            <div class="status-badge">
                <span id="directionInfo">Direzione non impostata</span>
            </div>
        </div>
        
        <div class="card">
            <h2 class="section-title">
                <span class="section-icon">üìã</span>
                Apprestamenti da Verificare
            </h2>
            
            <div class="checklist" id="checklist">
                <!-- Items will be added here -->
            </div>

 <div id="paginationControls" style="margin-top: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
  <button class="btn btn-secondary" id="loadMoreBtn" type="button" style="min-width: 220px; justify-content: center;">
    Mostra altre 10
  </button>
  <div id="shownCount" style="color: var(--text-secondary); font-size: 0.9rem;">
    Mostrate 0/0
  </div>
 </div>

            
            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-label">Progresso</span>
                    <span class="progress-percentage" id="progressText">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="submit-section">
  <div style="margin-bottom: 0.75rem; color: var(--text-secondary); font-size: 0.95rem;">
    üì© Destinatario report: <b id="fixedRecipient">a.manduchi@rfi.it</b>
  </div>
  <input type="email" class="email-input hidden" id="emailInput" value="a.manduchi@rfi.it">
  <button class="btn btn-primary" id="submitBtn">
                    <span>Invia Report via Email</span>
                </button>
</div>
        </div>
        </div> <!-- end mainScreen -->
    </div> <!-- end container -->
    
    <!-- Fixed Floating Malfunction Button -->
    <button id="floatingMalfunctionBtn" onclick="openMalfunctionModal()" 
            onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 6px 16px rgba(0, 0, 0, 0.4)'; document.getElementById('btnTooltip').style.opacity='1'" 
            onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.3)'; document.getElementById('btnTooltip').style.opacity='0'"
            style="display: none; position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--danger); color: white; border: none; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); cursor: pointer; z-index: 999; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: all 0.3s; font-weight: bold;">
        !
        <div style="position: absolute; bottom: 70px; right: 0; background: var(--bg-card); color: var(--text-primary); padding: 0.5rem 1rem; border-radius: 0.5rem; white-space: nowrap; font-size: 0.875rem; font-weight: normal; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); opacity: 0; pointer-events: none; transition: opacity 0.3s;" id="btnTooltip">
            Segnala Malfunzionamento
        </div>
    </button>
    
    <!-- Malfunction Modal -->
    <div id="malfunctionModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 1000; overflow-y: auto; padding: 1rem;">
        <div style="max-width: 600px; margin: 2rem auto; background: var(--bg-card); border-radius: 1.5rem; padding: 2rem; border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-family: 'Syne', sans-serif; font-size: 1.5rem; margin: 0;">Segnala Malfunzionamento</h2>
                <button onclick="closeMalfunctionModal()" style="background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; transition: background 0.3s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='none'">‚úï</button>
            </div>
            
            <!-- Tipo di malfunzionamento -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 700; margin-bottom: 0.75rem; color: var(--text-primary);">Tipo di Malfunzionamento</label>
                <div style="display: grid; gap: 0.75rem;">
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--bg-dark); border-radius: 0.75rem; border: 2px solid transparent; cursor: pointer; transition: all 0.3s;" class="malfunction-type-label">
                        <input type="radio" name="malfunctionType" value="camminamento" style="width: 20px; height: 20px; cursor: pointer;" onchange="handleMalfunctionTypeChange()">
                        <div>
                            <div style="font-weight: 600;">Camminamento</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Foto obbligatoria + progressiva chilometrica</div>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--bg-dark); border-radius: 0.75rem; border: 2px solid transparent; cursor: pointer; transition: all 0.3s;" class="malfunction-type-label">
                        <input type="radio" name="malfunctionType" value="corrimano" style="width: 20px; height: 20px; cursor: pointer;" onchange="handleMalfunctionTypeChange()">
                        <div>
                            <div style="font-weight: 600;">Corrimano</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Foto obbligatoria + progressiva chilometrica</div>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--bg-dark); border-radius: 0.75rem; border: 2px solid transparent; cursor: pointer; transition: all 0.3s;" class="malfunction-type-label">
                        <input type="radio" name="malfunctionType" value="segnaletica_uscita" style="width: 20px; height: 20px; cursor: pointer;" onchange="handleMalfunctionTypeChange()">
                        <div>
                            <div style="font-weight: 600;">Segnaletica di Uscita</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Foto obbligatoria + progressiva chilometrica</div>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--bg-dark); border-radius: 0.75rem; border: 2px solid transparent; cursor: pointer; transition: all 0.3s;" class="malfunction-type-label">
                        <input type="radio" name="malfunctionType" value="illuminazione" style="width: 20px; height: 20px; cursor: pointer;" onchange="handleMalfunctionTypeChange()">
                        <div>
                            <div style="font-weight: 600;">Impianto di Illuminazione</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Specifica tipo guasto + progressiva chilometrica</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Lighting specific fields (conditional) -->
            <div id="lightingFields" style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-dark); border-radius: 0.75rem; border: 1px solid var(--border);">
                <label style="display: block; font-weight: 700; margin-bottom: 0.75rem; color: var(--text-primary);">Tipo di Guasto Illuminazione</label>
                <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="lightingType" value="fungo_blu" style="width: 20px; height: 20px; cursor: pointer;">
                        <span>Fungo Blu</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="lightingType" value="corpi_illuminanti" style="width: 20px; height: 20px; cursor: pointer;" onchange="handleLightingTypeChange()">
                        <span>Corpi Illuminanti</span>
                    </label>
                </div>
                <div id="lightingBodyCount" style="display: none;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">Numero di corpi non funzionanti</label>
                    <input type="number" id="bodyCount" min="1" style="width: 100%; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text-primary); font-size: 1rem;">
                </div>
            </div>
            
            <!-- Progressiva chilometrica (always shown when type selected) -->
            <div id="kmFields" style="display: none; margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">Progressiva Chilometrica *</label>
                <input type="text" id="kmMarker" placeholder="es. 45+234" style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text-primary); font-size: 1rem;">
            </div>
            
            <!-- Photo capture (conditional - not for lighting) -->
            <div id="photoFields" style="display: none; margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 700; margin-bottom: 0.75rem; color: var(--text-primary);">Foto del Malfunzionamento *</label>
                <button onclick="captureMalfunctionPhoto()" class="btn btn-secondary" style="width: 100%; justify-content: center;">
                    Scatta Foto
                </button>
                <div id="malfunctionPhotoPreview" style="margin-top: 0.75rem;"></div>
            </div>
            
            <!-- Note aggiuntive -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">Note Aggiuntive (opzionale)</label>
                <textarea id="malfunctionNotes" rows="3" placeholder="Descrivi eventuali dettagli aggiuntivi..." style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text-primary); font-size: 1rem; resize: vertical; font-family: inherit;"></textarea>
            </div>
            
            <!-- Actions -->
            <div style="display: flex; gap: 0.75rem;">
                <button onclick="closeMalfunctionModal()" class="btn btn-secondary" style="flex: 1;">Annulla</button>
                <button onclick="saveMalfunctionReport()" class="btn btn-primary" style="flex: 1;">Salva Segnalazione</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <!-- Hidden file input for camera -->
    <input type="file" accept="image/*" capture="environment" class="hidden" id="cameraInput">
    <!-- Hidden file input for malfunction photos -->
    <input type="file" accept="image/*" capture="environment" class="hidden" id="malfunctionCameraInput">

    <script>
        // Configuration - Railway Niches Data
        const NICHES_RAW_DATA = `55+742 D
55+675 D
55+650 P
55+650 D
55+625 D
55+600 P
55+575 D
55+550 P
55+550 D
55+525 D
55+500 P
55+492 D
55+475 D
55+450 P
55+425 D
55+400 P
55+375 D
55+350 P
55+325 D
55+300 P
55+275 D
55+250 P
55+225 D
55+200 P
55+175 D
55+150 P
55+125 D
55+100 P
55+075 D
55+050 P
55+024 D
55+000 P
54+974 D
54+949 P
54+924 D
54+899 P
54+874 D
54+849 P
54+824 D
54+799 P
54+774 D
54+749 P
54+724 D
54+699 P
54+674 P
54+674 D
54+649 P
54+624 D
54+599 P
54+574 D
54+549 P
54+524 D
54+499 P
54+474 D
54+449 P
54+424 D
54+399 P
54+374 D
54+349 P
54+324 D
54+299 P
54+274 D
54+249 P
54+224 D
54+199 P
54+174 D
54+149 P
54+124 D
54+099 P
54+074 D
54+049 P
54+024 D
53+999 P
53+973 D
53+947 P
53+923 D
53+897 P
53+873 D
53+847 P
53+823 D
53+797 P
53+773 D
53+747 P
53+723 D
53+697 P
53+673 D
53+647 P
53+623 P
53+623 D
53+597 P
53+573 D
53+547 P
53+523 D
53+497 P
53+473 D
53+447 P
53+423 D
53+397 P
53+373 D
53+347 P
53+323 D
53+297 P
53+273 D
53+247 P
53+223 D
53+197 P
53+173 D
53+147 P
53+123 D
53+097 P
53+073 D
53+047 P
53+023 D
52+997 P
52+973 D
52+947 P
52+921 D
52+896 P
52+871 D
52+846 P
52+821 D
52+796 P
52+771 D
52+746 P
52+721 D
52+696 P
52+671 D
52+646 P
52+634 D
52+621 D
52+596 P
52+571 D
52+546 P
52+521 D
52+496 P
52+471 D
52+446 P
52+421 D
52+396 P
52+371 D
52+346 P
52+321 D
52+296 P
52+271 D
52+246 P
52+221 D
52+196 P
52+171 D
52+146 P
52+121 D
52+096 P
52+071 D
52+046 P
52+021 D
51+994 P
51+969 D
51+944 P
51+919 D
51+894 P
51+869 D
51+844 P
51+819 D
51+794 P
51+769 D
51+744 P
51+719 D
51+694 P
51+669 D
51+644 P
51+619 D
51+617 P
51+594 P
51+569 D
51+544 P
51+519 D
51+494 P
51+469 D
51+444 P
51+419 D
51+394 P
51+369 D
51+344 P
51+319 D
51+274 P
51+269 D
51+244 P
51+219 D
51+194 P
51+169 D
51+144 P
51+119 D
51+094 P
51+069 D
51+044 P
51+019 D
50+994 P
50+970 D
50+945 P
50+921 D
50+871 D
50+845 P
50+821 D
50+795 P
50+771 D
50+721 D
50+696 P
50+671 D
50+647 P
50+622 D
50+597 P
50+572 D
50+547 P
50+522 D
50+477 P
50+472 D
50+447 P
50+422 D
50+397 P
50+372 D
50+347 P
50+322 D
50+278 P
50+273 D
50+248 P
50+223 D
50+198 P
50+173 D
50+148 P
50+123 D
50+098 P
50+073 D
50+048 P
50+023 D
49+998 P
49+973 D
49+949 P
49+924 D
49+899 P
49+874 D
49+849 P
49+824 D
49+799 P
49+774 D
49+749 P
49+724 D
49+699 P
49+674 D
49+649 P
49+624 D
49+574 D
49+549 P
49+524 D
49+499 P
49+474 D
49+449 P
49+424 D
49+399 P
49+374 D
49+349 P
49+324 D
49+299 P
49+274 D
49+249 P
49+224 D
49+199 P
49+174 D
49+149 P
49+124 D
49+099 P
49+074 D
49+054 P
49+024 D
48+999 P
48+974 D
48+949 P
48+924 D
48+899 P
48+874 D
48+849 P
48+824 D
48+799 P
48+774 D
48+749 P
48+724 D
48+699 P
48+674 D
48+649 P
48+624 D
48+599 P
48+574 D
48+549 P
48+524 D
48+499 P
48+474 D
48+449 P
48+424 P
48+424 D
48+399 P
48+374 D
48+349 P
48+324 D
48+299 P
48+274 D
48+249 P
48+224 D
48+199 P
48+174 D
48+149 P
48+124 D
48+099 P
48+074 D
48+049 P
48+024 D
47+999 P
47+974 D
47+949 P
47+924 D
47+899 P
47+874 D
47+849 P
47+824 D
47+799 P
47+774 D
47+724 P
47+724 D
47+699 P
47+674 D
47+649 P
47+624 D
47+599 P
47+574 D
47+549 P
47+524 P
47+524 D
47+499 P
47+474 D
47+348 D
47+323 P
47+298 D
47+273 P
47+248 D
47+223 P
47+198 D
47+173 P
47+153 D
47+123 P
47+100 D
47+075 P
47+050 D
47+025 P
47+001 D
46+975 P
46+951 D
46+921 P
46+848 D
46+855 P
46+800 P
46+781 D
46+747 P
46+731 D
46+697 P
46+681 D
46+647 P
46+631 D
46+597 P
46+581 D
46+547 P
46+531 D
46+497 P
46+481 D
46+447 P
46+431 D
46+397 P
46+381 D
46+366 P
46+232 P
46+208 P
46+184 D
46+158 P
46+134 D
46+108 P
46+064 D
46+058 P
46+034 D
46+008 P
45+985 D
45+958 P
45+935 D
45+908 P
45+886 D
45+858 P
45+836 D
45+808 P
45+786 D
45+758 P
45+733 D
45+708 P
45+683 D
45+658 P
45+633 D
45+608 P
45+583 D
45+558 P
45+533 D
45+508 P
45+483 D
45+483 P
45+458 P
45+433 D
45+408 P
45+383 D
45+358 P
45+333 D
45+308 P
45+283 D
45+258 P
45+233 D
45+208 P
45+183 D
45+158 P
45+133 D
45+108 P
45+083 D
45+058 P
45+033 D
45+008 P
44+983 D
44+958 P
44+933 D
44+908 P
44+883 D
44+858 P
44+833 D
44+808 P
44+783 D
44+758 P
44+733 D
44+708 P
44+683 D
44+658 P
44+633 D
44+608 P
44+583 D
44+558 P
44+533 D
44+508 P
44+486 D
44+458 P
44+436 D
44+408 P
44+388 D
44+363 P
44+338 D
44+319 P
44+294 P
44+288 D
44+269 P
44+238 D
44+219 P
44+188 D
44+169 P
44+138 D
44+119 P
44+088 D
44+069 P
44+038 D
44+019 P
43+988 D
43+969 P
43+938 D
43+919 P
43+888 D
43+869 P
43+838 D
43+813 P
43+788 D
43+763 P
43+738 D
43+713 P
43+688 D
43+663 P
43+638 D
43+613 P
43+588 D
43+563 P
43+538 D
43+513 P
43+488 D
43+463 P
43+438 D
43+413 P
43+388 D
43+363 P
43+333 D
43+313 P
43+288 D
43+263 P
43+238 D
43+213 P
43+188 D
43+163 P
43+138 D
43+113 P
43+088 D
43+088 P
43+038 D
43+013 P
42+988 D
42+963 P
42+938 D
42+913 P
42+888 D
42+863 P
42+838 D
42+813 P
42+788 D
42+763 P
42+738 D
42+713 P
42+686 D
42+663 P
42+638 D
42+613 P
42+588 D
42+563 P
42+538 D
42+513 P
42+488 D
42+463 P
42+438 D
42+413 P
42+388 D
42+363 P
42+338 D
42+313 P
42+288 D
42+263 P
42+238 D
42+231 P
42+188 D
42+163 P
42+138 D
42+113 P
42+088 D
42+063 P
42+038 D
42+013 P
41+987 D
41+963 P
41+937 D
41+913 P
41+890 P
41+886 D
41+863 P
41+836 D
41+813 P
41+786 D
41+757 P
41+738 D
41+713 P
41+688 D
41+663 P
41+638 D
41+613 P
41+585 D
41+563 P
41+535 D
41+513 P
41+484 D
41+463 P
41+434 D
41+413 P
41+381 D
41+363 P
41+333 D
41+313 P
41+283 D
41+259 P
41+232 D
41+213 P
41+182 D
41+163 P
41+113 P
41+082 D
41+063 P
41+032 D
41+013 P
40+988 D
40+983 P
40+963 P
40+932 D
40+913 P
40+882 D
40+863 P
40+832 D
40+813 P
40+782 D
40+763 P
40+732 D
40+713 P
40+668 D
40+663 P
40+638 D
40+613 P
40+588 D
40+563 P
40+538 D
40+513 P
40+488 D
40+463 P
40+438 D
40+413 P
40+388 D
40+363 P
40+338 D
40+313 P
40+288 D
40+263 P
40+238 D
40+213 P
40+188 D
40+163 P
40+138 D
40+113 P
40+088 D
40+063 P
40+038 D
40+013 P
39+988 D
39+963 P
39+938 D
39+913 P
39+888 P
39+888 D
39+863 P
39+838 D
39+813 P
39+788 D
39+763 P
39+738 D
39+713 P
39+688 D
39+663 P
39+638 D
39+613 P
39+588 D
39+563 P
39+538 D
39+513 P
39+488 D
39+463 P
39+438 D
39+413 P
39+388 D
39+363 P
39+338 D
39+313 P
39+288 D
39+263 P
39+238 D
39+213 P
39+188 D
39+163 P
39+113 P
39+088 D
39+063 P
39+038 D
39+013 P
38+988 D
38+963 P
38+938 D
38+903 P
38+888 D
38+863 P
38+838 D
38+813 P
38+788 P
38+788 D
38+763 P
38+738 D
38+713 P
38+688 D
38+663 P
38+638 D
38+613 P
38+588 D
38+563 P
38+538 D
38+513 P
38+488 D
38+463 P
38+438 D
38+413 P
38+388 D
38+363 P
38+338 D
38+313 P
38+288 D
38+263 P
38+238 D
38+213 P
38+188 D
38+163 P
38+138 D
38+113 P
38+088 D
38+063 P
38+038 D
38+013 P
37+988 D
37+963 P
37+938 D
37+913 P
37+888 D
37+863 P
37+838 D
37+813 P
37+788 D
37+763 P
37+738 D
37+713 P
37+688 D
37+663 P
37+638 D
37+613 P
37+588 D
37+563 P
37+538 D
37+512 P
37+486 D
37+463 P
37+435 D
37+413 P
37+383 D
37+363 P
37+333 D
37+313 P
37+293 P
37+284 D
37+259 P`;

        // Parse niches data
 // Nicchie con apprestamenti tecnologici
 // Solo queste nicchie devono essere verificate
 const TECHNOLOGICAL_FACILITIES = {
  // Idranti VVF (VVF Hydrants)
  'idranti_vvf': new Set([
   // Binario D
   '55+575 D', '55+425 D', '55+275 D', '55+175 D', '55+024 D', '54+874 D', '54+774 D', 
   '54+674 D', '54+574 D', '54+424 D', '54+324 D', '54+174 D', '54+024 D', '53+773 D', 
   '53+623 D', '53+473 D', '53+373 D', '53+223 D', '53+073 D', '52+921 D', '52+771 D', 
   '52+671 D', '52+521 D', '52+371 D', '52+221 D', '52+121 D', '51+969 D', '51+869 D', 
   '51+719 D', '51+619 D', '51+469 D', '51+319 D', '51+169 D', '51+019 D', '50+871 D', 
   '50+721 D', '50+572 D', '50+472 D', '50+322 D', '50+223 D', '50+073 D', '49+973 D', 
   '49+824 D', '49+674 D', '49+524 D', '49+374 D', '49+224 D', '49+074 D', '48+924 D', 
   '48+824 D', '48+674 D', '48+574 D', '48+524 D', '48+424 D', '48+324 D', '48+224 D', 
   '48+074 D', '47+924 D', '47+824 D',
   // Binario P
   '47+724 P', '47+649 P', '47+524 P', '47+273 P', '47+173 P', '47+025 P', '46+697 P', 
   '46+597 P', '46+447 P', '46+208 P', '46+058 P', '45+908 P', '45+758 P', '45+658 P', 
   '45+508 P', '45+408 P', '45+308 P', '45+158 P', '45+058 P'
  ]),
  // Colonnine TEM (TEM Columns)
  'colonnine_tem': new Set([
   // Binario D
   '55+475 D', '55+024 D', '54+524 D', '54+024 D', '53+523 D', '53+023 D', '52+521 D', 
   '52+471 D', '51+469 D', '51+419 D', '50+622 D', '50+572 D', '49+674 D', '49+624 D', 
   '49+574 D', '48+074 D', '47+574 D', '47+050 D', '46+431 D', '45+786 D', '45+283 D', 
   '45+033 D', '44+533 D', '44+038 D', '43+488 D', '42+988 D', '42+538 D', '42+038 D', 
   '41+786 D', '41+333 D', '40+832 D', '40+338 D', '40+088 D', '39+538 D', '39+038 D', 
   '38+588 D', '38+038 D', '37+538 D',
   // Binario P
   '55+742 P', '55+400 P', '55+150 P', '54+899 P', '54+599 P', '54+349 P', '54+099 P', 
   '53+847 P', '53+597 P', '53+347 P', '53+097 P', '52+846 P', '52+646 P', '52+396 P', 
   '52+146 P', '51+894 P', '51+644 P', '51+394 P', '51+144 P', '50+845 P', '50+647 P', 
   '50+397 P', '50+098 P', '49+849 P', '49+549 P', '49+349 P', '49+099 P', '48+849 P', 
   '48+649 P', '48+449 P', '48+249 P', '47+799 P', '47+649 P', '47+499 P', '47+223 P', 
   '46+855 P', '46+800 P', '46+497 P', '46+232 P', '45+958 P', '45+708 P', '45+458 P', 
   '45+258 P', '44+958 P', '44+708 P', '44+458 P', '44+219 P', '44+019 P', '43+813 P', 
   '43+563 P', '43+313 P', '43+088 P', '42+813 P', '42+563 P', '42+313 P', '42+063 P', 
   '41+757 P', '41+513 P', '41+259 P', '41+013 P', '40+763 P', '40+513 P', '40+263 P', 
   '40+013 P', '39+763 P', '39+563 P', '39+313 P', '39+113 P', '38+863 P', '38+663 P', 
   '38+413 P', '38+163 P', '37+913 P', '37+663 P', '37+413 P', '37+259 P'
  ]),
  // Quadri di soccorso VVF (VVF Emergency Panels)
  'quadri_soccorso_vvf': new Set([
   // Solo Binario D
   '55+742 D', '55+400 D', '55+150 D', '54+899 D', '54+599 D', '54+349 D', '54+099 D', 
   '53+847 D', '53+597 D', '53+347 D', '53+097 D', '52+846 D', '52+646 D', '52+396 D', 
   '52+146 D', '51+894 D', '51+644 D', '51+394 D', '51+144 D', '50+845 D', '50+647 D', 
   '50+397 D', '50+098 D', '49+849 D', '49+549 D', '49+349 D', '49+099 D', '48+849 D', 
   '48+649 D', '48+449 D', '48+249 D', '47+799 D', '47+649 D', '47+499 D', '47+223 D', 
   '46+855 D', '46+800 D', '46+497 D', '46+232 D', '45+958 D', '45+708 D', '45+458 D', 
   '45+258 D', '44+958 D', '44+708 D', '44+458 D', '44+219 D', '44+019 D', '43+813 D', 
   '43+563 D', '43+313 D', '43+088 D', '42+813 D', '42+563 D', '42+313 D', '42+063 D', 
   '41+757 D', '41+513 D', '41+259 D', '41+013 D', '40+763 D', '40+513 D', '40+263 D', 
   '40+013 D', '39+763 D', '39+563 D', '39+313 D', '39+113 D', '38+863 D', '38+663 D', 
   '38+413 D', '38+163 D', '37+913 D', '37+663 D', '37+413 D', '37+259 D'
  ])
 };

 // Helper function to get facility type for a niche
 function getFacilityType(km, binario) {
  const key = `${km} ${binario}`;
  if (TECHNOLOGICAL_FACILITIES.idranti_vvf.has(key)) return 'idranti_vvf';
  if (TECHNOLOGICAL_FACILITIES.colonnine_tem.has(key)) return 'colonnine_tem';
  if (TECHNOLOGICAL_FACILITIES.quadri_soccorso_vvf.has(key)) return 'quadri_soccorso_vvf';
  return null;
 }

 // Helper function to get facility label
 function getFacilityLabel(facilityType) {
  const labels = {
   'idranti_vvf': 'Idranti VVF',
   'colonnine_tem': 'Colonnine TEM',
   'quadri_soccorso_vvf': 'Quadri di soccorso VVF'
  };
  return labels[facilityType] || '';
 }

        const CHECKLIST_ITEMS = NICHES_RAW_DATA.split('\n')
            .map((line, index) => {
                const parts = line.trim().split(' ');
                if (parts.length === 2) {
                    const facilityType = getFacilityType(parts[0], parts[1]);
                    // Solo nicchie con apprestamenti tecnologici
                    if (!facilityType) return null;
                    
                    return {
                        id: index + 1,
                        km: parts[0],
                        binario: parts[1],
                        title: `Nicchia km ${parts[0]} - Binario ${parts[1]}`,
                        description: `${getFacilityLabel(facilityType)}`,
                        facilityType: facilityType
                    };
                }
                return null;
            })
            .filter(item => item !== null);

        // State
        let checklistData = [];
        let malfunctionReports = []; // Array per segnalazioni malfunzionamenti
        let isOnline = navigator.onLine;
        let selectedDirection = null;
        let startNicheId = null;
        let filteredNiches = [];
 let pageSize = 10;
 let currentPageStart = 0;
 let orderedItemIds = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            populateStartNicheSelect();
            setupStartScreen();
            updateOnlineStatus();
            
            // Event listeners
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            document.getElementById('submitBtn').addEventListener('click', submitReport);
            document.getElementById('cameraInput').addEventListener('change', handlePhotoCapture);
 document.getElementById('loadMoreBtn')?.addEventListener('click', showNextPage);
        });
        
        // Populate start niche dropdown
        function populateStartNicheSelect() {
            const select = document.getElementById('startNiche');
            
            CHECKLIST_ITEMS.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.km} - Binario ${item.binario}`;
                select.appendChild(option);
            });
        }
        
        // Setup start screen
        function setupStartScreen() {
            const startNicheSelect = document.getElementById('startNiche');
            const directionSelect = document.getElementById('direction');
            const startBtn = document.getElementById('startBtn');
            
            const checkStartButton = () => {
                startBtn.disabled = !(startNicheSelect.value && directionSelect.value);
            };
            
            startNicheSelect.addEventListener('change', checkStartButton);
            directionSelect.addEventListener('change', checkStartButton);
            
            startBtn.addEventListener('click', () => {
                startNicheId = parseInt(startNicheSelect.value);
                selectedDirection = directionSelect.value;
                
                // Filter niches based on direction
                filterNichesByDirection();
                
                // Initialize filtered checklist
                initializeChecklist();
                loadFromLocalStorage();
                updateProgress();
                
                // Update direction info
                const dirText = selectedDirection === 'san_benedetto' 
                    ? '‚¨ÜÔ∏è Verso San Benedetto' 
                    : '‚¨áÔ∏è Verso Vernio';
                document.getElementById('directionInfo').textContent = dirText;
                
                // Show main screen
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('mainScreen').style.display = 'block';
                document.getElementById('floatingMalfunctionBtn').style.display = 'flex';
                
                showToast('Verifica iniziata!', 'success');
            });
        }
        
        // Filter niches by direction
        function filterNichesByDirection() {
            const startNiche = CHECKLIST_ITEMS.find(n => n.id === startNicheId);
            const startKmValue = parseFloat(startNiche.km.replace('+', '.'));
            
            if (selectedDirection === 'san_benedetto') {
                // Going up towards 55+742
                filteredNiches = CHECKLIST_ITEMS.filter(n => {
                    const kmValue = parseFloat(n.km.replace('+', '.'));
                    return kmValue >= startKmValue;
                }).sort((a, b) => {
                    const aVal = parseFloat(a.km.replace('+', '.'));
                    const bVal = parseFloat(b.km.replace('+', '.'));
                    return aVal - bVal; // Ascending
                });
            } else {
                // Going down towards 37+200
                filteredNiches = CHECKLIST_ITEMS.filter(n => {
                    const kmValue = parseFloat(n.km.replace('+', '.'));
                    return kmValue <= startKmValue;
                }).sort((a, b) => {
                    const aVal = parseFloat(a.km.replace('+', '.'));
                    const bVal = parseFloat(b.km.replace('+', '.'));
                    return bVal - aVal; // Descending
                });
            }
        }

        // Initialize checklist
        function initializeChecklist() {
            const container = document.getElementById('checklist');
            container.innerHTML = ''; // Clear existing
            checklistData = []; // Reset
            
            filteredNiches.forEach(item => {
                const itemData = {
                    id: item.id,
                    km: item.km,
                    binario: item.binario,
                    title: item.title,
                    description: item.description,
                    facilityType: item.facilityType,
                    completed: false,
                    checks: {
                        statoApprestamento: null, // Stato dell'apprestamento
                        sigillo: null, // Verifica manomissione sigillo
                        segnaletica: null // Presenza segnaletica di riferimento
                    },
                    timestamp: null,
                    notes: ''
                };
                
                checklistData.push(itemData);
                
                const itemEl = createChecklistItem(item, itemData);
                container.appendChild(itemEl);
            });
        
            // Pagination order and first page
            orderedItemIds = filteredNiches.map(n => n.id);
            showPage(0);
}

        // Create checklist item element
        function createChecklistItem(item, data) {
            const div = document.createElement('div');
            div.className = 'check-item';
            div.id = `item-${item.id}`;
            
            div.innerHTML = `
                <div class="check-header">
                    <div class="check-content">
                        <div class="check-title">${item.title}</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            <span style="font-weight: 600; color: var(--warning);">${item.description}</span>
                        </div>
                        
                        <!-- Stato dell'apprestamento -->
                        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-dark); border-radius: 0.75rem; border: 1px solid var(--border);">
                            <div style="font-weight: 700; margin-bottom: 0.5rem;">
                                Stato dell'apprestamento
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Verifica lo stato generale dell'apprestamento tecnologico
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
                                    <input type="radio" name="statoApprestamento-${item.id}" value="conforme" class="safety-radio" data-id="${item.id}" data-type="statoApprestamento"
                                           style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">Conforme</span>
                                </label>
                                
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
                                    <input type="radio" name="statoApprestamento-${item.id}" value="non_conforme" class="safety-radio" data-id="${item.id}" data-type="statoApprestamento"
                                           style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">Non Conforme</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Verifica manomissione sigillo -->
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-dark); border-radius: 0.75rem; border: 1px solid var(--border);">
                            <div style="font-weight: 700; margin-bottom: 0.5rem;">
                                Verifica manomissione sigillo
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Controlla se il sigillo √® integro e non √® stato manomesso
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
                                    <input type="radio" name="sigillo-${item.id}" value="integro" class="safety-radio" data-id="${item.id}" data-type="sigillo"
                                           style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">Integro</span>
                                </label>
                                
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
                                    <input type="radio" name="sigillo-${item.id}" value="manomesso" class="safety-radio" data-id="${item.id}" data-type="sigillo"
                                           style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">Manomesso</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Presenza segnaletica di riferimento -->
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-dark); border-radius: 0.75rem; border: 1px solid var(--border);">
                            <div style="font-weight: 700; margin-bottom: 0.5rem;">
                                Presenza segnaletica di riferimento
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Verifica la presenza della segnaletica di riferimento per l'apprestamento
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
                                    <input type="radio" name="segnaletica-${item.id}" value="presente" class="safety-radio" data-id="${item.id}" data-type="segnaletica"
                                           style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">Presente</span>
                                </label>
                                
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
                                    <input type="radio" name="segnaletica-${item.id}" value="assente" class="safety-radio" data-id="${item.id}" data-type="segnaletica"
                                           style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">Assente</span>
                                </label>
                            </div>
                        </div>

                        <div class="check-meta" id="meta-${item.id}"></div>
                    </div>
                </div>
            `;
            
            // Add radio listeners
            const radios = div.querySelectorAll('.safety-radio');
            radios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    handleSafetyCheck(item.id, e.target.dataset.type, e.target.value);
                    
                    // Visual feedback for selected label
                    const label = e.target.closest('.radio-label');
                    const allLabels = label.parentElement.querySelectorAll('.radio-label');
                    allLabels.forEach(l => l.style.borderColor = 'transparent');
                    if (e.target.checked) {
                        label.style.borderColor = 'var(--primary)';
                    }
                });
            });
            
            return div;
        }

        // Handle safety radio change
        function handleSafetyCheck(id, type, value) {
            const itemData = checklistData.find(item => item.id === id);
            
            if (!itemData.checks) {
                itemData.checks = {
                    statoApprestamento: null,
                    sigillo: null,
                    segnaletica: null
                };
            }
            
            itemData.checks[type] = value;
            
            // Update completed status - all three checks must be answered
            itemData.completed = itemData.checks.statoApprestamento !== null && 
                                itemData.checks.sigillo !== null && 
                                itemData.checks.segnaletica !== null;
            
            if (itemData.completed && !itemData.timestamp) {
                itemData.timestamp = new Date().toISOString();
            } else if (!itemData.completed) {
                itemData.timestamp = null;
            }
            
            const itemEl = document.getElementById(`item-${id}`);
            if (itemData.completed) {
                itemEl.classList.add('completed');
            } else {
                itemEl.classList.remove('completed');
            }
            
            updateProgress();
            updateMeta(id);
            saveToLocalStorage();
        }

        // Capture photo
        function capturePhoto(id, photoType) {
            const input = document.getElementById('cameraInput');
            input.dataset.itemId = id;
            input.dataset.photoType = photoType || 'general';
            input.click();
        }

        // Handle photo capture
        function handlePhotoCapture(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const itemId = parseInt(e.target.dataset.itemId);
            const photoType = e.target.dataset.photoType || 'general';
            const reader = new FileReader();
            
            reader.onload = (event) => {
                const itemData = checklistData.find(item => item.id === itemId);
                
                if (!itemData.photosByType) {
                    itemData.photosByType = {
                        segnaletica: [],
                        illuminazione: [],
                        general: []
                    };
                }
                
                // Keep backward compatibility
                if (!itemData.photos) itemData.photos = [];
                
                const photoData = {
                    data: event.target.result,
                    type: photoType,
                    timestamp: new Date().toISOString()
                };
                
                itemData.photosByType[photoType].push(photoData);
                itemData.photos.push(event.target.result); // Backward compatibility
                
                displayPhotos(itemId);
                saveToLocalStorage();
                showToast(`Foto ${photoType} acquisita!`, 'success');
            };
            
            reader.readAsDataURL(file);
            e.target.value = ''; // Reset input
        }

        // Display photos
        function displayPhotos(id) {
            const itemData = checklistData.find(item => item.id === id);
            const container = document.getElementById(`photos-${id}`);
            
            if (!itemData.photosByType) {
                // Fallback for old format
                container.innerHTML = itemData.photos.map((photo, index) => 
                    `<img src="${photo}" class="photo-thumbnail" alt="Foto ${index + 1}" onclick="viewPhoto('${photo}')">`
                ).join('');
                return;
            }
            
            let html = '';
            
            // Segnaletica photos
            if (itemData.photosByType.segnaletica?.length > 0) {
                html += '<div style="margin-bottom: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">üö´ Segnaletica Mancante:</div>';
                itemData.photosByType.segnaletica.forEach((photo, index) => {
                    html += `<img src="${photo.data}" class="photo-thumbnail" alt="Segnaletica ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
                });
            }
            
            // Illuminazione photos
            if (itemData.photosByType.illuminazione?.length > 0) {
                html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">üí° Illuminazione Mancante:</div>';
                itemData.photosByType.illuminazione.forEach((photo, index) => {
                    html += `<img src="${photo.data}" class="photo-thumbnail" alt="Illuminazione ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
                });
            }
            
            // VVF photos
 if (itemData.photosByType.vvf?.length > 0) {
  html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">üî• VV.F. / Manichette:</div>';
  itemData.photosByType.vvf.forEach((photo, index) => {
    html += `<img src="${photo.data}" class="photo-thumbnail" alt="VVF ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
  });
 }

 // General photos
            if (itemData.photosByType.general?.length > 0) {
                html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">üì∑ Altre Foto:</div>';
                itemData.photosByType.general.forEach((photo, index) => {
                    html += `<img src="${photo.data}" class="photo-thumbnail" alt="Generale ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
                });
            }
            
            container.innerHTML = html;
        }

        // View photo in new tab
        function viewPhoto(photo) {
            const win = window.open();
            win.document.write(`<img src="${photo}" style="max-width: 100%; height: auto;">`);
        }

        // Malfunction reporting functions
        let currentMalfunctionPhoto = null;
        
        function openMalfunctionModal() {
            document.getElementById('malfunctionModal').style.display = 'block';
            resetMalfunctionForm();
        }
        
        function closeMalfunctionModal() {
            document.getElementById('malfunctionModal').style.display = 'none';
            resetMalfunctionForm();
        }
        
        function resetMalfunctionForm() {
            // Reset all form fields
            document.querySelectorAll('input[name="malfunctionType"]').forEach(r => r.checked = false);
            document.querySelectorAll('input[name="lightingType"]').forEach(r => r.checked = false);
            document.getElementById('kmMarker').value = '';
            document.getElementById('bodyCount').value = '';
            document.getElementById('malfunctionNotes').value = '';
            document.getElementById('kmFields').style.display = 'none';
            document.getElementById('photoFields').style.display = 'none';
            document.getElementById('lightingFields').style.display = 'none';
            document.getElementById('lightingBodyCount').style.display = 'none';
            document.getElementById('malfunctionPhotoPreview').innerHTML = '';
            currentMalfunctionPhoto = null;
            
            // Reset label borders
            document.querySelectorAll('.malfunction-type-label').forEach(l => l.style.borderColor = 'transparent');
        }
        
        function handleMalfunctionTypeChange() {
            const selectedType = document.querySelector('input[name="malfunctionType"]:checked')?.value;
            
            // Visual feedback
            document.querySelectorAll('.malfunction-type-label').forEach(l => l.style.borderColor = 'transparent');
            if (selectedType) {
                const selectedLabel = document.querySelector(`input[name="malfunctionType"][value="${selectedType}"]`).closest('.malfunction-type-label');
                selectedLabel.style.borderColor = 'var(--primary)';
            }
            
            // Show/hide fields based on type
            if (selectedType === 'illuminazione') {
                document.getElementById('lightingFields').style.display = 'block';
                document.getElementById('photoFields').style.display = 'none';
            } else if (selectedType) {
                document.getElementById('lightingFields').style.display = 'none';
                document.getElementById('photoFields').style.display = 'block';
            }
            
            // Always show km field when type selected
            if (selectedType) {
                document.getElementById('kmFields').style.display = 'block';
            }
        }
        
        function handleLightingTypeChange() {
            const lightingType = document.querySelector('input[name="lightingType"]:checked')?.value;
            const bodyCountDiv = document.getElementById('lightingBodyCount');
            
            if (lightingType === 'corpi_illuminanti') {
                bodyCountDiv.style.display = 'block';
            } else {
                bodyCountDiv.style.display = 'none';
            }
        }
        
        function captureMalfunctionPhoto() {
            const input = document.getElementById('malfunctionCameraInput');
            input.click();
        }
        
        // Handle malfunction photo capture
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('malfunctionCameraInput')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    currentMalfunctionPhoto = event.target.result;
                    document.getElementById('malfunctionPhotoPreview').innerHTML = 
                        `<img src="${event.target.result}" style="width: 100%; max-height: 200px; object-fit: contain; border-radius: 0.5rem; border: 1px solid var(--border);" alt="Preview">`;
                    showToast('Foto acquisita!', 'success');
                };
                reader.readAsDataURL(file);
                e.target.value = ''; // Reset input
            });
        });
        
        function saveMalfunctionReport() {
            const type = document.querySelector('input[name="malfunctionType"]:checked')?.value;
            const kmMarker = document.getElementById('kmMarker').value.trim();
            const notes = document.getElementById('malfunctionNotes').value.trim();
            
            // Validation
            if (!type) {
                showToast('Seleziona il tipo di malfunzionamento', 'error');
                return;
            }
            
            if (!kmMarker) {
                showToast('Inserisci la progressiva chilometrica', 'error');
                return;
            }
            
            // Type-specific validation
            if (type === 'illuminazione') {
                const lightingType = document.querySelector('input[name="lightingType"]:checked')?.value;
                if (!lightingType) {
                    showToast('Specifica il tipo di guasto illuminazione', 'error');
                    return;
                }
                
                if (lightingType === 'corpi_illuminanti') {
                    const bodyCount = document.getElementById('bodyCount').value;
                    if (!bodyCount || bodyCount < 1) {
                        showToast('Inserisci il numero di corpi non funzionanti', 'error');
                        return;
                    }
                }
            } else {
                // Photo required for non-lighting types
                if (!currentMalfunctionPhoto) {
                    showToast('Scatta una foto del malfunzionamento', 'error');
                    return;
                }
            }
            
            // Create malfunction report
            const report = {
                id: Date.now(),
                type: type,
                kmMarker: kmMarker,
                notes: notes,
                timestamp: new Date().toISOString()
            };
            
            if (type === 'illuminazione') {
                report.lightingType = document.querySelector('input[name="lightingType"]:checked').value;
                if (report.lightingType === 'corpi_illuminanti') {
                    report.bodyCount = document.getElementById('bodyCount').value;
                }
            } else {
                report.photo = currentMalfunctionPhoto;
            }
            
            malfunctionReports.push(report);
            updateMalfunctionCount();
            saveToLocalStorage();
            closeMalfunctionModal();
            showToast('Segnalazione salvata con successo!', 'success');
        }
        
        function updateMalfunctionCount() {
            const count = malfunctionReports.length;
            const countEl = document.getElementById('malfunctionCount');
            if (count === 0) {
                countEl.textContent = 'Nessuna segnalazione registrata';
                countEl.style.color = 'var(--text-secondary)';
            } else {
                countEl.textContent = `${count} segnalazione${count > 1 ? 'i' : ''} registrata${count > 1 ? 'e' : ''}`;
                countEl.style.color = 'var(--danger)';
                countEl.style.fontWeight = '600';
            }
        }

        // Update meta information
        function updateMeta(id) {
            const itemData = checklistData.find(item => item.id === id);
            const container = document.getElementById(`meta-${id}`);
            
            let metaHtml = '';
            
            if (itemData.timestamp) {
                const date = new Date(itemData.timestamp);
                metaHtml += `
                    <div class="meta-item">
                        <span class="meta-icon">‚è±</span>
                        <span>${date.toLocaleString('it-IT')}</span>
                    </div>
                `;
            }
            
            if (itemData.checks) {
                if (itemData.checks.statoApprestamento) {
                    const icon = itemData.checks.statoApprestamento === 'conforme' ? '‚úì' : '‚úó';
                    metaHtml += `
                        <div class="meta-item">
                            <span class="meta-icon">${icon}</span>
                            <span>Stato: ${itemData.checks.statoApprestamento === 'conforme' ? 'Conforme' : 'Non Conforme'}</span>
                        </div>
                    `;
                }
                
                if (itemData.checks.sigillo) {
                    const icon = itemData.checks.sigillo === 'integro' ? '‚úì' : '‚úó';
                    metaHtml += `
                        <div class="meta-item">
                            <span class="meta-icon">${icon}</span>
                            <span>Sigillo: ${itemData.checks.sigillo === 'integro' ? 'Integro' : 'Manomesso'}</span>
                        </div>
                    `;
                }
                
                if (itemData.checks.segnaletica) {
                    const icon = itemData.checks.segnaletica === 'presente' ? '‚úì' : '‚úó';
                    metaHtml += `
                        <div class="meta-item">
                            <span class="meta-icon">${icon}</span>
                            <span>Segnaletica: ${itemData.checks.segnaletica === 'presente' ? 'Presente' : 'Assente'}</span>
                        </div>
                    `;
                }
            }
            
            container.innerHTML = metaHtml;
        }

        
// Pagination helpers: mostra solo 10 nicchie per volta
function showPage(startIndex) {
  currentPageStart = startIndex;
  orderedItemIds.forEach((id, idx) => {
    const el = document.getElementById(`item-${id}`);
    if (!el) return;
    el.style.display = (idx >= currentPageStart && idx < currentPageStart + pageSize) ? 'block' : 'none';
  });
  updatePaginationUI();
}

function showNextPage() {
  const total = orderedItemIds.length;
  if (currentPageStart + pageSize >= total) {
    showToast("Nessun'altra nicchia da mostrare", 'success');
    return;
  }
  showPage(currentPageStart + pageSize);
  document.getElementById('checklist')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function updatePaginationUI() {
  const total = orderedItemIds.length;
  const start = currentPageStart;
  const end = Math.min(currentPageStart + pageSize, total);
  const shown = document.getElementById('shownCount');
  const btn = document.getElementById('loadMoreBtn');
  if (shown) shown.textContent = total ? `Mostrate ${start + 1}-${end} di ${total}` : 'Mostrate 0/0';
  if (btn) {
    if (end >= total) {
      btn.style.display = 'none';
    } else {
      btn.style.display = 'inline-flex';
      const nextEnd = Math.min(end + pageSize, total);
      btn.textContent = `‚ûï Mostra altre 10 (${end + 1}-${nextEnd})`;
    }
  }
}

// Update progress
        function updateProgress() {
            const completed = checklistData.filter(item => item.completed).length;
            const total = checklistData.length;
            const percentage = Math.round((completed / total) * 100);
            
            document.getElementById('progressText').textContent = `${percentage}%`;
            document.getElementById('progressFill').style.width = `${percentage}%`;
            
            // Enable submit button if all completed
            const submitBtn = document.getElementById('submitBtn');
            const emailInput = document.getElementById('emailInput');
            submitBtn.disabled = !(emailInput.value && emailInput.value.includes('@'));
        }

        // Email validation
        document.getElementById('emailInput').addEventListener('input', updateProgress);

        // Update online status
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const statusEl = document.getElementById('onlineStatus');
            const statusText = document.getElementById('statusText');
            
            if (isOnline) {
                statusEl.className = 'status-badge status-online';
                statusText.textContent = 'Online';
            } else {
                statusEl.className = 'status-badge status-offline';
                statusText.textContent = 'Offline';
            }
        }

        // Submit report
        async function submitReport() {
            if (!isOnline) {
                showToast('Impossibile inviare: sei offline. Il report verr√† salvato.', 'error');
                return;
            }
            
            const email = 'a.manduchi@rfi.it';
            if (!email || !email.includes('@')) {
                showToast('Inserisci un indirizzo email valido', 'error');
                return;
            }
            
            const report = generateReport();
            
            // In a real implementation, you would send this to a backend API
            // For this demo, we'll use mailto: as a fallback
            const subject = encodeURIComponent(`Report Checklist - ${new Date().toLocaleDateString('it-IT')}`);
            const body = encodeURIComponent(report);
            
            // Show success message
            showToast('Report generato! Apertura client email...', 'success');
            
            // Open mailto
            setTimeout(() => {
                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
            }, 1000);
            
            // Clear data after successful submission
            setTimeout(() => {
                if (confirm('Report inviato! Vuoi cancellare i dati locali?')) {
                    localStorage.removeItem('checklistData');
                    location.reload();
                }
            }, 2000);
        }

        // Generate report
        function generateReport() {
            let report = 'REPORT VERIFICA APPRESTAMENTI TECNOLOGICI GALLERIA\n';
            report += `Data Ispezione: ${new Date().toLocaleString('it-IT')}\n`;
            
            const directionText = selectedDirection === 'san_benedetto' 
                ? 'San Benedetto Val di Sambro (55+742)' 
                : 'Vernio (37+200)';
            report += `Direzione: Verso ${directionText}\n`;
            
            const totalNiches = checklistData.length;
            const completedNiches = checklistData.filter(i => i.completed).length;
            const nonConformNiches = checklistData.filter(i => {
                return i.checks?.statoApprestamento === 'non_conforme' || 
                       i.checks?.sigillo === 'manomesso' || 
                       i.checks?.segnaletica === 'assente';
            }).length;
            
            report += `Apprestamenti Verificati: ${completedNiches}/${totalNiches}\n`;
            report += `Apprestamenti Non Conformi: ${nonConformNiches}\n`;
            report += `Segnalazioni Malfunzionamenti: ${malfunctionReports.length}\n`;
            report += `Percentuale Completamento: ${Math.round((completedNiches/totalNiches)*100)}%\n\n`;
            
            report += '='.repeat(60) + '\n\n';
            
            // Summary of non-conforming niches
            const nichesNonConform = checklistData.filter(i => {
                return i.checks?.statoApprestamento === 'non_conforme' || 
                       i.checks?.sigillo === 'manomesso' || 
                       i.checks?.segnaletica === 'assente';
            });
            
            if (nichesNonConform.length > 0) {
                report += 'RIEPILOGO APPRESTAMENTI NON CONFORMI\n\n';
                
                nichesNonConform.forEach((item) => {
                    const niche = filteredNiches.find(n => n.id === item.id);
                    report += `üìç ${niche.km} - Binario ${niche.binario} - ${niche.description}\n`;
                    
                    if (item.checks.statoApprestamento === 'non_conforme') {
                        report += `   ‚ö†Ô∏è STATO APPRESTAMENTO - Non Conforme\n`;
                    }
                    
                    if (item.checks.sigillo === 'manomesso') {
                        report += `   ‚ö†Ô∏è SIGILLO - Manomesso\n`;
                    }
                    
                    if (item.checks.segnaletica === 'assente') {
                        report += `   ‚ö†Ô∏è SEGNALETICA DI RIFERIMENTO - Assente\n`;
                    }
                    
                    if (item.timestamp) {
                        report += `   Verificato: ${new Date(item.timestamp).toLocaleString('it-IT')}\n`;
                    }
                    report += '\n';
                });
                
                report += '='.repeat(60) + '\n\n';
            }
            
            // Malfunction reports summary
            if (malfunctionReports.length > 0) {
                report += 'SEGNALAZIONI MALFUNZIONAMENTI\n\n';
                
                malfunctionReports.forEach((malfunction, index) => {
                    report += `${index + 1}. `;
                    
                    // Type label
                    const typeLabels = {
                        'camminamento': 'üö∂ CAMMINAMENTO',
                        'corrimano': 'ü§ù CORRIMANO',
                        'segnaletica_uscita': 'üö™ SEGNALETICA DI USCITA',
                        'illuminazione': 'üí° IMPIANTO DI ILLUMINAZIONE'
                    };
                    report += `${typeLabels[malfunction.type]}\n`;
                    report += `   Progressiva: ${malfunction.kmMarker}\n`;
                    
                    // Lighting specific details
                    if (malfunction.type === 'illuminazione') {
                        const lightingLabels = {
                            'fungo_blu': 'Fungo Blu',
                            'corpi_illuminanti': 'Corpi Illuminanti'
                        };
                        report += `   Tipo Guasto: ${lightingLabels[malfunction.lightingType]}\n`;
                        
                        if (malfunction.lightingType === 'corpi_illuminanti' && malfunction.bodyCount) {
                            report += `   Numero Corpi Non Funzionanti: ${malfunction.bodyCount}\n`;
                        }
                    } else {
                        report += `   Foto Allegata: S√¨\n`;
                    }
                    
                    if (malfunction.notes) {
                        report += `   Note: ${malfunction.notes}\n`;
                    }
                    
                    if (malfunction.timestamp) {
                        report += `   Segnalato: ${new Date(malfunction.timestamp).toLocaleString('it-IT')}\n`;
                    }
                    
                    report += '\n';
                });
                
                report += '='.repeat(60) + '\n\n';
            }
            
            // Detailed list of all niches
            report += 'DETTAGLIO COMPLETO APPRESTAMENTI TECNOLOGICI\n\n';
            
            checklistData.forEach((item, index) => {
                const niche = filteredNiches.find(n => n.id === item.id);
                report += `${index + 1}. Km ${niche.km} - Binario ${niche.binario}\n`;
                report += `   Tipo: ${niche.description}\n`;
                report += `   Stato: ${item.completed ? '‚úÖ VERIFICATO' : '‚è≥ DA VERIFICARE'}\n`;
                
                if (item.checks) {
                    if (item.checks.statoApprestamento) {
                        const status = item.checks.statoApprestamento === 'conforme' ? '‚úÖ Conforme' : '‚ö†Ô∏è Non Conforme';
                        report += `   Stato Apprestamento: ${status}\n`;
                    }
                    if (item.checks.sigillo) {
                        const status = item.checks.sigillo === 'integro' ? '‚úÖ Integro' : '‚ö†Ô∏è Manomesso';
                        report += `   Sigillo: ${status}\n`;
                    }
                    if (item.checks.segnaletica) {
                        const status = item.checks.segnaletica === 'presente' ? '‚úÖ Presente' : '‚ö†Ô∏è Assente';
                        report += `   Segnaletica di Riferimento: ${status}\n`;
                    }
                }
                
                if (item.timestamp) {
                    report += `   Data Verifica: ${new Date(item.timestamp).toLocaleString('it-IT')}\n`;
                }
                
                report += '\n';
            });
            
            report += '\n='.repeat(60) + '\n';
            report += 'Note Tecniche:\n';
            report += '- Apprestamenti Tecnologici: Idranti VVF, Colonnine TEM, Quadri di soccorso VVF\n';
            report += '- Per ogni apprestamento: verificato stato, sigillo e segnaletica\n';
            if (malfunctionReports.length > 0) {
                report += `- Segnalati ${malfunctionReports.length} malfunzionamenti infrastrutturali\n`;
            }
            report += '\nFine Report\n';
            report += `Generato da NicheSafe - ${new Date().toLocaleString('it-IT')}\n`;
            
            return report;
        }

        // LocalStorage functions
        function saveToLocalStorage() {
            localStorage.setItem('checklistData', JSON.stringify(checklistData));
            localStorage.setItem('malfunctionReports', JSON.stringify(malfunctionReports));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('checklistData');
            if (saved) {
                const savedData = JSON.parse(saved);
                
                savedData.forEach(savedItem => {
                    const item = checklistData.find(i => i.id === savedItem.id);
                    if (item) {
                        Object.assign(item, savedItem);
                        
                        // Ensure checks object exists with new structure
                        if (!item.checks) {
                            item.checks = {
                                statoApprestamento: null,
                                sigillo: null,
                                segnaletica: null
                            };
                        }
                        
                        // Update UI radio buttons for new checks
                        if (item.checks.statoApprestamento) {
                            const radio = document.querySelector(`input[name="statoApprestamento-${item.id}"][value="${item.checks.statoApprestamento}"]`);
                            if (radio) {
                                radio.checked = true;
                                const label = radio.closest('.radio-label');
                                if (label) label.style.borderColor = 'var(--primary)';
                            }
                        }
                        
                        if (item.checks.sigillo) {
                            const radio = document.querySelector(`input[name="sigillo-${item.id}"][value="${item.checks.sigillo}"]`);
                            if (radio) {
                                radio.checked = true;
                                const label = radio.closest('.radio-label');
                                if (label) label.style.borderColor = 'var(--primary)';
                            }
                        }
                        
                        if (item.checks.segnaletica) {
                            const radio = document.querySelector(`input[name="segnaletica-${item.id}"][value="${item.checks.segnaletica}"]`);
                            if (radio) {
                                radio.checked = true;
                                const label = radio.closest('.radio-label');
                                if (label) label.style.borderColor = 'var(--primary)';
                            }
                        }
                        
                        const itemEl = document.getElementById(`item-${item.id}`);
                        if (item.completed) {
                            itemEl.classList.add('completed');
                        }
                        
                        updateMeta(item.id);
                    }
                });
                
                updateProgress();
            }
            
            // Load malfunction reports
            const savedMalfunctions = localStorage.getItem('malfunctionReports');
            if (savedMalfunctions) {
                malfunctionReports = JSON.parse(savedMalfunctions);
                updateMalfunctionCount();
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.error('Service Worker registration failed:', err));
        }
    </script>
</body>
</html>
