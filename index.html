<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f172a">
    <title>NicheSafe - Verifica Nicchie Galleria</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NicheSafe">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #334155;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(34, 197, 94, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
            position: relative;
            z-index: 1;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            animation: slideDown 0.6s ease-out;
        }
        
        .logo {
            font-family: 'Syne', sans-serif;
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }
        
        .tagline {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        /* Status bar */
        .status-bar {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
            animation: fadeIn 0.6s ease-out 0.2s both;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border-radius: 2rem;
            font-size: 0.875rem;
            border: 1px solid var(--border);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .status-online .status-dot {
            background: var(--accent);
        }
        
        .status-offline .status-dot {
            background: var(--warning);
        }
        
        /* Card */
        .card {
            background: var(--bg-card);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            animation: slideUp 0.6s ease-out 0.3s both;
        }
        
        .section-title {
            font-family: 'Syne', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .section-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        /* Checklist items */

 /* Track alignment */
 .check-item.track-d { transform: translateX(-10px); }
 .check-item.track-p { transform: translateX(10px); }
 .check-item.track-d:hover { transform: translateX(-6px); }
 .check-item.track-p:hover { transform: translateX(14px); }
 @media (max-width: 640px) {
  .check-item.track-d, .check-item.track-p { transform: none; }
  .check-item.track-d:hover, .check-item.track-p:hover { transform: translateX(2px); }
 }

 /* VVF section */
 .vvf-badge {
  display:inline-flex;
  align-items:center;
  gap:0.4rem;
  padding:0.2rem 0.55rem;
  border-radius:999px;
  font-size:0.75rem;
  font-weight:700;
  background: rgba(245,158,11,0.12);
  border: 1px solid rgba(245,158,11,0.35);
  color: var(--warning);
 }

        .checklist {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .check-item {
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .check-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .check-item.completed::before {
            transform: scaleY(1);
        }
        
        .check-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }
        
        .check-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .checkbox-wrapper {
            position: relative;
            width: 28px;
            height: 28px;
            flex-shrink: 0;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            width: 100%;
            height: 100%;
            cursor: pointer;
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
        }
        
        .checkbox-custom {
            width: 100%;
            height: 100%;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            position: absolute;
            top: 0;
            left: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .checkbox-wrapper input[type="checkbox"]:checked + .checkbox-custom {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-color: var(--accent);
        }
        
        .checkbox-custom::after {
            content: '✓';
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
        }
        
        .checkbox-wrapper input[type="checkbox"]:checked + .checkbox-custom::after {
            opacity: 1;
            transform: scale(1);
        }
        
        .check-content {
            flex: 1;
        }
        
        .check-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .check-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .check-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .meta-icon {
            width: 20px;
            height: 20px;
            opacity: 0.7;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            font-weight: 700;
            padding: 1rem 2rem;
            font-size: 1rem;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Photo preview */
        .photo-preview {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .photo-thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 0.5rem;
            object-fit: cover;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .photo-thumbnail:hover {
            transform: scale(1.1);
            border-color: var(--primary);
        }
        
        /* Progress bar */
        .progress-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .progress-label {
            font-weight: 700;
        }
        
        .progress-percentage {
            color: var(--accent);
            font-weight: 700;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--bg-dark);
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 1rem;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        /* Submit section */
        .submit-section {
            margin-top: 2rem;
            text-align: center;
        }
        
        .email-input {
            width: 100%;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 2px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .email-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            transform: translateY(200%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 350px;
        }
        
        .toast.show {
            transform: translateY(0);
        }
        
        .toast.success {
            border-color: var(--accent);
        }
        
        .toast.error {
            border-color: var(--danger);
        }
        
        /* Animations */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        /* Responsive */
        @media (max-width: 640px) {
            .logo {
                font-size: 2rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .check-item {
                padding: 1rem;
            }
            
            .toast {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
                max-width: none;
            }
        }
        
        /* Hidden input */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Start Screen -->
        <div id="startScreen" class="card" style="display: block;">
            <header class="header">
                <h1 class="logo">NicheSafe</h1>
                <p class="tagline">Verifica Nicchie di Sicurezza Galleria Ferroviaria</p>
            </header>
            
            <h2 class="section-title" style="margin-top: 2rem;">
                <span class="section-icon"></span>
                Inizia Verifica
            </h2>
            
            <div style="margin-bottom: 2rem;">
                <label style="display: block; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">
                    Da quale nicchia vuoi iniziare?
                </label>
                <select id="startNiche" class="email-input" style="cursor: pointer;">
                    <option value="">-- Seleziona nicchia di partenza --</option>
                </select>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <label style="display: block; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">
                    In quale direzione stai andando?
                </label>
                <select id="direction" class="email-input" style="cursor: pointer;">
                    <option value="">-- Seleziona direzione --</option>
                    <option value="san_benedetto">Verso San Benedetto Val di Sambro (55+742)</option>
                    <option value="vernio">Verso Vernio (37+200)</option>
                </select>
            </div>
            
            <div style="text-align: center;">
                <button class="btn btn-primary" id="startBtn" disabled>
                    <span></span>
                    <span>Inizia Verifica</span>
                </button>
            </div>
        </div>
        
        <!-- Main Screen -->
        <div id="mainScreen" style="display: none;">
        <header class="header">
            <h1 class="logo">NicheSafe</h1>
            <p class="tagline">Verifica Nicchie di Sicurezza Galleria Ferroviaria</p>
        </header>
        
        <div class="status-bar">
            <div class="status-badge" id="onlineStatus">
                <span class="status-dot"></span>
                <span id="statusText">Controllo connessione...</span>
            </div>
            <div class="status-badge">
                <span></span>
                <span id="directionInfo">Direzione non impostata</span>
            </div>
        </div>
        
        <div class="card">
            <h2 class="section-title">
                <span class="section-icon"></span>
                Nicchie da Verificare
            </h2>
            
            <div class="checklist" id="checklist">
                <!-- Items will be added here -->
            </div>

 <div id="paginationControls" style="margin-top: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
  <button class="btn btn-secondary" id="loadMoreBtn" type="button" style="min-width: 220px; justify-content: center;">
    Mostra altre 10
  </button>
  <div id="shownCount" style="color: var(--text-secondary); font-size: 0.9rem;">
    Mostrate 0/0
  </div>
 </div>

            
            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-label">Progresso</span>
                    <span class="progress-percentage" id="progressText">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="submit-section">
  <div style="margin-bottom: 0.75rem; color: var(--text-secondary); font-size: 0.95rem;">
    Destinatario report: <b id="fixedRecipient">a.manduchi@rfi.it</b>
  </div>
  <input type="email" class="email-input hidden" id="emailInput" value="a.manduchi@rfi.it">
  <button class="btn btn-primary" id="submitBtn">
                    <span></span>
                    <span>Invia Report via Email</span>
                </button>
</div>
        </div>
        </div> <!-- end mainScreen -->
    </div> <!-- end container -->
    
    <div class="toast" id="toast"></div>
    
    <!-- Hidden file input for camera -->
    <input type="file" accept="image/*" capture="environment" class="hidden" id="cameraInput">

    <script>
        // Configuration - Railway Niches Data
        const NICHES_RAW_DATA = `55+742 D
55+675 D
55+650 P
55+650 D
55+625 D
55+600 P
55+575 D
55+550 P
55+550 D
55+525 D
55+500 P
55+492 D
55+475 D
55+450 P
55+425 D
55+400 P
55+375 D
55+350 P
55+325 D
55+300 P
55+275 D
55+250 P
55+225 D
55+200 P
55+175 D
55+150 P
55+125 D
55+100 P
55+075 D
55+050 P
55+024 D
55+000 P
54+974 D
54+949 P
54+924 D
54+899 P
54+874 D
54+849 P
54+824 D
54+799 P
54+774 D
54+749 P
54+724 D
54+699 P
54+674 P
54+674 D
54+649 P
54+624 D
54+599 P
54+574 D
54+549 P
54+524 D
54+499 P
54+474 D
54+449 P
54+424 D
54+399 P
54+374 D
54+349 P
54+324 D
54+299 P
54+274 D
54+249 P
54+224 D
54+199 P
54+174 D
54+149 P
54+124 D
54+099 P
54+074 D
54+049 P
54+024 D
53+999 P
53+973 D
53+947 P
53+923 D
53+897 P
53+873 D
53+847 P
53+823 D
53+797 P
53+773 D
53+747 P
53+723 D
53+697 P
53+673 D
53+647 P
53+623 P
53+623 D
53+597 P
53+573 D
53+547 P
53+523 D
53+497 P
53+473 D
53+447 P
53+423 D
53+397 P
53+373 D
53+347 P
53+323 D
53+297 P
53+273 D
53+247 P
53+223 D
53+197 P
53+173 D
53+147 P
53+123 D
53+097 P
53+073 D
53+047 P
53+023 D
52+997 P
52+973 D
52+947 P
52+921 D
52+896 P
52+871 D
52+846 P
52+821 D
52+796 P
52+771 D
52+746 P
52+721 D
52+696 P
52+671 D
52+646 P
52+634 D
52+621 D
52+596 P
52+571 D
52+546 P
52+521 D
52+496 P
52+471 D
52+446 P
52+421 D
52+396 P
52+371 D
52+346 P
52+321 D
52+296 P
52+271 D
52+246 P
52+221 D
52+196 P
52+171 D
52+146 P
52+121 D
52+096 P
52+071 D
52+046 P
52+021 D
51+994 P
51+969 D
51+944 P
51+919 D
51+894 P
51+869 D
51+844 P
51+819 D
51+794 P
51+769 D
51+744 P
51+719 D
51+694 P
51+669 D
51+644 P
51+619 D
51+617 P
51+594 P
51+569 D
51+544 P
51+519 D
51+494 P
51+469 D
51+444 P
51+419 D
51+394 P
51+369 D
51+344 P
51+319 D
51+274 P
51+269 D
51+244 P
51+219 D
51+194 P
51+169 D
51+144 P
51+119 D
51+094 P
51+069 D
51+044 P
51+019 D
50+994 P
50+970 D
50+945 P
50+921 D
50+871 D
50+845 P
50+821 D
50+795 P
50+771 D
50+721 D
50+696 P
50+671 D
50+647 P
50+622 D
50+597 P
50+572 D
50+547 P
50+522 D
50+477 P
50+472 D
50+447 P
50+422 D
50+397 P
50+372 D
50+347 P
50+322 D
50+278 P
50+273 D
50+248 P
50+223 D
50+198 P
50+173 D
50+148 P
50+123 D
50+098 P
50+073 D
50+048 P
50+023 D
49+998 P
49+973 D
49+949 P
49+924 D
49+899 P
49+874 D
49+849 P
49+824 D
49+799 P
49+774 D
49+749 P
49+724 D
49+699 P
49+674 D
49+649 P
49+624 D
49+574 D
49+549 P
49+524 D
49+499 P
49+474 D
49+449 P
49+424 D
49+399 P
49+374 D
49+349 P
49+324 D
49+299 P
49+274 D
49+249 P
49+224 D
49+199 P
49+174 D
49+149 P
49+124 D
49+099 P
49+074 D
49+054 P
49+024 D
48+999 P
48+974 D
48+949 P
48+924 D
48+899 P
48+874 D
48+849 P
48+824 D
48+799 P
48+774 D
48+749 P
48+724 D
48+699 P
48+674 D
48+649 P
48+624 D
48+599 P
48+574 D
48+549 P
48+524 D
48+499 P
48+474 D
48+449 P
48+424 P
48+424 D
48+399 P
48+374 D
48+349 P
48+324 D
48+299 P
48+274 D
48+249 P
48+224 D
48+199 P
48+174 D
48+149 P
48+124 D
48+099 P
48+074 D
48+049 P
48+024 D
47+999 P
47+974 D
47+949 P
47+924 D
47+899 P
47+874 D
47+849 P
47+824 D
47+799 P
47+774 D
47+724 P
47+724 D
47+699 P
47+674 D
47+649 P
47+624 D
47+599 P
47+574 D
47+549 P
47+524 P
47+524 D
47+499 P
47+474 D
47+348 D
47+323 P
47+298 D
47+273 P
47+248 D
47+223 P
47+198 D
47+173 P
47+153 D
47+123 P
47+100 D
47+075 P
47+050 D
47+025 P
47+001 D
46+975 P
46+951 D
46+921 P
46+848 D
46+855 P
46+800 P
46+781 D
46+747 P
46+731 D
46+697 P
46+681 D
46+647 P
46+631 D
46+597 P
46+581 D
46+547 P
46+531 D
46+497 P
46+481 D
46+447 P
46+431 D
46+397 P
46+381 D
46+366 P
46+232 P
46+208 P
46+184 D
46+158 P
46+134 D
46+108 P
46+064 D
46+058 P
46+034 D
46+008 P
45+985 D
45+958 P
45+935 D
45+908 P
45+886 D
45+858 P
45+836 D
45+808 P
45+786 D
45+758 P
45+733 D
45+708 P
45+683 D
45+658 P
45+633 D
45+608 P
45+583 D
45+558 P
45+533 D
45+508 P
45+483 D
45+483 P
45+458 P
45+433 D
45+408 P
45+383 D
45+358 P
45+333 D
45+308 P
45+283 D
45+258 P
45+233 D
45+208 P
45+183 D
45+158 P
45+133 D
45+108 P
45+083 D
45+058 P
45+033 D
45+008 P
44+983 D
44+958 P
44+933 D
44+908 P
44+883 D
44+858 P
44+833 D
44+808 P
44+783 D
44+758 P
44+733 D
44+708 P
44+683 D
44+658 P
44+633 D
44+608 P
44+583 D
44+558 P
44+533 D
44+508 P
44+486 D
44+458 P
44+436 D
44+408 P
44+388 D
44+363 P
44+338 D
44+319 P
44+294 P
44+288 D
44+269 P
44+238 D
44+219 P
44+188 D
44+169 P
44+138 D
44+119 P
44+088 D
44+069 P
44+038 D
44+019 P
43+988 D
43+969 P
43+938 D
43+919 P
43+888 D
43+869 P
43+838 D
43+813 P
43+788 D
43+763 P
43+738 D
43+713 P
43+688 D
43+663 P
43+638 D
43+613 P
43+588 D
43+563 P
43+538 D
43+513 P
43+488 D
43+463 P
43+438 D
43+413 P
43+388 D
43+363 P
43+333 D
43+313 P
43+288 D
43+263 P
43+238 D
43+213 P
43+188 D
43+163 P
43+138 D
43+113 P
43+088 D
43+088 P
43+038 D
43+013 P
42+988 D
42+963 P
42+938 D
42+913 P
42+888 D
42+863 P
42+838 D
42+813 P
42+788 D
42+763 P
42+738 D
42+713 P
42+686 D
42+663 P
42+638 D
42+613 P
42+588 D
42+563 P
42+538 D
42+513 P
42+488 D
42+463 P
42+438 D
42+413 P
42+388 D
42+363 P
42+338 D
42+313 P
42+288 D
42+263 P
42+238 D
42+231 P
42+188 D
42+163 P
42+138 D
42+113 P
42+088 D
42+063 P
42+038 D
42+013 P
41+987 D
41+963 P
41+937 D
41+913 P
41+890 P
41+886 D
41+863 P
41+836 D
41+813 P
41+786 D
41+757 P
41+738 D
41+713 P
41+688 D
41+663 P
41+638 D
41+613 P
41+585 D
41+563 P
41+535 D
41+513 P
41+484 D
41+463 P
41+434 D
41+413 P
41+381 D
41+363 P
41+333 D
41+313 P
41+283 D
41+259 P
41+232 D
41+213 P
41+182 D
41+163 P
41+113 P
41+082 D
41+063 P
41+032 D
41+013 P
40+988 D
40+983 P
40+963 P
40+932 D
40+913 P
40+882 D
40+863 P
40+832 D
40+813 P
40+782 D
40+763 P
40+732 D
40+713 P
40+668 D
40+663 P
40+638 D
40+613 P
40+588 D
40+563 P
40+538 D
40+513 P
40+488 D
40+463 P
40+438 D
40+413 P
40+388 D
40+363 P
40+338 D
40+313 P
40+288 D
40+263 P
40+238 D
40+213 P
40+188 D
40+163 P
40+138 D
40+113 P
40+088 D
40+063 P
40+038 D
40+013 P
39+988 D
39+963 P
39+938 D
39+913 P
39+888 P
39+888 D
39+863 P
39+838 D
39+813 P
39+788 D
39+763 P
39+738 D
39+713 P
39+688 D
39+663 P
39+638 D
39+613 P
39+588 D
39+563 P
39+538 D
39+513 P
39+488 D
39+463 P
39+438 D
39+413 P
39+388 D
39+363 P
39+338 D
39+313 P
39+288 D
39+263 P
39+238 D
39+213 P
39+188 D
39+163 P
39+113 P
39+088 D
39+063 P
39+038 D
39+013 P
38+988 D
38+963 P
38+938 D
38+903 P
38+888 D
38+863 P
38+838 D
38+813 P
38+788 P
38+788 D
38+763 P
38+738 D
38+713 P
38+688 D
38+663 P
38+638 D
38+613 P
38+588 D
38+563 P
38+538 D
38+513 P
38+488 D
38+463 P
38+438 D
38+413 P
38+388 D
38+363 P
38+338 D
38+313 P
38+288 D
38+263 P
38+238 D
38+213 P
38+188 D
38+163 P
38+138 D
38+113 P
38+088 D
38+063 P
38+038 D
38+013 P
37+988 D
37+963 P
37+938 D
37+913 P
37+888 D
37+863 P
37+838 D
37+813 P
37+788 D
37+763 P
37+738 D
37+713 P
37+688 D
37+663 P
37+638 D
37+613 P
37+588 D
37+563 P
37+538 D
37+512 P
37+486 D
37+463 P
37+435 D
37+413 P
37+383 D
37+363 P
37+333 D
37+313 P
37+293 P
37+284 D
37+259 P`;

        // Parse niches data
 // Elenco nicchie con verifica aggiuntiva VV.F. (manichette + segnaletica)
 const VVF_SPECIAL_SET = new Set([
  '55+575 D',
  '55+425 D',
  '55+275 D',
  '55+175 D',
  '55+024 D',
  '54+874 D',
  '54+774 D',
  '54+674 D',
  '54+574 D',
  '54+424 D',
  '54+324 D',
  '54+174 D',
  '54+024 D',
  '53+773 D',
  '53+623 D',
  '53+473 D',
  '53+373 D',
  '53+223 D',
  '53+073 D',
  '47+724 P',
  '47+649 P',
  '47+524 P',
  '47+273 P',
  '47+173 P',
  '47+025 P',
  '46+697 P',
  '46+597 P',
  '46+447 P',
  '46+208 P',
  '46+058 P',
  '45+908 P',
  '45+758 P',
  '45+658 P',
  '45+508 P',
  '45+408 P',
  '45+308 P',
  '45+158 P',
  '45+058 P'
]);

        const CHECKLIST_ITEMS = NICHES_RAW_DATA.split('\n')
            .map((line, index) => {
                const parts = line.trim().split(' ');
                if (parts.length === 2) {
                    return {
                        id: index + 1,
                        km: parts[0],
                        binario: parts[1],
                        title: `Nicchia km ${parts[0]} - Binario ${parts[1]}`,
                        description: `Verifica Segnaletica e Illuminazione`,
      isVvfSpecial: VVF_SPECIAL_SET.has(`${parts[0]} ${parts[1]}`)
                    };
                }
                return null;
            })
            .filter(item => item !== null);

        // State
        let checklistData = [];
        let isOnline = navigator.onLine;
        let selectedDirection = null;
        let startNicheId = null;
        let filteredNiches = [];
 let pageSize = 10;
 let currentPageStart = 0;
 let orderedItemIds = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            populateStartNicheSelect();
            setupStartScreen();
            updateOnlineStatus();
            
            // Event listeners
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            document.getElementById('submitBtn').addEventListener('click', submitReport);
            document.getElementById('cameraInput').addEventListener('change', handlePhotoCapture);
 document.getElementById('loadMoreBtn')?.addEventListener('click', showNextPage);
        });
        
        // Populate start niche dropdown
        function populateStartNicheSelect() {
            const select = document.getElementById('startNiche');
            
            CHECKLIST_ITEMS.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.km} - Binario ${item.binario}`;
                select.appendChild(option);
            });
        }
        
        // Setup start screen
        function setupStartScreen() {
            const startNicheSelect = document.getElementById('startNiche');
            const directionSelect = document.getElementById('direction');
            const startBtn = document.getElementById('startBtn');
            
            const checkStartButton = () => {
                startBtn.disabled = !(startNicheSelect.value && directionSelect.value);
            };
            
            startNicheSelect.addEventListener('change', checkStartButton);
            directionSelect.addEventListener('change', checkStartButton);
            
            startBtn.addEventListener('click', () => {
                startNicheId = parseInt(startNicheSelect.value);
                selectedDirection = directionSelect.value;
                
                // Filter niches based on direction
                filterNichesByDirection();
                
                // Initialize filtered checklist
                initializeChecklist();
                loadFromLocalStorage();
                updateProgress();
                
                // Update direction info
                const dirText = selectedDirection === 'san_benedetto' 
                    ? '⬆️ Verso San Benedetto' 
                    : '⬇️ Verso Vernio';
                document.getElementById('directionInfo').textContent = dirText;
                
                // Show main screen
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('mainScreen').style.display = 'block';
                
                showToast('Verifica iniziata!', 'success');
            });
        }
        
        // Filter niches by direction
        function filterNichesByDirection() {
            const startNiche = CHECKLIST_ITEMS.find(n => n.id === startNicheId);
            const startKmValue = parseFloat(startNiche.km.replace('+', '.'));
            
            if (selectedDirection === 'san_benedetto') {
                // Going up towards 55+742
                filteredNiches = CHECKLIST_ITEMS.filter(n => {
                    const kmValue = parseFloat(n.km.replace('+', '.'));
                    return kmValue >= startKmValue;
                }).sort((a, b) => {
                    const aVal = parseFloat(a.km.replace('+', '.'));
                    const bVal = parseFloat(b.km.replace('+', '.'));
                    return aVal - bVal; // Ascending
                });
            } else {
                // Going down towards 37+200
                filteredNiches = CHECKLIST_ITEMS.filter(n => {
                    const kmValue = parseFloat(n.km.replace('+', '.'));
                    return kmValue <= startKmValue;
                }).sort((a, b) => {
                    const aVal = parseFloat(a.km.replace('+', '.'));
                    const bVal = parseFloat(b.km.replace('+', '.'));
                    return bVal - aVal; // Descending
                });
            }
        }

        // Initialize checklist
        function initializeChecklist() {
            const container = document.getElementById('checklist');
            container.innerHTML = ''; // Clear existing
            checklistData = []; // Reset
            
            filteredNiches.forEach(item => {
                const itemData = {
                    id: item.id,
                    km: item.km,
                    binario: item.binario,
                    title: item.title,
                    description: item.description,
                    completed: false,
                    checks: {
                        segnaletica: null,
                        illuminazione: null
                    },
                    timestamp: null,
                    photos: [], // Backward compatibility
                    photosByType: {
                        segnaletica: [],
                        illuminazione: [],
                        general: []
                    },
                    needsPhoto: {
                        segnaletica: false,
                        illuminazione: false
                    },
                    notes: ''
                };
                
                checklistData.push(itemData);
                
                const itemEl = createChecklistItem(item, itemData);
                container.appendChild(itemEl);
            });
        
            // Pagination order and first page
            orderedItemIds = filteredNiches.map(n => n.id);
            showPage(0);
}

        // Create checklist item element
        function createChecklistItem(item, data) {
            const div = document.createElement('div');
            div.className = 'check-item';
            div.id = `item-${item.id}`;
            
            div.innerHTML = `
                <div class="check-header">
                    <div class="check-content">
                        <div class="check-title">${item.title}</div>
                        
                        <!-- Segnaletica Section -->
                        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-dark); border-radius: 0.75rem; border: 1px solid var(--border);">
                            <div style="font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span></span>
                                <span>Segnaletica Uscite di Emergenza</span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Verifica presenza e visibilità della segnaletica di emergenza che indica le uscite di sicurezza
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
                                    <input type="radio" name="segnaletica-${item.id}" value="funzionante" class="safety-radio" data-id="${item.id}" data-type="segnaletica"
                                           style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">✅ Funzionante</span>
                                </label>
                                
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
                                    <input type="radio" name="segnaletica-${item.id}" value="manutenzione" class="safety-radio" data-id="${item.id}" data-type="segnaletica"
                                           style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">⚠️ Necessita Manutenzione</span>
                                </label>
                            </div>
                            
                            <div id="photo-btn-seg-${item.id}" style="margin-top: 1rem; display: none;">
                                <button class="btn btn-secondary" onclick="capturePhoto(${item.id}, 'segnaletica')" style="width: 100%; justify-content: center;">
                                    Scatta Foto Segnaletica
                                </button>
                            </div>
                        </div>
                        
                        <!-- Illuminazione Section -->
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-dark); border-radius: 0.75rem; border: 1px solid var(--border);">
                            <div style="font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span></span>
                                <span>Illuminazione di Emergenza</span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Verifica illuminazione sopra il corrimano (distanza 12,5m tra corpi illuminanti)
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
                                    <input type="radio" name="illuminazione-${item.id}" value="funzionante" class="safety-radio" data-id="${item.id}" data-type="illuminazione"
                                           style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">✅ Funzionante</span>
                                </label>
                                
                                <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
                                    <input type="radio" name="illuminazione-${item.id}" value="manutenzione" class="safety-radio" data-id="${item.id}" data-type="illuminazione"
                                           style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">⚠️ Necessita Manutenzione</span>
                                </label>
                            </div>
                            
                            <div id="photo-btn-ill-${item.id}" style="margin-top: 1rem; display: none;">
                                <button class="btn btn-secondary" onclick="capturePhoto(${item.id}, 'illuminazione')" style="width: 100%; justify-content: center;">
                                    Scatta Foto Illuminazione
                                </button>
                            </div>
                        </div>
                        
                        ${item.isVvfSpecial ? `
 <!-- VVF Section (solo nicchie selezionate) -->
 <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-dark); border-radius: 0.75rem; border: 1px solid var(--border);">
  <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.75rem;">
   <div style="font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
    <span></span>
    <span>Antincendio VV.F. (Manichette + Segnaletica)</span>
   </div>
   <span class="vvf-badge">Check extra</span>
  </div>
  <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
   Verifica la presenza delle <b>manichette per i Vigili del Fuoco</b> e della <b>segnaletica di riferimento</b> (presente, visibile e conforme).
  </div>
  <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
   <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
    <input type="radio" name="vvf-${item.id}" value="presente" class="safety-radio" data-id="${item.id}" data-type="vvf" style="width: 20px; height: 20px; cursor: pointer;">
    <span style="font-weight: 500;">✅ Presente e segnaletica OK</span>
   </label>
   <label style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid transparent; transition: all 0.3s;" class="radio-label">
    <input type="radio" name="vvf-${item.id}" value="non_conforme" class="safety-radio" data-id="${item.id}" data-type="vvf" style="width: 20px; height: 20px; cursor: pointer;">
    <span style="font-weight: 500;">⚠️ Assente / non conforme</span>
   </label>
  </div>
  <div id="photo-btn-vvf-${item.id}" style="margin-top: 1rem; display: none;">
   <button class="btn btn-secondary" onclick="capturePhoto(${item.id}, 'vvf')" style="width: 100%; justify-content: center;">Scatta Foto VV.F.</button>
  </div>
 </div>
` : ``}

<div class="photo-preview" id="photos-${item.id}" style="margin-top: 1rem;"></div>
                        
                        <div class="check-meta" id="meta-${item.id}"></div>
                    </div>
                </div>
            `;
            
            // Add radio listeners
            const radios = div.querySelectorAll('.safety-radio');
            radios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    handleSafetyCheck(item.id, e.target.dataset.type, e.target.value);
                    
                    // Visual feedback for selected label
                    const label = e.target.closest('.radio-label');
                    const allLabels = label.parentElement.querySelectorAll('.radio-label');
                    allLabels.forEach(l => l.style.borderColor = 'transparent');
                    if (e.target.checked) {
                        label.style.borderColor = 'var(--primary)';
                    }
                });
            });
            
            return div;
        }

        // Handle safety radio change
        function handleSafetyCheck(id, type, value) {
            const itemData = checklistData.find(item => item.id === id);
            
            if (!itemData.checks) {
                itemData.checks = {
                    segnaletica: null,
                    illuminazione: null
                };
            }
            
            itemData.checks[type] = value;
            
            // Show/hide photo button based on selection
            const photoBtnId = type === 'segnaletica' ? `photo-btn-seg-${id}` : (type === 'illuminazione' ? `photo-btn-ill-${id}` : `photo-btn-vvf-${id}`);
 const photoBtn = document.getElementById(photoBtnId);
            if (photoBtn) {
                if (value === 'manutenzione' || value === 'non_conforme') {
                    photoBtn.style.display = 'block';
                } else {
                    photoBtn.style.display = 'none';
                }
            }
            
            // Update completed status - both must be answered
            const requiresVVF = filteredNiches.find(n => n.id === id)?.isVvfSpecial;
 itemData.completed = itemData.checks.segnaletica !== null && itemData.checks.illuminazione !== null && (!requiresVVF || itemData.checks.vvf !== null);
            
            if (itemData.completed && !itemData.timestamp) {
                itemData.timestamp = new Date().toISOString();
            } else if (!itemData.completed) {
                itemData.timestamp = null;
            }
            
            // Check if maintenance selected but no photo yet
            if (value === 'manutenzione' || value === 'non_conforme') {
                const photos = itemData.photosByType?.[type] || [];
                if (photos.length === 0) {
                    itemData.needsPhoto = itemData.needsPhoto || {};
                    itemData.needsPhoto[type] = true;
                }
            } else {
                if (itemData.needsPhoto) {
                    itemData.needsPhoto[type] = false;
                }
            }
            
            const itemEl = document.getElementById(`item-${id}`);
            if (itemData.completed) {
                itemEl.classList.add('completed');
            } else {
                itemEl.classList.remove('completed');
            }
            
            updateProgress();
            updateMeta(id);
            saveToLocalStorage();
        }

        // Capture photo
        function capturePhoto(id, photoType) {
            const input = document.getElementById('cameraInput');
            input.dataset.itemId = id;
            input.dataset.photoType = photoType || 'general';
            input.click();
        }

        // Handle photo capture
        function handlePhotoCapture(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const itemId = parseInt(e.target.dataset.itemId);
            const photoType = e.target.dataset.photoType || 'general';
            const reader = new FileReader();
            
            reader.onload = (event) => {
                const itemData = checklistData.find(item => item.id === itemId);
                
                if (!itemData.photosByType) {
                    itemData.photosByType = {
                        segnaletica: [],
                        illuminazione: [],
                        general: []
                    };
                }
                
                // Keep backward compatibility
                if (!itemData.photos) itemData.photos = [];
                
                const photoData = {
                    data: event.target.result,
                    type: photoType,
                    timestamp: new Date().toISOString()
                };
                
                itemData.photosByType[photoType].push(photoData);
                itemData.photos.push(event.target.result); // Backward compatibility
                
                displayPhotos(itemId);
                saveToLocalStorage();
                showToast(`Foto ${photoType} acquisita!`, 'success');
            };
            
            reader.readAsDataURL(file);
            e.target.value = ''; // Reset input
        }

        // Display photos
        function displayPhotos(id) {
            const itemData = checklistData.find(item => item.id === id);
            const container = document.getElementById(`photos-${id}`);
            
            if (!itemData.photosByType) {
                // Fallback for old format
                container.innerHTML = itemData.photos.map((photo, index) => 
                    `<img src="${photo}" class="photo-thumbnail" alt="Foto ${index + 1}" onclick="viewPhoto('${photo}')">`
                ).join('');
                return;
            }
            
            let html = '';
            
            // Segnaletica photos
            if (itemData.photosByType.segnaletica?.length > 0) {
                html += '<div style="margin-bottom: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">Segnaletica Mancante:</div>';
                itemData.photosByType.segnaletica.forEach((photo, index) => {
                    html += `<img src="${photo.data}" class="photo-thumbnail" alt="Segnaletica ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
                });
            }
            
            // Illuminazione photos
            if (itemData.photosByType.illuminazione?.length > 0) {
                html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">Illuminazione Mancante:</div>';
                itemData.photosByType.illuminazione.forEach((photo, index) => {
                    html += `<img src="${photo.data}" class="photo-thumbnail" alt="Illuminazione ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
                });
            }
            
            // VVF photos
 if (itemData.photosByType.vvf?.length > 0) {
  html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">VV.F. / Manichette:</div>';
  itemData.photosByType.vvf.forEach((photo, index) => {
    html += `<img src="${photo.data}" class="photo-thumbnail" alt="VVF ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
  });
 }

 // General photos
            if (itemData.photosByType.general?.length > 0) {
                html += '<div style="margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary);">Altre Foto:</div>';
                itemData.photosByType.general.forEach((photo, index) => {
                    html += `<img src="${photo.data}" class="photo-thumbnail" alt="Generale ${index + 1}" onclick="viewPhoto('${photo.data}')">`;
                });
            }
            
            container.innerHTML = html;
        }

        // View photo in new tab
        function viewPhoto(photo) {
            const win = window.open();
            win.document.write(`<img src="${photo}" style="max-width: 100%; height: auto;">`);
        }

        // Update meta information
        function updateMeta(id) {
            const itemData = checklistData.find(item => item.id === id);
            const container = document.getElementById(`meta-${id}`);
            
            let metaHtml = '';
            
            if (itemData.timestamp) {
                const date = new Date(itemData.timestamp);
                metaHtml += `
                    <div class="meta-item">
                        <span class="meta-icon"></span>
                        <span>${date.toLocaleString('it-IT')}</span>
                    </div>
                `;
            }
            
            if (itemData.checks) {
                if (itemData.checks.segnaletica) {
                    const icon = itemData.checks.segnaletica === 'funzionante' ? '✅' : '⚠️';
                    metaHtml += `
                        <div class="meta-item">
                            <span class="meta-icon">${icon}</span>
                            <span>Segnaletica: ${itemData.checks.segnaletica === 'funzionante' ? 'OK' : 'Manutenzione'}</span>
                        </div>
                    `;
                }
                
                if (itemData.checks.vvf && (filteredNiches.find(n => n.id === id)?.isVvfSpecial)) {
  const icon = itemData.checks.vvf === 'presente' ? '✅' : '⚠️';
  metaHtml += `
  <div class="meta-item">
    <span class="meta-icon">${icon}</span>
    <span>VV.F.: ${itemData.checks.vvf === 'presente' ? 'OK' : 'Non conforme'}</span>
  </div>
  `;
 }
 if (itemData.checks.illuminazione) {
                    const icon = itemData.checks.illuminazione === 'funzionante' ? '✅' : '⚠️';
                    metaHtml += `
                        <div class="meta-item">
                            <span class="meta-icon">${icon}</span>
                            <span>Illuminazione: ${itemData.checks.illuminazione === 'funzionante' ? 'OK' : 'Manutenzione'}</span>
                        </div>
                    `;
                }
            }
            
            const photos = itemData.photosByType || {};
            const totalPhotos = (photos.segnaletica?.length || 0) + (photos.illuminazione?.length || 0) + (photos.vvf?.length || 0);
            if (totalPhotos > 0) {
                metaHtml += `
                    <div class="meta-item">
                        <span class="meta-icon"></span>
                        <span>${totalPhotos} foto</span>
                    </div>
                `;
            }
            
            container.innerHTML = metaHtml;
        }

        
// Pagination helpers: mostra solo 10 nicchie per volta
function showPage(startIndex) {
  currentPageStart = startIndex;
  orderedItemIds.forEach((id, idx) => {
    const el = document.getElementById(`item-${id}`);
    if (!el) return;
    el.style.display = (idx >= currentPageStart && idx < currentPageStart + pageSize) ? 'block' : 'none';
  });
  updatePaginationUI();
}

function showNextPage() {
  const total = orderedItemIds.length;
  if (currentPageStart + pageSize >= total) {
    showToast("Nessun'altra nicchia da mostrare", 'success');
    return;
  }
  showPage(currentPageStart + pageSize);
  document.getElementById('checklist')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function updatePaginationUI() {
  const total = orderedItemIds.length;
  const start = currentPageStart;
  const end = Math.min(currentPageStart + pageSize, total);
  const shown = document.getElementById('shownCount');
  const btn = document.getElementById('loadMoreBtn');
  if (shown) shown.textContent = total ? `Mostrate ${start + 1}-${end} di ${total}` : 'Mostrate 0/0';
  if (btn) {
    if (end >= total) {
      btn.style.display = 'none';
    } else {
      btn.style.display = 'inline-flex';
      const nextEnd = Math.min(end + pageSize, total);
      btn.textContent = `Mostra altre 10 (${end + 1}-${nextEnd})`;
    }
  }
}

// Update progress
        function updateProgress() {
            const completed = checklistData.filter(item => item.completed).length;
            const total = checklistData.length;
            const percentage = Math.round((completed / total) * 100);
            
            document.getElementById('progressText').textContent = `${percentage}%`;
            document.getElementById('progressFill').style.width = `${percentage}%`;
            
            // Enable submit button if all completed
            const submitBtn = document.getElementById('submitBtn');
            const emailInput = document.getElementById('emailInput');
            submitBtn.disabled = !(emailInput.value && emailInput.value.includes('@'));
        }

        // Email validation
        document.getElementById('emailInput').addEventListener('input', updateProgress);

        // Update online status
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const statusEl = document.getElementById('onlineStatus');
            const statusText = document.getElementById('statusText');
            
            if (isOnline) {
                statusEl.className = 'status-badge status-online';
                statusText.textContent = 'Online';
            } else {
                statusEl.className = 'status-badge status-offline';
                statusText.textContent = 'Offline';
            }
        }

        // Submit report
        async function submitReport() {
            if (!isOnline) {
                showToast('Impossibile inviare: sei offline. Il report verrà salvato.', 'error');
                return;
            }
            
            const email = 'a.manduchi@rfi.it';
            if (!email || !email.includes('@')) {
                showToast('Inserisci un indirizzo email valido', 'error');
                return;
            }
            
            const report = generateReport();
            
            // In a real implementation, you would send this to a backend API
            // For this demo, we'll use mailto: as a fallback
            const subject = encodeURIComponent(`Report Checklist - ${new Date().toLocaleDateString('it-IT')}`);
            const body = encodeURIComponent(report);
            
            // Show success message
            showToast('Report generato! Apertura client email...', 'success');
            
            // Open mailto
            setTimeout(() => {
                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
            }, 1000);
            
            // Clear data after successful submission
            setTimeout(() => {
                if (confirm('Report inviato! Vuoi cancellare i dati locali?')) {
                    localStorage.removeItem('checklistData');
                    location.reload();
                }
            }, 2000);
        }

        // Generate report
        function generateReport() {
            let report = 'REPORT VERIFICA NICCHIE DI SICUREZZA GALLERIA\n';
            report += `Data Ispezione: ${new Date().toLocaleString('it-IT')}\n`;
            
            const directionText = selectedDirection === 'san_benedetto' 
                ? 'San Benedetto Val di Sambro (55+742)' 
                : 'Vernio (37+200)';
            report += `Direzione: Verso ${directionText}\n`;
            
            const totalNiches = checklistData.length;
            const completedNiches = checklistData.filter(i => i.completed).length;
            const needsMaintenance = checklistData.filter(i => {
                return i.checks?.segnaletica === 'manutenzione' || i.checks?.illuminazione === 'manutenzione' || i.checks?.vvf === 'non_conforme';
            }).length;
            
            report += `Nicchie Verificate: ${completedNiches}/${totalNiches}\n`;
            report += `Nicchie Necessitano Manutenzione: ${needsMaintenance}\n`;
            report += `Percentuale Completamento: ${Math.round((completedNiches/totalNiches)*100)}%\n\n`;
            
            report += '='.repeat(60) + '\n\n';
            
            // Summary of maintenance needed
            const nichesNeedingMaintenance = checklistData.filter(i => {
                return i.checks?.segnaletica === 'manutenzione' || i.checks?.illuminazione === 'manutenzione' || i.checks?.vvf === 'non_conforme';
            });
            
            if (nichesNeedingMaintenance.length > 0) {
                report += 'RIEPILOGO NICCHIE CHE NECESSITANO MANUTENZIONE\n\n';
                
                nichesNeedingMaintenance.forEach((item) => {
                    const niche = filteredNiches.find(n => n.id === item.id);
                    report += `Km ${niche.km} - Binario ${niche.binario}\n`;
                    
                    if (item.checks.segnaletica === 'manutenzione') {
                        const photoCount = item.photosByType?.segnaletica?.length || 0;
                        report += `   ⚠️ SEGNALETICA USCITE EMERGENZA - Necessita Manutenzione`;
                        if (photoCount > 0) report += ` (${photoCount} foto)`;
                        report += '\n';
                    }
                    
                    if (item.checks.vvf === 'non_conforme') {
 const photoCount = item.photosByType?.vvf?.length || 0;
 report += ` ⚠️ ANTINCENDIO VV.F. (MANICHETTE + SEGNALETICA) - Assente / non conforme`;
 if (photoCount > 0) report += ` (${photoCount} foto)`;
 report += '\n';
 }
 if (item.checks.illuminazione === 'manutenzione') {
                        const photoCount = item.photosByType?.illuminazione?.length || 0;
                        report += `   ⚠️ ILLUMINAZIONE EMERGENZA - Necessita Manutenzione`;
                        if (photoCount > 0) report += ` (${photoCount} foto)`;
                        report += '\n';
                    }
                    
                    if (item.timestamp) {
                        report += `   Verificato: ${new Date(item.timestamp).toLocaleString('it-IT')}\n`;
                    }
                    report += '\n';
                });
                
                report += '='.repeat(60) + '\n\n';
            }
            
            // Detailed list
            report += 'DETTAGLIO COMPLETO NICCHIE\n\n';
            
            checklistData.forEach((item, index) => {
                const niche = filteredNiches.find(n => n.id === item.id);
                report += `${index + 1}. Km ${niche.km} - Binario ${niche.binario}\n`;
                report += `   Stato: ${item.completed ? '✅ VERIFICATA' : '⏳ DA VERIFICARE'}\n`;
                
                if (item.checks) {
                    if (item.checks.segnaletica) {
                        const status = item.checks.segnaletica === 'funzionante' ? '✅ Funzionante' : '⚠️ Necessita Manutenzione';
                        report += `   Segnaletica Uscite Emergenza: ${status}\n`;
                    }
                    if (item.checks.vvf && (filteredNiches.find(n => n.id === item.id)?.isVvfSpecial)) {
 const status = item.checks.vvf === 'presente' ? '✅ Presente e segnaletica OK' : '⚠️ Assente / non conforme';
 report += ` Antincendio VV.F. (manichette + segnaletica): ${status}\n`;
 }
 if (item.checks.illuminazione) {
                        const status = item.checks.illuminazione === 'funzionante' ? '✅ Funzionante' : '⚠️ Necessita Manutenzione';
                        report += `   Illuminazione Emergenza (12,5m): ${status}\n`;
                    }
                }
                
                if (item.timestamp) {
                    report += `   Data Verifica: ${new Date(item.timestamp).toLocaleString('it-IT')}\n`;
                }
                
                const photos = item.photosByType || {};
                const totalPhotos = (photos.segnaletica?.length || 0) + (photos.illuminazione?.length || 0) + (photos.vvf?.length || 0);
                if (totalPhotos > 0) {
                    report += `   Foto Allegate: ${totalPhotos}\n`;
                    if (photos.segnaletica?.length > 0) report += `     - Segnaletica: ${photos.segnaletica.length}\n`;
                    if (photos.illuminazione?.length > 0) report += `     - Illuminazione: ${photos.illuminazione.length}\n`;
                    if (photos.general?.length > 0) report += `     - Generali: ${photos.general.length}\n`;
                }
                
                report += '\n';
            });
            
            report += '\n='.repeat(60) + '\n';
            report += 'Note Tecniche:\n';
            report += '- Segnaletica: Indica le uscite di emergenza in galleria\n';
            report += '- Illuminazione: Corpi illuminanti sopra corrimano a distanza 12,5m\n';
            report += '\nFine Report\n';
            report += `Generato da NicheSafe - ${new Date().toLocaleString('it-IT')}\n`;
            
            return report;
        }

        // LocalStorage functions
        function saveToLocalStorage() {
            localStorage.setItem('checklistData', JSON.stringify(checklistData));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('checklistData');
            if (saved) {
                const savedData = JSON.parse(saved);
                
                savedData.forEach(savedItem => {
                    const item = checklistData.find(i => i.id === savedItem.id);
                    if (item) {
                        Object.assign(item, savedItem);
                        
                        // Ensure checks object exists
                        if (!item.checks) {
                            item.checks = {
                                segnaletica: null,
                                illuminazione: null
                            };
                        }
                        
                        // Ensure photosByType exists
                        if (!item.photosByType) {
                            item.photosByType = {
                                segnaletica: [],
                                illuminazione: [],
                                general: []
                            };
                        }
                        
                        // Ensure needsPhoto exists
                        if (!item.needsPhoto) {
                            item.needsPhoto = {
                                segnaletica: false,
                                illuminazione: false
                            };
                        }
                        
                        // Update UI radio buttons
                        if (item.checks.segnaletica) {
                            const radio = document.querySelector(`input[name="segnaletica-${item.id}"][value="${item.checks.segnaletica}"]`);
                            if (radio) {
                                radio.checked = true;
                                const label = radio.closest('.radio-label');
                                if (label) label.style.borderColor = 'var(--primary)';
                                
                                // Show photo button if needed
                                if (item.checks.segnaletica === 'manutenzione') {
                                    const photoBtn = document.getElementById(`photo-btn-seg-${item.id}`);
                                    if (photoBtn) photoBtn.style.display = 'block';
                                }
                            }
                        }
                        
                        if (item.checks.vvf && (filteredNiches.find(n => n.id === item.id)?.isVvfSpecial)) {
 const status = item.checks.vvf === 'presente' ? '✅ Presente e segnaletica OK' : '⚠️ Assente / non conforme';
 report += ` Antincendio VV.F. (manichette + segnaletica): ${status}\n`;
 }
 if (item.checks.illuminazione) {
                            const radio = document.querySelector(`input[name="illuminazione-${item.id}"][value="${item.checks.illuminazione}"]`);
                            if (radio) {
                                radio.checked = true;
                                const label = radio.closest('.radio-label');
                                if (label) label.style.borderColor = 'var(--primary)';
                                
                                // Show photo button if needed
                                if (item.checks.vvf === 'non_conforme') {
 const photoCount = item.photosByType?.vvf?.length || 0;
 report += ` ⚠️ ANTINCENDIO VV.F. (MANICHETTE + SEGNALETICA) - Assente / non conforme`;
 if (photoCount > 0) report += ` (${photoCount} foto)`;
 report += '\n';
 }
 if (item.checks.illuminazione === 'manutenzione') {
                                    const photoBtn = document.getElementById(`photo-btn-ill-${item.id}`);
                                    if (photoBtn) photoBtn.style.display = 'block';
                                }
                            }
                        }
                        
                        const itemEl = document.getElementById(`item-${item.id}`);
                        if (item.completed) {
                            itemEl.classList.add('completed');
                        }
                        
                        updateMeta(item.id);
                        displayPhotos(item.id);
                    }
                });
                
                updateProgress();
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.error('Service Worker registration failed:', err));
        }
    </script>
</body>
</html>
